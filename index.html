<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Gamified Health App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        /* 程式碼功能說明: :root 全域變數定義 */
        /* 這裡定義了整個應用程式會用到的顏色、字體、圓角等基礎設計變數，方便統一管理和主題切換。*/
        :root {
            --font-family: 'Inter', sans-serif;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --border-radius-lg: 20px;
            --border-radius-md: 12px;
            /* 稀有度顏色 */
            --rarity-ferrum: #A0A0A0;
            --rarity-fulmen: #139e33;
            --rarity-scintilla: #FFD700;
            --rarity-luna: #6c32a6;
            --rarity-sol: #FF4500;
            --rarity-stella: #00CED1;
            --rarity-caelum: #4169E1;
            --rarity-divum: #F8F8FF;
            /* BOSS 蒐藏品稀有度 */
            --rarity-boss-common: #6c757d;
            --rarity-boss-uncommon: #81d4aa;
            --rarity-boss-rare: #2eb5f0;
            --rarity-boss-epic: #d0d481;
            --rarity-boss-legendary: #F8F8FF;
            --rarity-boss-legendary-alt1: #ffd700;
            --rarity-boss-legendary-alt2: #ff4500;
        }

        /* 程式碼功能說明: 主題系統 (淺色) */
        body[data-theme='light'] {
            --bg-gradient: linear-gradient(135deg, #FCFCF9, #eef2f3);
            --card-bg-color: rgba(255, 255, 253, 0.85);
            --text-color: #2c3e50;
            --text-color-light: #7f8c9c;
            --primary-accent-color: #00b4d8;
            --border-color: rgba(44, 62, 80, 0.15);
        }
        /* 程式碼功能說明: 主題系統 (深色) */
        body[data-theme='dark'] {
            --bg-gradient: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            --card-bg-color: rgba(30, 30, 30, 0.6);
            --text-color: #e0e0e0;
            --text-color-light: #aab7c4;
            --primary-accent-color: #00f2fe;
            --border-color: rgba(255, 255, 255, 0.2);
        }

        
        /* 程式碼功能說明: 其他主題配色 */
        body[data-theme='sunset'] { --bg-gradient: linear-gradient(135deg, #ff9a9e, #fad0c4); --card-bg-color: rgba(255, 255, 255, 0.4); --text-color: #5c3b3b; --text-color-light: #8c6b6b; --primary-accent-color: #ff6a88; --border-color: rgba(255, 255, 255, 0.5); }
        body[data-theme='ocean'] { --bg-gradient: linear-gradient(135deg, #6dd5ed, #2193b0); --card-bg-color: rgba(255, 255, 255, 0.3); --text-color: #f0f8ff; --text-color-light: #bee5f0; --primary-accent-color: #8effa9; --border-color: rgba(255, 255, 255, 0.4); }
        body[data-theme='forest'] { --bg-gradient: linear-gradient(135deg, #56ab2f, #a8e063); --card-bg-color: rgba(255, 255, 255, 0.3); --text-color: #1a3a1a; --text-color-light: #3a5a3a; --primary-accent-color: #fceabb; --border-color: rgba(255, 255, 255, 0.4); }
        body[data-theme='grape'] { --bg-gradient: linear-gradient(135deg, #8e2de2, #4a00e0); --card-bg-color: rgba(255, 255, 255, 0.2); --text-color: #eadaff; --text-color-light: #c8b0e3; --primary-accent-color: #f8ffae; --border-color: rgba(255, 255, 255, 0.3); }
        body[data-theme='sakura'] { --bg-gradient: linear-gradient(135deg, #ffdde1, #ee9ca7); --card-bg-color: rgba(255, 255, 255, 0.4); --text-color: #8c505f; --text-color-light: #b07c8a; --primary-accent-color: #f7797d; --border-color: rgba(255, 255, 255, 0.5); }
        body[data-theme='mint'] { --bg-gradient: linear-gradient(135deg, #98ded9, #64a1a1); --card-bg-color: rgba(255, 255, 255, 0.3); --text-color: #2e5c58; --text-color-light: #588e89; --primary-accent-color: #a7ff83; --border-color: rgba(255, 255, 255, 0.4); }
        body[data-theme='cosmic'] { --bg-gradient: linear-gradient(135deg, #1d2b64, #f8cdda); --card-bg-color: rgba(255, 255, 255, 0.15); --text-color: #f0e6f2; --text-color-light: #d3c4d6; --primary-accent-color: #ffafbd; --border-color: rgba(255, 255, 255, 0.3); }
        body[data-theme='gold'] { --bg-gradient: linear-gradient(135deg, #ffc371, #ff5f6d); --card-bg-color: rgba(0, 0, 0, 0.4); --text-color: #f5f5f5; --text-color-light: #cccccc; --primary-accent-color: #fdd835; --border-color: rgba(253, 216, 53, 0.4); }

        /* 程式碼功能說明: 基礎佈局 */
        /* 設定 body 和 app-container 的基本樣式，實現置中和仿手機框架的效果。 */
        body { font-family: var(--font-family); margin: 0; padding: 0; background: var(--bg-gradient);
             color: var(--text-color); display: flex; justify-content: center; align-items: center;
              min-height: 100vh; overflow: hidden;-webkit-user-select: none; /* Safari/Chrome */
                -moz-user-select: none;    /* Firefox */
                -ms-user-select: none;     /* IE/Edge */
                user-select: none;         /* 標準語法 */
                -webkit-touch-callout: none; /* 禁用 iOS 長按選單 */
                -webkit-tap-highlight-color: transparent; /* 移除 iOS 點擊高光效果 */
            }
        .app-container { width: 100%; max-width: 420px; height: 100vh; max-height: 900px; background-color: rgba(0,0,0,0.1); border-radius: var(--border-radius-lg); box-shadow: 0 8px 32px 0 var(--shadow-color); overflow: hidden; position: relative; display: flex; flex-direction: column; }
        
        /* 程式碼功能說明: 畫面切換 */
        /* .screen 控制各個頁面的顯示與隱藏，透過 active class 來切換，並帶有淡入淡出效果。 */
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; visibility: hidden; transition: opacity 0.5s ease, visibility 0.5s ease; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .screen.active { opacity: 1; visibility: visible; }
        .screen.center-content { justify-content: center; }
        .screen-title { font-size: 24px; font-weight: 700; margin-bottom: 20px; text-align: center; }
        .main-content { width: 100%; display: flex; flex-direction: column; gap: 20px; padding-bottom: 100px; }

        /* 程式碼功能說明: 玻璃擬態卡片 (核心UI元件) */
        /* .glass-card 是所有卡片式UI的基礎，實現了半透明、毛玻璃和圓角等視覺效果。 */
        .glass-card { background: var(--card-bg-color); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-radius: var(--border-radius-lg); border: 1px solid var(--border-color); box-shadow: 0 4px 20px var(--shadow-color); padding: 20px; width: 100%; box-sizing: border-box; box-sizing: border-box; transition: all 0.5s ease; }
        .glass-card h3 { margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .glass-card h3 i { font-size: 20px; }

        /* 程式碼功能說明: 通用元件 (按鈕、輸入框) */
        .primary-button { width: 100%; padding: 15px; border: none; border-radius: var(--border-radius-md); background: var(--primary-accent-color); color: #1a2a22; font-size: 18px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; margin-top: 10px; }
        .primary-button:hover { transform: translateY(-3px); box-shadow: 0 6px 20px color-mix(in srgb, var(--primary-accent-color) 40%, transparent); }
        .primary-button:disabled { background: var(--text-color-light); cursor: not-allowed; }
        .input-field, .select-field { width: 100%; padding: 12px; border-radius: var(--border-radius-md); border: 1px solid var(--border-color); background: rgba(255, 255, 255, 0.1); color: var(--text-color); font-family: var(--font-family); font-size: 16px; box-sizing: border-box; }
        /* [UI優化] 下拉選單樣式 */
        .select-field {
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='rgba(255,255,255,0.5)' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.7rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 3rem;
        }
        select.select-field option {
            background: var(--card-bg-color);
            color: var(--text-color);
        }
        body[data-theme='light'] .select-field {
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='rgba(0,0,0,0.5)' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        }

        .back-button { position: absolute; top: 25px; left: 20px; background: rgba(0,0,0,0.2); border: none; border-radius: 50%; width: 44px; height: 44px; color: var(--text-color); font-size: 24px; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: all 0.2s ease; z-index: 11; }
        .back-button:hover { background: rgba(0,0,0,0.4); transform: scale(1.1); }
        
        /* --- 載入畫面 --- */
        #loading-screen .content { text-align: center; }
        #loading-character { font-size: 60px; animation: breathing 2s ease-in-out infinite; }
        @keyframes breathing { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .progress-bar-container { width: 80%; height: 10px; background-color: rgba(0,0,0,0.2); border-radius: 5px; margin: 20px auto 0; overflow: hidden; }
        #progress-bar { width: 0%; height: 100%; background-color: var(--primary-accent-color); border-radius: 5px; transition: width 0.5s ease-out; }
        #loading-text { margin-top: 15px; font-size: 16px; height: 20px; }

        /* --- 登入畫面 --- */
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        #login-screen .input-field::placeholder { color: var(--text-color-light); }
        .form-group .select-trigger { width: 100%; padding: 12px; border-radius: var(--border-radius-md); border: 1px solid var(--border-color); background: rgba(255, 255, 255, 0.1); color: var(--text-color); font-size: 16px; box-sizing: border-box; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .avatar-selection { display: flex; justify-content: space-around; margin-top: 10px; flex-wrap: wrap; gap: 10px;}
        .avatar-option {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 3px solid transparent;
            background-color: rgba(255,255,255,0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 36px; 
        }
        .avatar-option svg { width: 60%; height: 60%; color: var(--text-color); }
        .avatar-option:hover { transform: scale(1.1); }
        .avatar-option.selected { border-color: var(--primary-accent-color); box-shadow: 0 0 15px var(--primary-accent-color); }

        /* 程式碼功能說明: 隱藏捲動條 (Scrollbar) */
        /* 針對所有指定的可滾動區域，隱藏預設的滾動條 */
        .screen::-webkit-scrollbar,
        #profession-modal-grid::-webkit-scrollbar,
        #equipment-placement-grid::-webkit-scrollbar,
        #edit-diner-list::-webkit-scrollbar,
        #museum-placement-grid::-webkit-scrollbar,
        .chat-window::-webkit-scrollbar {
            display: none; 
        }

        .screen,
        #profession-modal-grid,
        #equipment-placement-grid,
        #edit-diner-list,
        #museum-placement-grid,
        .chat-window {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* --- 主畫面  --- */
        .player-profile-card {
            display: flex; /* ✨ 讓卡片本身變成 flex 容器 */
            align-items: center; /* ✨ 垂直置中對齊 */
            gap: 15px; /* ✨ 設定頭像和文字之間的間距 */
            padding: 15px;
        }

        #player-avatar-main-wrapper {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid var(--primary-accent-color);
            padding: 2px;
            box-sizing: border-box;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #player-avatar-main-wrapper img, 
        #player-avatar-main-wrapper span {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        #player-avatar-main-wrapper span {
            font-size: 36px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .profile-details {
            flex-grow: 1; /* ✨ 讓文字區塊填滿剩餘空間 */
            display: flex;
            flex-direction: column; /* ✨ 讓內部元素垂直排列 */
            gap: 4px; /* ✨ 設定上下間距 */
            min-width: 0; /* ✨ 避免文字過長時撐開版面 */
        }

        .profile-name-title {
            display: flex;
            align-items: baseline;
            gap: 8px;
            flex-wrap: wrap; /* ✨ 允許換行 */
        }

        #player-name-main {
            font-weight: 600;
            font-size: 20px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* 名字太長時顯示... */
        }

        #player-title-main {
            font-size: 12px;
            color: var(--text-color-light);
            background-color: rgba(0,0,0,0.2);
            padding: 2px 6px;
            border-radius: 6px;
            white-space: nowrap;
        }

        .profile-level-xp {
            display: flex;
            align-items: baseline;
            gap: 8px;
        }

        #player-level-main {
            font-size: 14px;
            color: var(--text-color);
        }

        .equipped-title {
            font-size: 14px;
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 5px;
            background: linear-gradient(45deg, var(--rarity-luna), var(--rarity-stella));
            color: white;
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
            animation: title-glow 2s ease-in-out infinite alternate;
        }

        .level-progress-card { /* ✨ 新增的經驗值卡片樣式 */
            padding: 10px 15px;
        }

        .level-info {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-color-light);
            margin-bottom: 8px;
        }

        .progress-bar-bg {
            width: 100%;
            height: 8px;
            background-color: rgba(0,0,0,0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        #level-progress-bar {
            width: 0%;
            height: 100%;
            background-color: var(--primary-accent-color);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        /* [UI重構] 能力值卡片新樣式 */
        .points-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        #reset-stats-btn { background: none; border: 1px solid var(--text-color-light); color: var(--text-color-light); font-size: 12px; padding: 4px 8px; border-radius: var(--border-radius-md); cursor: pointer; }
        #reset-stats-btn:hover { background: var(--border-color); }
        .stat-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; font-size: 16px; }
        .stat-name-value { display: flex; align-items: center; gap: 10px; }
        .stat-name-value i { font-size: 22px; }
        .stat-name-value .stat-value { font-weight: 600; }
        .stat-controls { display: flex; align-items: center; gap: 8px; }
        .stat-btn { width: 28px; height: 28px; border-radius: 50%; border: none; background: var(--primary-accent-color); color: #1a2a22; 
            font-size: 18px; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .stat-btn:disabled { background-color: var(--text-color-light); cursor: not-allowed; }
        .info-btn { background: none; border: none; color: var(--text-color-light); cursor: pointer; font-size: 18px; padding: 0 5px; }

        .health-log-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center; }
        .health-log-item h4 { margin: 0 0 5px; font-size: 20px; color: var(--primary-accent-color); }
        .health-log-item p { margin: 0; font-size: 14px; color: var(--text-color-light); }
        
        .health-input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .health-input-group input { flex-grow: 1; }
        .quick-add-buttons { display: flex; gap: 10px; justify-content: center; }
        .quick-add-btn { padding: 8px 12px; font-size: 12px; background-color: rgba(0,0,0,0.2); 
            color: var(--text-color); border: 1px solid var(--border-color); border-radius: var(--border-radius-md); cursor: pointer; }
        .grid-card { padding: 15px; text-align: center; font-size: 16px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; }
        .grid-card:hover { transform: translateY(-5px); box-shadow: 0 6px 20px var(--shadow-color); }
        .grid-card i { font-size: 32px; display: block; margin-bottom: 10px; color: var(--primary-accent-color); }

        /* --- 裝備展示卡片 (整合進能力值卡片) --- */
        .equipment-slots-container { 
            display: flex; 
            gap: 10px;
            box-sizing: border-box;
        }
        .equipment-slot { 
            flex: 1; 
            min-width: 0; 
            aspect-ratio: 1 / 1; 
            border: 2px dashed var(--border-color); 
            border-radius: var(--border-radius-md); 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            padding: 5px; 
            box-sizing: border-box; 
            text-align: center; 
            transition: background-color 0.3s ease, box-shadow 0.3s ease; 
        }
        .equipment-slot.is-empty:hover {
            cursor: pointer;
            background-color: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 15px -2px var(--primary-accent-color);
        }
        .equipment-slot-icon-wrapper { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; flex-grow: 1; }
        .equipment-slot .item-card { width: 100%; height: 100%; border: none; background: transparent; box-shadow: none; padding: 0; }
        .equipment-slot .item-card .item-icon { font-size: 32px; } 
        /*裝備欄文字*/
        .equipment-slot-name { font-size: 18px;font-weight: 600; color: var(--text-color-light); margin-top: 4px; line-height: 1.2;word-break: break-all;min-height: 1.2em;}  

        /* --- 職業畫面 --- */
        .profession-header { text-align: center; margin-bottom: 15px; }
        .profession-header h4 { margin: 0; font-size: 22px; }
        .profession-header p { margin: 5px 0 0; color: var(--text-color-light); }
        .growth-path-tree { position: relative; padding: 20px 0; }
        .growth-path-tree::before { content: ''; position: absolute; left: 20px; top: 0; bottom: 0; width: 4px; background-color: var(--border-color); border-radius: 2px; }
        .tier-node { position: relative; padding-left: 50px; margin-bottom: 20px; }
        .tier-node::before { content: ''; position: absolute; left: 10px; top: 5px; width: 24px; height: 24px; border-radius: 50%; background-color: var(--border-color); border: 4px solid var(--card-bg-color); transition: all 0.3s ease;}
        .tier-node.unlocked::before { background-color: var(--primary-accent-color); }
        .tier-node-content { padding: 15px; border-radius: var(--border-radius-md); background: rgba(0,0,0,0.1); }
        .tier-node-content h5 { margin: 0 0 10px; font-size: 16px; }
        .tier-node-content p { margin: 0; font-size: 14px; color: var(--text-color-light); }

        .profession-option.is-current {
            border-color: #f39c12;
            opacity: 0.6;
            pointer-events: none; /* 讓當前職業無法被點選 */
        }
                
        /* --- 設定頁面 --- */
        .settings-group { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--border-color); }
        .settings-group.theme-group { flex-direction: column; align-items: flex-start; gap: 15px; }
        .settings-group:last-child { border-bottom: none; }
        .settings-label { display: flex; align-items: center; gap: 15px; }
        .settings-label i { font-size: 22px; color: var(--text-color-light); }
        .theme-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 20px; /* 加大間距，更有呼吸感 */
            padding: 10px 0;
            width: 100%;
            justify-items: center; /* 水平置中 */
        }
        .theme-dot { width: 28px; height: 28px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .theme-dot.active { border-color: var(--primary-accent-color); transform: scale(1.2); }
        .theme-dot[data-theme-color='light'] { background: #FCFCF9; border: 3px solid #eef2f3; }
        .theme-dot[data-theme-color='dark'] { background: #2c5364; }
        .theme-dot[data-theme-color='sunset'] { background: linear-gradient(135deg, #ff9a9e, #fad0c4); }
        .theme-dot[data-theme-color='ocean'] { background: linear-gradient(135deg, #6dd5ed, #2193b0); }
        .theme-dot[data-theme-color='forest'] { background: linear-gradient(135deg, #56ab2f, #a8e063); }
        .theme-dot[data-theme-color='grape'] { background: linear-gradient(135deg, #8e2de2, #4a00e0); }
        .theme-dot[data-theme-color='sakura'] { background: linear-gradient(135deg, #ffdde1, #ee9ca7); }
        .theme-dot[data-theme-color='mint'] { background: linear-gradient(135deg, #98ded9, #64a1a1); }
        .theme-dot[data-theme-color='cosmic'] { background: linear-gradient(135deg, #1d2b64, #f8cdda); }
        .theme-dot[data-theme-color='gold'] { background: linear-gradient(135deg, #ffc371, #ff5f6d); }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-accent-color); }
        input:checked + .slider:before { transform: translateX(22px); }
        
        /* --- 底部導航列 --- */
        .bottom-nav { 
            position: absolute; bottom: 0; left: 0; right: 0; height: 80px; 
            background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); 
            border-top: 1px solid var(--border-color); 
            justify-content: space-around; align-items: center; padding: 0 5px; box-sizing: border-box; z-index: 10;
            /* [UI優化] 預設隱藏，並加入動畫效果 */
            display: none;
            opacity: 0;
            visibility: hidden;
            transform: translateY(100%);
            transition: opacity 0.5s ease, visibility 0.5s ease, transform 0.5s ease;
        }
        .bottom-nav.active {
            display: flex;
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-color); text-decoration: none; font-size: 11px; opacity: 0.7; transition: opacity 0.2s, transform 0.2s; cursor: pointer; flex: 1; text-align: center; }
        .nav-item:hover { opacity: 1; transform: translateY(-3px); }
        .nav-item i { font-size: 26px; margin-bottom: 4px; }
        .nav-item.active { opacity: 1; color: var(--primary-accent-color); }

        /* --- 彈出式視窗 (Modal) --- */
        .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background: var(--card-bg-color); padding: 25px; border-radius: var(--border-radius-lg); border: 1px solid var(--border-color); text-align: center; width: 85%; max-width: 320px; transform: scale(0.9); transition: transform 0.3s ease; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .modal-button { flex: 1; padding: 12px; border-radius: var(--border-radius-md); cursor: pointer; border: none; font-weight: 500;}
        .modal-button.confirm { background-color: var(--primary-accent-color); color: #1a2a22; }
        .modal-button.cancel { background-color: rgba(0,0,0,0.2); color: var(--text-color); }
        /* --- 修改名稱 Moda --- */
        #change-name-modal .modal-content {text-align: left;}
        #change-name-modal .form-group {margin-top: 15px;}
        #change-name-modal .input-field {
            background: rgba(0,0,0,0.2);
        }
        /* 職業選擇 Modal */
        #profession-modal .modal-content { max-height: 80vh; display: flex; flex-direction: column; }
        #profession-modal-grid { flex-grow: 1; overflow-y: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding-top: 15px; }
        .profession-option { padding: 15px; border-radius: var(--border-radius-md); border: 2px solid var(--border-color); cursor: pointer; transition: all 0.2s ease; }
        .profession-option.selected { border-color: var(--primary-accent-color); background-color: color-mix(in srgb, var(--primary-accent-color) 20%, transparent); }
        .profession-option i { font-size: 28px; display: block; margin-bottom: 8px; }

        /* 程式碼功能說明: 道具系統 (Inventory) */
        /* 以下是為道具系統新增的樣式，包括倉庫網格、道具卡片、稀有度特效等。 */
        .inventory-controls { display: flex; gap: 10px; margin-bottom: 10px; width: 100%; }
        .inventory-controls .tab-btn, .inventory-controls .filter-btn { flex-grow: 1; padding: 10px; border: none; background: rgba(0,0,0,0.2); color: var(--text-color); border-radius: var(--border-radius-md); cursor: pointer; transition: all 0.3s ease; font-size: 14px; }
        .inventory-controls .tab-btn.active, .inventory-controls .filter-btn.active { background: var(--primary-accent-color); color: #1a2a22; font-weight: bold; }
        #inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; width: 100%; }
        
        /* 道具卡片基礎樣式 */
        .item-card { 
            position: relative; 
            width: 100%; /* 設定寬高以填滿 wrapper */
            height: 100%; /* 設定寬高以填滿 wrapper */
            border-radius: var(--border-radius-md); 
            background: rgba(0,0,0,0.2); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            cursor: pointer; 
            transition: transform 0.2s ease; 
            overflow: hidden;
            border: 1px solid transparent; /* 預留邊框位置，防止抖動 */
            transform: translateZ(0);
        }
        .item-card:hover { transform: translateY(-5px); }
        .item-card .item-icon { font-size: 36px; z-index: 2; }
        .item-icon img {width: 100%;height: 100%;object-fit: contain; /* 核心魔法！保持圖片比例並完整顯示 */padding: 4px; /* 加一點內邊距，避免圖片貼邊 */box-sizing: border-box; /* [優化] 確保 padding 不會讓圖片超出範圍 */}
        .item-card .item-count { position: absolute; bottom: 2px; right: 5px; font-size: 12px; font-weight: bold; background: rgba(0,0,0,0.5); padding: 1px 4px; border-radius: 4px; z-index: 3; }
        .item-card .favorite-star { position: absolute; top: 5px; left: 5px; font-size: 16px; color: gold; opacity: 0; transition: opacity 0.2s; text-shadow: 0 0 3px black; z-index: 3; }
        .item-card.is-favorite .favorite-star { opacity: 1; }
        .item-card.is-locked { opacity: 0.5; filter: grayscale(80%); }
        .item-card.is-locked .item-icon { opacity: 0.7; }

        /* 1. 蒐藏品特效 (深空極光) */
        .item-type-collectible::after{
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            z-index: 0;
            pointer-events: none;
            opacity: 1;
            overflow: hidden;
            background: 
                linear-gradient(170deg, transparent 30%, color-mix(in srgb, var(--rarity-color) 40%, #8e2de2) 50%, transparent 70%),
                linear-gradient(330deg, transparent 20%, color-mix(in srgb, var(--rarity-color) 40%, #2193b0) 60%, transparent 80%);
            background-size: 200% 200%;
            filter: blur(8px) brightness(1.2);
            animation: aurora-flow 6s ease-in-out infinite alternate;
        }


        /* 2. 裝備特校 呼吸心跳 */
        .item-type-equipment::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            z-index: -1;
            pointer-events: none;
            opacity: 1;
            background: radial-gradient(circle at center, var(--rarity-color) 0%, transparent 70%);
            animation: heart-beat 1.5s ease-in-out infinite;
        }
        @keyframes heart-beat {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(0.6); opacity: 0.8; }
            100% { transform: scale(0.3); opacity: 0; }
        }

        /* 3.消耗品特效(液體氣泡)  */
        .item-type-consumable::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            z-index: 0;
            pointer-events: none;
            opacity: 1;
            background-image:
                radial-gradient(circle at 20% 80%, var(--rarity-color) 5%, transparent 15%),
                radial-gradient(circle at 75% 30%, color-mix(in srgb, var(--rarity-color) 50%, white) 3%, transparent 10%),
                radial-gradient(circle at 50% 120%, var(--rarity-color) 4%, transparent 12%);
            background-repeat: no-repeat;
            animation: bubbles-up 3s linear infinite;
        }
        @keyframes bubbles-up {
            0% { background-position: 0 0, 0 0, 0 0; }
            100% { background-position: 0 -150px, 0 -120px, 0 -180px; }
        }

        /* --- 動畫影格定義  --- */
        @keyframes nebula-swirl {
            0% { transform: rotate(0deg) scale(1.2); background-position: 0% 50%; }
            100% { transform: rotate(360deg) scale(1.3); background-position: 100% 50%; }
        }
        @keyframes aurora-flow {
            from { background-position: 100% 100%; }
            to { background-position: 0% 0%; }
        }

        /* 任務冷卻倒數計時特效 */
        @keyframes timer-glow-effect {
            0%, 100% {
                text-shadow: 0 0 5px #00f2fe, 0 0 10px #00f2fe, 0 0 15px #00f2fe;
            }
            50% {
                text-shadow: 0 0 10px #00b4d8, 0 0 20px #00b4d8, 0 0 30px #00b4d8;
            }
        }
        #task-cooldown-timer {
            animation: timer-glow-effect 2s ease-in-out infinite;
        }

        /* 寶箱待機發光特效 */
        .idle-glow-effect {
            animation: chest-idle-glow 2.5s ease-in-out infinite;
        }
        @keyframes chest-idle-glow {
            0%, 100% {
                transform: scale(1);
                text-shadow: 0 0 15px #ffd700, 0 0 25px #ffc107;
            }
            50% {
                transform: scale(1.03);
                text-shadow: 0 0 25px #fff, 0 0 40px #ffd700;
            }
        }

        /* --- 稀有度顏色變數 --- */
        .rarity-ferrum { --rarity-color: var(--rarity-ferrum); }
        .rarity-fulmen { --rarity-color: var(--rarity-fulmen); }
        .rarity-scintilla { --rarity-color: var(--rarity-scintilla); }
        .rarity-luna { --rarity-color: var(--rarity-luna); }
        .rarity-sol { --rarity-color: var(--rarity-sol); }
        .rarity-stella { --rarity-color: var(--rarity-stella); }
        .rarity-caelum { --rarity-color: var(--rarity-caelum); }
        .rarity-divum { --rarity-color: var(--rarity-divum); }
        .rarity-boss-common { --rarity-color: var(--rarity-boss-common); }
        .rarity-boss-uncommon { --rarity-color: var(--rarity-boss-uncommon); }
        .rarity-boss-rare { --rarity-color: var(--rarity-boss-rare); }
        .rarity-boss-epic { --rarity-color: var(--rarity-boss-epic); }
        .rarity-boss-legendary { --rarity-color: var(--rarity-boss-legendary); }

        @keyframes pulse-glow-soft {
            50% { filter: blur(12px); }
        }

        @property --angle { syntax: '<angle>'; initial-value: 0deg; inherits: false; }
        @keyframes spin { to { --angle: 360deg; } }

        /* 道具詳情 Modal */
        #item-details-modal .modal-content { width: 90%; max-width: 360px; }
        #item-details-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        #item-details-icon-wrapper { width: 80px; height: 80px; flex-shrink: 0; }
        #item-details-icon-wrapper .item-card { width: 100%; height: 100%; }
        #item-details-info { text-align: left; }
        #item-details-name { font-size: 20px; font-weight: bold; margin: 0; }
        #item-details-rarity-type { font-size: 14px; color: var(--text-color-light); }
        #item-details-id { font-size: 12px; color: var(--text-color-light); opacity: 0.7; }
        #item-details-desc, #item-details-stats { text-align: left; margin-bottom: 15px; }
        #item-details-stats p { margin: 5px 0; }
        #item-details-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        #item-details-buttons .modal-button { margin: 0; }
        #equip-comparison { display: none; text-align: left; margin-top: 15px; }
        #equip-comparison h4 { text-align: center; }
        .comparison-grid { display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; align-items: center; }
        .comparison-item { padding: 10px; border-radius: var(--border-radius-md); background: rgba(0,0,0,0.1); }
        .comparison-item p { margin: 2px 0; font-size: 14px; }
        .stat-change-up { color: #4CAF50; }
        .stat-change-down { color: #F44336; }
        
        /* 程式碼功能說明: 開寶箱系統 */
        #chest-screen .main-content { align-items: center; } /* [UI優化] 置中寶箱畫面內容 */
        #chest-screen .glass-card { margin-bottom: 15px; }
        .chest-probability-table { width: 100%; font-size: 14px; }
        .chest-probability-table td { padding: 4px 8px; }
        .chest-probability-table td:last-child { text-align: right; font-weight: bold; }
        #chest-opening-screen { z-index: 999; background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); }
        .chest-container { position: relative; width: 200px; height: 200px; display: flex; justify-content: center; align-items: center; }
        #animated-chest { font-size: 150px; color: #ffd700; text-shadow: 0 0 20px #ffc107; transition: transform 0.3s ease; z-index: 1; }
        #animated-chest.pulse { animation: chest-pulse 1s infinite; }
        #animated-chest.shake { animation: chest-shake-intense 0.4s infinite; }
        #animated-chest.open { transform: scale(1.2) rotate(-10deg); }
        .particles { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; }
        .particle { position: absolute; width: 8px; height: 8px; border-radius: 50%; opacity: 0; }
        .particle.vortex { animation: vortex-in 1.5s ease-in-out forwards; }
        .particle.spark { animation: spark-burst 1s ease-out forwards; }
        #flash-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; z-index: 1001; pointer-events: none; }
        #flash-overlay.active { animation: flash-bang 0.5s forwards; }

        @keyframes chest-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes chest-shake-intense { 0% { transform: translate(3px, 2px) rotate(0deg); } 10% { transform: translate(-3px, -4px) rotate(-2deg); } 20% { transform: translate(-6px, 0px) rotate(2deg); } 30% { transform: translate(6px, 4px) rotate(0deg); } 40% { transform: translate(3px, -3px) rotate(2deg); } 50% { transform: translate(-3px, 4px) rotate(-2deg); } 60% { transform: translate(-6px, 3px) rotate(0deg); } 70% { transform: translate(6px, 3px) rotate(-2deg); } 80% { transform: translate(-3px, -3px) rotate(2deg); } 90% { transform: translate(3px, 4px) rotate(0deg); } 100% { transform: translate(3px, -4px) rotate(-2deg); } }
        @keyframes vortex-in { from { transform: translate(var(--x), var(--y)) scale(1.5); opacity: 1; } to { transform: translate(0, 0) scale(0); opacity: 0; } }
        @keyframes spark-burst { from { transform: translate(0,0) scale(0.5); opacity: 1; } to { transform: translate(var(--x), var(--y)) scale(1); opacity: 0; } }
        @keyframes flash-bang { from { opacity: 1; } to { opacity: 0; } }

        /* 開箱獎勵 Modal */
        #chest-reward-modal .modal-content { padding-top: 20px; padding-bottom: 20px; }
        #chest-reward-modal h3 { margin-bottom: 15px; }
        #chest-reward-items-container { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .chest-reward-item-wrapper { display: flex; flex-direction: column; align-items: center; }
        .chest-reward-item-wrapper .item-card { width: 80px; height: 80px; margin-bottom: 10px; }
        .chest-reward-item-info { font-size: 12px; text-align: center; line-height: 1.4; color: var(--text-color-light); }
        .chest-reward-item-info p { margin: 2px 0; }
        .chest-reward-item-info .reward-name { font-size: 14px; font-weight: bold; }

        /* --- 討伐系統 --- */
        #boss-screen .main-content { align-items: center; }
        #boss-info-card { 
        /* text-align: center; */ /* 我們用更厲害的 Flexbox 來取代它！ */
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center; /* 保留這個屬性，確保文字內容也能置中 */}
        #boss-icon { 
            font-size: 100px; 
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #boss-icon.active { animation: boss-shake 0.82s cubic-bezier(.36,.07,.19,.97) both infinite, boss-glow 2s ease-in-out infinite alternate; }
        @keyframes boss-shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        @keyframes boss-glow { from { text-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #e60073, 0 0 40px #e60073; } to { text-shadow: 0 0 20px #fff, 0 0 30px #ff4da6, 0 0 40px #ff4da6, 0 0 50px #ff4da6; } }
        #boss-hp-bar-container { width: 100%; height: 20px; background-color: rgba(0,0,0,0.3); border-radius: 10px; overflow: hidden; border: 1px solid var(--border-color); }
        #boss-hp-bar { width: 100%; height: 100%; background: linear-gradient(90deg, #e53935, #b71c1c); transition: width 0.5s ease; }
        #boss-hp-text { font-weight: bold; margin-top: 5px; }
        #boss-quote {color: var(--text-color-light); margin-top: 10px; }
        #tactical-analyzer p { margin: 5px 0; font-size: 14px; text-align: left; }
        #tactical-analyzer .formula { color: var(--primary-accent-color); font-weight: bold; }
        #tactical-analyzer .total-damage { font-size: 18px; font-weight: bold; text-align: center; margin-top: 15px; border-top: 1px solid var(--border-color); padding-top: 10px; }
        #boss-loot-warehouse { width: 100%; }
        /* 討伐倉庫樣式 */
        #boss-loot-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 20px; margin-top: 15px; }
        .loot-item-container { display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .loot-item-container .item-card { width: 80px; height: 80px; }
        .loot-item-container .item-icon { font-size: 32px; }
        .loot-item-actions { display: flex; gap: 8px; }
        .loot-action-btn { padding: 4px 8px; font-size: 12px; border-radius: var(--border-radius-md); border: none; cursor: pointer; }
        .loot-action-btn.store { background-color: var(--primary-accent-color); color: #1a2a22; }
        .loot-action-btn.salvage { background-color: #c0392b; color: white; }


        /* --- 博物館系統 --- */
        #museum-display-case-grid {
            display: grid;
        /* 功能解說: 調整為2x2的網格佈局，並增加間距，讓視覺更舒適。 */
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            width: 100%;    
        }
        /* --- 裝備選擇視窗 專屬樣式 --- */
        #equipment-placement-modal .modal-content {
            max-height: 65vh; /* 限制視窗最大高度為螢幕的65% */
            display: flex;
            flex-direction: column;
        }
        /* 功能解說: 為裝備網格啟用垂直捲動條，並設定內邊距，解決內容溢出的問題。 */
        #equipment-placement-grid {
            flex-grow: 1; /* 讓網格填滿剩餘空間 */
            overflow-y: auto; /* 當內容超出時，顯示垂直捲動條 */
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); /* 讓每行盡量多放幾個 */
            gap: 15px;
            padding: 15px; /* 在網格內部增加一些空間，更好看 */
            margin: 15px -15px 0; /* 調整邊距，讓它和上下元素有點距離 */
            background: rgba(0,0,0,0.1);
            border-radius: var(--border-radius-md);
        }
        /* --- [新增] 博物館蒐藏品選擇視窗 專屬樣式 --- */
        #museum-placement-modal .modal-content {
            height: 70vh;
            max-height: 60vh;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        #museum-placement-grid {
            flex-grow: 1;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 20px;
            padding: 15px;
            margin: 15px -15px;
            background: rgba(0,0,0,0.1);
            border-radius: var(--border-radius-md);
        }
        .museum-selection-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .museum-selection-item:hover {
            transform: translateY(-5px);
        }
        .museum-selection-item .item-card-wrapper {
            width: 80px;
            height: 80px;
        }
        .museum-selection-item p {
            font-size: 12px;
            text-align: center;
            margin: 0;
            color: var(--text-color);
        }

         /* 功能解說: 這是全新的展示櫃設計，解決了空間變大的問題，並增加了底座、聚光燈等視覺效果。 */
        .display-case {
            position: relative;
            aspect-ratio: 1 / 1; /* 改為正方形，更穩定 */
            background: linear-gradient(145deg, rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.4));
            border-radius: var(--border-radius-md);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column; /* 改為縱向排列 */
            justify-content: center;
            align-items: center;
            padding: 10px;
            box-sizing: border-box;
            transition: all 0.3s ease;
            overflow: hidden; /* 確保特效不會超出邊界 */
        }

        /* 聚光燈效果 */
        .display-case::before {
            content: '';
            position: absolute;
            top: -50%;
            left: 50%;
            transform: translateX(-50%);
            width: 120%;
            height: 100%;
            background: radial-gradient(ellipse at top, rgba(255, 255, 255, 0.15) 0%, transparent 60%);
            pointer-events: none;
        }

        .display-case.empty {
            cursor: pointer;
            border-style: dashed;
            background: rgba(0,0,0,0.2);
        }
        .display-case.empty:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--primary-accent-color);
        }
        .display-case.empty i {
            font-size: 40px;
            color: var(--text-color-light);
            opacity: 0.7;
        }

        .display-case .item-card-wrapper {
            width: 70%; /* 控制道具卡片大小 */
            height: 70%; /* 控制道具卡片大小 */
            margin-bottom: 5px; /* 與底座的間距 */
        }

        .item-card-wrapper {
            position: relative;
            aspect-ratio: 1 / 1; 
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .item-card-wrapper::before {
            content: '';
            position: absolute;
            top: -15%; left: -15%;
            width: 130%; height: 130%;
            border-radius: var(--border-radius-md);
            transition: all 0.3s ease-in-out;
            z-index: 1;
        }
        .display-case .item-card {
            width: 100%;
            height: 100%;
            z-index: 2; /* 確保卡片在特效之上 */
        }
        .display-case .item-card:hover { transform: scale(1.05); }

        /* 展示櫃底座/銘牌 */
        .display-case .item-name-plaque {
            width: 90%;
            height: 2.8em; /* 固定高度 */
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 4px 8px;
            box-sizing: border-box;
            text-align: center;
            z-index: 3;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .display-case .item-name {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-color);
            line-height: 1.2;
        }
        
        /* --- 限定以下特效只在博物館(.display-case)中生效 --- */
        .display-case .rarity-boss-common::before {
            box-shadow: 0 0 20px 4px var(--rarity-boss-common);
            animation: pulse-glow 3s ease-in-out infinite;
        }
        .display-case .rarity-boss-uncommon::before {
            box-shadow: 0 0 25px 5px var(--rarity-boss-uncommon);
            animation: pulse-glow 2.8s ease-in-out infinite;
        }
        .display-case .rarity-boss-rare::before {
            box-shadow: 0 0 30px 6px var(--rarity-boss-rare);
            animation: pulse-glow 2.6s ease-in-out infinite;
        }
        .display-case .rarity-boss-epic::before {
            background: conic-gradient(from var(--angle), transparent, var(--rarity-boss-epic), transparent);
            box-shadow: 0 0 35px 8px var(--rarity-boss-epic);
            animation: spin 4s linear infinite, pulse-glow 2.2s ease-in-out infinite;
        }
        .display-case .rarity-boss-legendary::before {
            animation: pulse-glow-legendary 2.5s ease-in-out infinite;
        }
        
        @keyframes pulse-glow {
            0% { transform: scale(0.95); filter: blur(10px); opacity: 0.7; }
            50% { transform: scale(1.05); filter: blur(15px); opacity: 1; }
            100% { transform: scale(0.95); filter: blur(10px); opacity: 0.7; }
        }

        @keyframes pulse-glow-legendary {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 25px 8px var(--rarity-boss-legendary-alt2), 0 0 40px 15px var(--rarity-boss-legendary);
                filter: blur(12px);
                opacity: 0.8;
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 35px 12px var(--rarity-boss-legendary), 0 0 50px 20px var(--rarity-boss-legendary-alt1);
                filter: blur(18px);
                opacity: 1;
            }
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 25px 8px var(--rarity-boss-legendary-alt2), 0 0 40px 15px var(--rarity-boss-legendary);
                filter: blur(12px);
                opacity: 0.8;
            }
        }

        /* --- 命運拉霸G系統樣式 --- */
        #diner-gacha-screen .main-content {
            align-items: center;
        }
        .category-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            width: 100%;
        }
        .category-btn {
            padding: 12px 5px;
            font-size: 14px;
            background-color: rgba(0,0,0,0.2);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .category-btn:hover {
            border-color: var(--primary-accent-color);
        }
        .category-btn.active {
            background: var(--primary-accent-color);
            color: #1a2a22;
            font-weight: bold;
        }

        .slot-machine-wrapper {
            width: 100%;
            margin-top: 20px;
            padding: 20px;
            border-radius: var(--border-radius-lg);
            background: rgba(0,0,0,0.2);
        }
        .slot-machine {
            height: 150px; /* 轉盤高度 */
            width: 100%;
            border-radius: var(--border-radius-md);
            overflow: hidden;
            position: relative;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
        }
        .reel-container {
            height: 100%;
            overflow: hidden;
        }
        .reel {
            transition: transform 3s cubic-bezier(0.25, 1, 0.5, 1); /* 動畫效果 */
        }
        .reel-item {
            height: 50px; /* 每個選項的高度 */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: 600;
        }
        .slot-machine-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            border-radius: inherit;
            box-shadow: inset 0 20px 20px -15px #000, inset 0 -20px 20px -15px #000;
        }
        .slot-machine-overlay::after { /* 中間的選擇線 */
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-accent-color);
            transform: translateY(-50%);
            box-shadow: 0 0 10px var(--primary-accent-color);
        }

        /* 編輯菜單 Modal 樣式 */
        #edit-diner-modal .modal-content {
            width: 90%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        .edit-list {
            flex-grow: 1;
            overflow-y: auto;
            margin: 15px 0;
            text-align: left;
        }
        .edit-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        .edit-list-item button {
            background: none;
            border: none;
            color: #c0392b;
            font-size: 20px;
            cursor: pointer;
        }
        .edit-list-add-item {
            display: flex;
            gap: 10px;
        }
        /* --- [新增] 任務系統樣式 --- */
        .header-with-button {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        .task-category-container {
            width: 100%;
            margin-top: 20px;
        }
        .tasks-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 10px;
        }
        .task-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .task-category-header h3 {
            margin: 0; /* 移除 h3 的預設邊距 */
        }
        .task-header-button {
            padding: 6px 12px;
            font-size: 13px;
            background: var(--primary-accent-color);
            color: #1a2a22;
            border: none;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s ease;
            flex-shrink: 0; /* 防止按鈕被壓縮 */
        }
        .task-header-button:hover {
            transform: scale(1.05);
        }
        .task-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: var(--border-radius-md);
            border: 1px solid var(--border-color);
        }
        .task-progress-ring {
            width: 60px;
            height: 60px;
            flex-shrink: 0;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .task-progress-ring svg {
            position: absolute;
            top: 0;
            left: 0;
            transform: rotate(-90deg);
        }
        .progress-ring-circle {
            transition: stroke-dashoffset 0.5s ease;
            stroke-linecap: round;
        }
        .task-icon {
            font-size: 28px;
        }
        .task-info {
            flex-grow: 1;
        }
        .task-desc {
            font-size: 15px;
            font-weight: 500;
        }
        .task-progress-text {
            font-size: 12px;
            color: var(--text-color-light);
            margin-top: 4px;
        }
        .task-rewards {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .reward-preview {
            width: 30px;
            height: 30px;
            background: rgba(0,0,0,0.3);
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 16px;
        }
        .claim-btn {
            padding: 8px 15px;
            font-size: 14px;
            background: var(--primary-accent-color);
            color: #1a2a22;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: bold;
            min-width: 80px;
            text-align: center;
            transition: background-color 0.2s ease;
        }
        .claim-btn:disabled {
            background: var(--border-color);
            cursor: not-allowed;
        }

        /* --- 稱號系統樣式 --- */
        .equipped-title {
            font-size: 14px;
            font-weight: bold;
            margin-left: 8px;
            padding: 3px 8px;
            border-radius: 5px;
            background: linear-gradient(45deg, var(--rarity-luna), var(--rarity-stella));
            color: white;
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
            animation: title-glow 2s ease-in-out infinite alternate;
        }
        @keyframes title-glow {
            from { box-shadow: 0 0 5px var(--rarity-luna); }
            to { box-shadow: 0 0 15px var(--rarity-stella); }
        }
        .title-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        .title-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(0,0,0,0.1);
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
        }
        .title-info .title-name {
            font-weight: bold;
        }
        .title-info .title-bonus {
            font-size: 12px;
            color: var(--text-color-light);
        }
        .title-item.unlocked .title-info .title-name {
            color: var(--rarity-scintilla);
        }
        .title-equip-btn {
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            border: 1px solid var(--primary-accent-color);
            background: transparent;
            color: var(--primary-accent-color);
            border-radius: var(--border-radius-sm);
            min-width: 75px;      
            text-align: center;  
            transition: all 0.2s ease;
        }
        .title-equip-btn.equipped {
            background: var(--primary-accent-color);
            color: #1a2a22;
        }
        .title-equip-btn.locked {
            border-color: var(--border-color);
            color: var(--text-color-light);
            cursor: not-allowed;
        }
        /* --- 動態特效開關控制 --- */
        body.effects-disabled .item-type-equipment::after,
        body.effects-disabled .item-type-consumable::after,
        body.effects-disabled .item-type-collectible::after,
        body.effects-disabled .equipped-title,
        body.effects-disabled #boss-icon.active,
        body.effects-disabled #animated-chest.pulse,
        body.effects-disabled #animated-chest.shake,
        body.effects-disabled .display-case [class*="rarity-boss-"]::before {
            animation: none !important;
            box-shadow: none !important;
            text-shadow: none !important;
            filter: none !important;
            opacity: 1 !important; /* 確保元素可見，僅停止動畫 */
            background: none !important; /* 針對某些背景動畫 */
        }
        /* 針對粒子特效，直接隱藏 */
        body.effects-disabled .particle {
            display: none !important;
        }
        /* 針對需要保留背景但停止動畫的元素 */
        body.effects-disabled .item-type-collectible::after {
            background: none !important;
            opacity: 0 !important;
        }

        /* --- 博物館加成效果 UI 優化 --- */
        #museum-bonus-text {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .bonus-category h4 {
            margin: 0 0 10px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
        }
        .bonus-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 10px 15px;
        }
        .bonus-stat-item {
            font-size: 14px;
            display: flex;
            gap: 8px;
            align-items: baseline;
        }
        .bonus-stat-item .bonus-value {
            font-weight: bold;
            font-size: 16px;
            color: var(--primary-accent-color);
            text-shadow: 0 0 8px color-mix(in srgb, var(--primary-accent-color) 50%, transparent);
        }
        /* --- AI 助手系統樣式 --- */
        #assistant-screen {
            padding-bottom: 160px; /* 將 padding 移到最外層，確保空間足夠 */
        }
        #assistant-screen .main-content {
            display: flex; /* 啟用 flex 佈局 */
            flex-direction: column; /* 垂直排列 */
            height: 100%; /* 讓 .main-content 撐滿整個可用高度 */
            padding-bottom: 0; /* 移除這裡的 padding，因為已移到外層 */
        }
        .chat-window {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
        }
        .chat-message {
            display: flex;
            gap: 10px;
            max-width: 85%;
        }
        .chat-message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        .chat-message.ai {
            align-self: flex-start;
        }
        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--border-color);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            flex-shrink: 0;
        }
        .chat-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        .chat-bubble {
            padding: 12px 18px;
            border-radius: var(--border-radius-lg);
            line-height: 1.6;
        }
        .chat-message.ai .chat-bubble {
            background: rgba(0,0,0,0.2);
            border-bottom-left-radius: 5px;
        }
        .chat-message.user .chat-bubble {
            background: var(--primary-accent-color);
            color: #1a2a22;
            border-bottom-right-radius: 5px;
        }
        .chat-input-area {
            position: absolute;
            bottom: 80px; /* 避開導航列 */
            left: 0;
            right: 0;
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(15px);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
        }
        #chat-input {
            flex-grow: 1;
            background: rgba(255,255,255,0.1);
        }
        #send-chat-btn {
            padding: 12px 15px;
            margin: 0;
            width: auto;
        }
    </style>
</head>
<body data-theme="dark">

    <div class="app-container">

        <body data-theme="dark">

    <div class="app-container">

        <div id="welcome-screen" class="screen center-content">
            <div class="main-content" style="text-align: center;">
                <h1 style="font-size: 48px; margin-bottom: 20px;">Gamified Health</h1>
                <p style="font-size: 18px; color: var(--text-color-light); margin-bottom: 40px;">開始你的健康冒險</p>
                <div class="glass-card">
                    <button id="show-login-btn" class="primary-button">登入</button>
                    <button id="show-register-btn" class="primary-button" style="background: transparent; border: 1px solid var(--primary-accent-color); color: var(--primary-accent-color);">註冊新帳號</button>
                    <button id="guest-login-btn" class="primary-button" style="background: transparent; border: none; color: var(--text-color-light); margin-top: 15px; font-size: 16px;">以訪客身份繼續</button>
                </div>
            </div>
        </div>
        
        <div id="register-screen" class="screen">
            <button class="back-button" data-target-screen="welcome-screen"><i class="ph ph-arrow-left"></i></button>
            <div class="main-content">
                <div class="glass-card">
                    <h2 class="screen-title">註冊新帳號</h2>
                    <div class="form-group">
                        <label for="register-email">Email</label>
                        <input type="email" id="register-email" class="input-field" placeholder="輸入你的Email">
                    </div>
                    <div class="form-group">
                        <label for="register-password">密碼</label>
                        <input type="password" id="register-password" class="input-field" placeholder="設定你的密碼">
                    </div>
                    <button id="register-btn" class="primary-button">註冊</button>
                </div>
            </div>
        </div>

        <div id="login-screen" class="screen">
            <button class="back-button" data-target-screen="welcome-screen"><i class="ph ph-arrow-left"></i></button>
            <div class="main-content">
                <div class="glass-card">
                    <h2 class="screen-title">登入你的帳號</h2>
                    <div class="form-group">
                        <label for="login-email">Email</label>
                        <input type="email" id="login-email" class="input-field" placeholder="輸入你的Email">
                    </div>
                    <div class="form-group">
                        <label for="login-password">密碼</label>
                        <input type="password" id="login-password" class="input-field" placeholder="輸入你的密碼">
                    </div>
                    <button id="login-btn" class="primary-button">登入</button>
                    <p style="text-align: center; margin: 20px 0; color: var(--text-color-light);">或使用社交帳號登入</p>
                    <div style="display: flex; gap: 15px;">
                        <button class="primary-button social-login-btn" data-provider="google" style="background: #DB4437; flex: 1;">Google</button>
                        <button class="primary-button social-login-btn" data-provider="facebook" style="background: #4267B2; flex: 1;">Facebook</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="character-creation-screen" class="screen">
            <div class="main-content">
                <div class="glass-card">
                    <h2 class="screen-title">創建你的冒險者</h2>
                    <div class="form-group">
                        <label for="player-name">玩家名稱</label>
                        <input type="text" id="player-name" class="input-field" placeholder="輸入你的帥氣暱稱">
                    </div>
                    <div class="form-group">
                        <label>選擇職業</label>
                        <div id="profession-select-trigger" class="select-trigger">
                            <span>社畜</span>
                            <i class="ph ph-caret-down"></i>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>選擇基本頭像</label>
                        <div class="avatar-selection">
                            <div class="avatar-option selected" data-avatar-id="male">🧑‍🦱</div>
                            <div class="avatar-option" data-avatar-id="female">👧</div>
                            <div class="avatar-option" data-avatar-id="child">👶</div>
                            <div class="avatar-option" data-avatar-id="elder">👴</div>
                            <div class="avatar-option" data-avatar-id="Shaking Face">🫨</div>
                            <div class="avatar-option" data-avatar-id="Nauseated">🤢</div>
                            <div class="avatar-option" data-avatar-id="Enraged">😡</div>
                            <div class="avatar-option" data-avatar-id="Clown">🤡</div>
                            <div class="avatar-option" data-avatar-id="cat">😼</div>
                            <div class="avatar-option" data-avatar-id="dog">🐶</div>
                            <div class="avatar-option" data-avatar-id="pig">🐷</div>
                            <div class="avatar-option" data-avatar-id="lion">🦁</div>
                            <div class="avatar-option" data-avatar-id="T-Rex">🦖</div>
                            <div class="avatar-option" data-avatar-id="alien">👽</div>
                            <div class="avatar-option" data-avatar-id="ghost">👻</div>
                            <div class="avatar-option" data-avatar-id="poop">💩</div>
                        </div>
                    </div>
                    <button id="create-character-btn" class="primary-button">開始冒險！</button>
                </div>
            </div>
        </div>

<div id="main-app" class="screen"> <div class="main-content">
        <div class="glass-card player-profile-card">
            <div id="player-avatar-main-wrapper">
                </div>
            <div class="profile-details">
                <div class="profile-name-title">
                    <span id="player-name-main"></span>
                    <span id="player-title-main"></span>
                </div>
                <div class="profile-level-xp">
                    <span id="player-level-main">Lv. 1</span>
                    <span id="player-equipped-title" class="equipped-title"></span>
                </div>
            </div>
        </div>
        <div class="glass-card level-progress-card">
            <div class="level-info">
                <span>經驗值</span>
                <span id="player-xp-main">0 / 100 (0.00%)</span>
            </div>
            <div class="progress-bar-bg">
                <div id="level-progress-bar"></div>
            </div>
        </div>
        <div class="glass-card">
            <div class="points-header">
                <h3>📊 能力值</h3>
                <button id="reset-stats-btn">重置♻️</button>
            </div>
            <div id="unassigned-points-display" style="text-align: right; margin-bottom: 10px; font-size: 14px; color: var(--primary-accent-color);">剩餘點數：0</div>
            <div class="stat-item">
                <div class="stat-name-value"> <i class="ph-fill ph-barbell" style="color:#FF6B6B;"></i> <span>力量</span> <span class="stat-value" id="strength-value">0</span> </div>
                <div class="stat-controls"> <button class="stat-btn" data-stat="strength" data-action="plus">+</button> <button class="info-btn" data-stat-info="strength"><i class="ph-fill ph-info"></i></button> </div>
            </div>
            <div class="stat-item">
                <div class="stat-name-value"> <i class="ph-fill ph-shield" style="color:#FFA726;"></i> <span>耐力</span> <span class="stat-value" id="stamina-value">0</span> </div>
                <div class="stat-controls"> <button class="stat-btn" data-stat="stamina" data-action="plus">+</button> <button class="info-btn" data-stat-info="stamina"><i class="ph-fill ph-info"></i></button> </div>
            </div>
            <div class="stat-item">
                <div class="stat-name-value"> <i class="ph-fill ph-wind" style="color:#FFEE58;"></i> <span>敏捷</span> <span class="stat-value" id="agility-value">0</span> </div>
                <div class="stat-controls"> <button class="stat-btn" data-stat="agility" data-action="plus">+</button> <button class="info-btn" data-stat-info="agility"><i class="ph-fill ph-info"></i></button> </div>
            </div>
            <div class="stat-item">
                <div class="stat-name-value"> <i class="ph-fill ph-brain" style="color:#42A5F5;"></i> <span>智力</span> <span class="stat-value" id="intelligence-value">0</span> </div>
                <div class="stat-controls"> <button class="stat-btn" data-stat="intelligence" data-action="plus">+</button> <button class="info-btn" data-stat-info="intelligence"><i class="ph-fill ph-info"></i></button> </div>
            </div>
            <div class="stat-item">
                <div class="stat-name-value"> <i class="ph-fill ph-clover" style="color:#AB47BC;"></i> <span>運氣</span> <span class="stat-value" id="luck-value">0</span> </div>
                <div class="stat-controls"> <button class="stat-btn" data-stat="luck" data-action="plus">+</button> <button class="info-btn" data-stat-info="luck"><i class="ph-fill ph-info"></i></button> </div>
            </div>
            <hr style="border-color: var(--border-color); margin: 20px 0;">
            <div class="equipment-slots-container">
                <div id="equipmentSlot1" class="equipment-slot"></div>
                <div id="equipmentSlot2" class="equipment-slot"></div>
            </div>
        </div>
        <div class="glass-card">
            <h3><i class="ph-fill ph-list-heart"></i> <span id="health-log-date"></span> 健康紀錄</h3>
            <button id="show-damage-data-btn" class="info-btn" style="position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 8px;">累積傷害</button>
            <div class="health-log-grid" style="margin-top: 20px;">
                <div class="health-log-item"> <h4 id="log-steps">0</h4> <p>步數🫁</p> </div>
                <div class="health-log-item"> <h4 id="log-calories">0</h4> <p>大卡🫀</p> </div>
                <div class="health-log-item"> <h4 id="log-sleep">0</h4> <p>小時 (睡眠💤)</p> </div>
                <div class="health-log-item"> <h4 id="log-water">0</h4> <p>ml (飲水💦)</p> </div>
            </div>
        </div>
        <div class="glass-card">
             <h3><i class="ph-fill ph-pencil-simple-line"></i> 記錄健康行為</h3>
            <div class="health-input-group"> <input type="number" id="steps-input" class="input-field" placeholder="輸入步數👣"> <button class="primary-button" data-action="submit-steps" style="margin-top:0; padding: 12px;">記錄</button> </div>
            <div class="health-input-group"> <input type="number" id="calories-input" class="input-field" placeholder="輸入消耗大卡💪🏻"> <button class="primary-button" data-action="submit-calories" style="margin-top:0; padding: 12px;">記錄</button> </div>
            <div class="health-input-group"> <input type="number" id="sleep-input" class="input-field" placeholder="輸入睡眠時數💆🏻"> <button class="primary-button" data-action="submit-sleep" style="margin-top:0; padding: 12px;">記錄</button> </div>
            <div class="quick-add-buttons"> <button class="quick-add-btn" data-action="add-steps" data-value="1000">+1000 步</button> <button class="quick-add-btn" data-action="add-calories" data-value="100">+100 大卡</button> <button class="quick-add-btn" data-action="add-sleep" data-value="1">+1 小時睡眠</button> </div>
            <hr style="border-color: var(--border-color); margin: 20px 0;">
            <button id="sync-health-data-btn" class="primary-button" style="background: linear-gradient(45deg, #2de263, #80cedd); margin-bottom: 10px;"> <i class="ph-fill ph-cell-signal-full"></i> 同步手機/穿戴裝置數據📥 </button>
            <button class="primary-button" data-action="add-water">我喝了 500ml 水🫗</button>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="glass-card grid-card" data-screen="chest-screen"> <i class="ph-fill ph-treasure-chest"></i>開啟寶箱 </div>
            <div class="glass-card grid-card" data-screen="profession-screen"> <i class="ph-fill ph-briefcase"></i>職業 </div>
        </div>
    </div>
</div>   <div id="inventory-screen" class="screen">
        <div class="main-content">
                <h2 class="screen-title">道具倉庫📦</h2>
                <div class="glass-card">
                    <div class="inventory-controls">
                        <button class="tab-btn active" data-tab="inventory">倉庫</button>
                        <button class="tab-btn" data-tab="codex">圖鑑</button>
                        <button id="quick-salvage-btn" class="tab-btn" style="flex-grow: 0.5; background-color: #c0392b;">回收</button>
                        <button id="sort-inventory-btn" class="tab-btn" style="flex-grow: 0.5;"><i class="ph-fill ph-sort-ascending"></i> 整理</button>
                    </div>
                    <div id="inventory-filters" class="inventory-controls">
                        <button class="filter-btn active" data-filter="all">全部</button>
                        <button class="filter-btn" data-filter="裝備">裝備</button>
                        <button class="filter-btn" data-filter="消耗品">消耗品</button>
                        <button class="filter-btn" data-filter="蒐藏品">蒐藏品</button>
                   </div>
                    <div id="inventory-capacity" style="text-align: right; font-size: 14px; margin-bottom: 10px; color: var(--text-color-light);">容量: 0 / 150</div>
                    <div id="inventory-grid">
                        </div>
                </div>
            </div>
        </div>

        <div id="profession-screen" class="screen">
            <div class="main-content">
                <div class="glass-card profession-header">
                    <h4 id="profession-name"></h4>
                    <p id="profession-tier-name"></p>
                </div>
                <div class="glass-card">
                    <h3><i class="ph-fill ph-star"></i> 當前加成</h3>
                    <div id="profession-perks"></div>
                </div>
                <div class="glass-card">
                    <h3><i class="ph-fill ph-tree-structure"></i> 成長路徑樹🌱</h3>
                    <div id="growth-path-tree" class="growth-path-tree"></div>
                </div>
                 <div class="glass-card">
                    <h3><i class="ph-fill ph-graph"></i> 技能樹 (開發中)</h3>
                    <p>更龐大的技能樹系統正在規劃中，敬請期待！</p>
                </div>
            </div>
        </div>
        
        <div id="chest-screen" class="screen">
            <button id="chest-back-btn" class="back-button"><i class="ph ph-arrow-left"></i></button>
            <div class="main-content">
                <h2 class="screen-title">命運寶箱</h2>
                <div class="chest-container" style="margin-bottom: 30px;">
                     <i class="ph-fill ph-treasure-chest idle-glow-effect" style="font-size: 120px; color:#ee5904 ;"></i>
                </div>
                <button id="open-chest-btn" class="primary-button">開啟寶箱🪙</button>
                
                <div class="glass-card">
                    <h3><i class="ph-fill ph-chart-pie-slice"></i> 目前機率</h3>
                    <div id="current-rates-table"></div>
                </div>
                <div class="glass-card">
                    <h3><i class="ph-fill ph-trend-up"></i> 下一階機率</h3>
                    <div id="next-rates-table"></div>
                </div>
            </div>
        </div>

        <div id="settings-screen" class="screen">
            <div class="main-content">
                <h2 class="screen-title">設定⚙️</h2>
                <div class="glass-card">
                    <h3>外觀設定🖌️</h3>
                    <div class="settings-group theme-group">
                        <div class="settings-label"><i class="ph-fill ph-paint-brush"></i><span>主題</span></div>
                        <div class="theme-selector">
                            <div class="theme-dot" data-theme-color="light"></div>
                            <div class="theme-dot" data-theme-color="dark"></div>
                            <div class="theme-dot" data-theme-color="ocean"></div>
                            <div class="theme-dot" data-theme-color="forest"></div>
                            <div class="theme-dot" data-theme-color="sunset"></div>
                            <div class="theme-dot" data-theme-color="grape"></div>
                            <div class="theme-dot" data-theme-color="sakura"></div>
                            <div class="theme-dot" data-theme-color="mint"></div>
                            <div class="theme-dot" data-theme-color="cosmic"></div>
                            <div class="theme-dot" data-theme-color="gold"></div>
                        </div>
                    </div>
                </div>

            <div class="glass-card">
                <h3>助手設定💡</h3>
                 <div class="settings-group">
                    <div class="settings-label"><i class="ph-fill ph-identification-card"></i><span>夥伴名稱</span></div>
                    <span id="change-assistant-name-btn" class="settings-action" style="cursor: pointer;">更改</span>
                </div>
            </div>

            <div class="glass-card">
                <h3>帳號設定🪪</h3>
                <div class="settings-group">
                    <div class="settings-label"><i class="ph-fill ph-user-circle-plus"></i><span>頭像</span></div>
                    <div id="settings-avatar-container" style="display: flex; align-items: center; gap: 10px;">
                        <img id="settings-avatar" src=" " alt=" " style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                        <button id="edit-avatar-btn" class="info-btn"><i class="ph-fill ph-pencil-simple"></i></button>
                        <button id="delete-avatar-btn" class="info-btn" style="color: #FF6B6B;"><i class="ph-fill ph-camera-slash"></i></button>
                    </div>
                    <input type="file" id="avatar-upload" accept="image/*" style="display: none;">
                </div>
                <div class="settings-group">
                    <div class="settings-label"><i class="ph-fill ph-identification-card"></i><span>名稱</span></div>
                    <span id="change-name-btn" class="settings-action" style="cursor: pointer;">更改</span>
                </div>
            <div class="settings-group">
                    <div class="settings-label"><i class="ph-fill ph-arrows-clockwise"></i><span>更改職業</span></div>
                    <span id="change-profession-btn" class="settings-action" style="cursor: pointer;">轉換</span>
                </div>
            </div>

            <div class="glass-card">
                <h3>其他設定⚙️</h3>
                <div class="settings-group">
                    <div class="settings-label"><i class="ph-fill ph-speaker-high"></i><span>音效</span></div>
                    <label class="toggle-switch"><input type="checkbox" id="sound-toggle" checked><span class="slider"></span></label>
                </div>
                 <div class="settings-group">
                    <div class="settings-label"><i class="ph-fill ph-sparkle"></i><span>動態特效</span></div>
                    <label class="toggle-switch"><input type="checkbox" id="effects-toggle" checked><span class="slider"></span></label>
                </div>
                <div class="settings-group">
                    <div class="settings-label"><i class="ph-fill ph-sign-out"></i><span>登出</span></div>
                    <span id="logout-btn" class="settings-action" style="cursor: pointer;">登出帳號</span>
                </div>
            </div>
            </div>
    </div>
        
        <div id="chest-opening-screen" class="screen center-content">
            <div id="flash-overlay"></div>
            <div class="chest-container">
                <div class="particles"></div>
                <i id="animated-chest" class="ph-fill ph-treasure-chest"></i>
            </div>
        </div>
        
        <div id="boss-screen" class="screen">
            <div class="main-content">
                <h2 class="screen-title">Boss 討伐⚔️</h2>
                
                <div id="boss-info-card" class="glass-card">
                    <p id="boss-stage">階段 1</p>
                    <div id="boss-icon"><i class="ph-fill ph-skull" style="font-size: 80px; color: #ff6b6b;"></i></div>
                    <h3 id="boss-name" style="justify-content: center; border: none; margin-bottom: 5px;">深淵的凝視者</h3>
                    <div id="boss-hp-bar-container">
                        <div id="boss-hp-bar"></div>
                    </div>
                    <p id="boss-hp-text">1000 / 1000</p>
                    <p id="boss-quote">"又一個來送死的..."</p>
                    <button id="challenge-boss-btn" class="primary-button">挑戰!</button>
                </div>

                <div id="tactical-analyzer" class="glass-card">
                    <h3> 戰術分析儀🩻</h3>
                    <p id="analyzer-text">分析中...</p>
                </div>

                <div id="boss-loot-warehouse" class="glass-card">
                        <h3> 討伐倉庫⚔️</h3>
                        <div id="boss-loot-grid">
                             <p>這裡空空如也...去擊敗Boss獲得戰利品吧！</p>
                        </div>
                </div>

            </div>
        </div>

        <!-- [新增] 博物館畫面 -->
        <div id="museum-screen" class="screen">
            <button id="museum-back-btn" class="back-button"><i class="ph ph-arrow-left"></i></button>
            <div class="main-content">
                <h2 class="screen-title">博物館🏆</h2>
                <div class="glass-card">
                    <h3><i class="ph-fill ph-star"></i> 總加成效果</h3>
                    <p id="museum-bonus-text">尚未有加成效果。</p>
                </div>
                <div id="museum-display-case-grid">
                    <!-- Boss 戰利品會動態生成於此 -->
                </div>
                <div class="glass-card" style="margin-top: 20px;">
                    <h3><i class="ph-fill ph-star"></i> 榮耀稱號殿堂</h3>
                    <div id="title-system-container">
                        <div id="title-list" class="title-list">
                            </div>
                    </div>
                </div>
            </div> 
        </div>

        <nav class="bottom-nav">
            <a class="nav-item active" data-screen="main-app"><i class="ph-fill ph-house"></i><span>主畫面</span></a>
            <a class="nav-item" data-screen="tasks-screen"><i class="ph-fill ph-list-checks"></i><span>任務</span></a>
            <a class="nav-item" data-screen="inventory-screen"><i class="ph-fill ph-backpack"></i><span>道具</span></a>
            <a class="nav-item" data-screen="boss-screen"><i class="ph-fill ph-skull"></i><span>討伐</span></a>
            <a class="nav-item" data-screen="museum-screen"><i class="ph-fill ph-bank"></i><span>博物館</span></a>
            <a class="nav-item" data-screen="diner-gacha-screen"><i class="ph-fill ph-game-controller"></i><span>拉霸G</span></a>
            <a class="nav-item" data-screen="assistant-screen"><i class="ph-fill ph-robot"></i><span>助手</span></a>
            <a class="nav-item" data-screen="settings-screen"><i class="ph-fill ph-gear"></i><span>設定</span></a>
        </nav>
        <div id="diner-gacha-screen" class="screen">
            <button id="diner-gacha-back-btn" class="back-button"><i class="ph ph-arrow-left"></i></button>
            <div class="main-content">
                <h2 class="screen-title">命運拉霸G🎰</h2>
                <div class="glass-card">
                    <h3><i class="ph-fill ph-fork-and-knife"></i> 選擇餐點類型</h3>
                    <div id="diner-category-selector" class="category-selector">
                        </div>
                </div>
                
                <div id="diner-slot-machine-wrapper" class="slot-machine-wrapper">
                    <div class="slot-machine">
                        <div class="reel-container">
                            <div class="reel" id="diner-reel">
                                </div>
                        </div>
                        <div class="slot-machine-overlay"></div>
                    </div>
                    <button id="diner-spin-btn" class="primary-button" disabled>先選個類別吧！</button>
                    <button id="edit-diner-list-btn" class="info-btn" style="margin-top: 15px;"><i class="ph-fill ph-pencil-simple"></i> 編輯我的菜單</button>
                </div>
            </div>
        </div>

        <div id="assistant-screen" class="screen">
            <div class="main-content">
                <h2 class="screen-title" id="assistant-name-title">貢丸🤖</h2>
                <div id="chat-window" class="chat-window">
                    </div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" class="input-field" placeholder="跟貢丸說點什麼...">
                <button id="send-chat-btn" class="primary-button"><i class="ph-fill ph-paper-plane-tilt"></i></button>
            </div>
        </div>

        <div id="edit-diner-modal" class="modal-overlay">
            <div class="modal-content">
                <h3>編輯 <span id="edit-diner-category-title"></span> 菜單</h3>
                <div id="edit-diner-list" class="edit-list">
                    </div>
                <div class="edit-list-add-item">
                    <input type="text" id="add-diner-item-input" class="input-field" placeholder="新增餐點選項...">
                    <button id="add-diner-item-btn" class="quick-add-btn" style="padding: 12px;">+</button>
                </div>
                <div class="modal-buttons">
                    <button id="edit-diner-close-btn" class="modal-button confirm">完成</button>
                </div>
            </div>
        </div>
        <div id="tasks-screen" class="screen">
            <div class="main-content">
                <div class="header-with-button">
                    <h2 class="screen-title">任務日誌📜</h2>
                    <button id="task-drop-info-btn" class="info-btn"><i class="ph-fill ph-gift"></i> 掉落資訊</button>
                </div>

                <div class="task-category-container">
                    <div class="task-category-header">
                        <h3 data-task-type="daily"><i class="ph-fill ph-sun"></i> 每日任務</h3>
                        <button id="load-health-data-btn" class="task-header-button">載入健康進度</button>
                    </div>
                    <div id="daily-tasks" class="tasks-list"></div>
                </div>

                <div class="task-category-container">
                    <h3 data-task-type="profession"><i class="ph-fill ph-briefcase"></i> 職業每日任務</h3>
                    <div id="profession-tasks" class="tasks-list"></div>
                </div>

                <div id="task-cooldown-container" style="display: none; text-align: center; padding: 40px 20px;">
                        <i class="ph-fill ph-timer" style="font-size: 48px; color: #00bcd4; margin-bottom: 16px;"></i>
                        <h3 style="margin-bottom: 8px;">所有每日挑戰已完成！</h3>
                        <p style="color: #aaa;">距離重置還有...</p>
                        <p id="task-cooldown-timer" style="font-size: 2em; font-weight: bold; color: #fff; margin-top: 4px;"></p>
                    </div>

                <div class="task-category-container">
                    <div class="task-category-header">
                        <h3><i class="ph-fill ph-trophy"></i> 成就任務</h3>
                        <button id="toggle-completed-achievements-btn" class="task-header-button">顯示已完成</button>
                    </div>
                    <div id="achievement-tasks" class="tasks-list"></div>
                </div>
                    <div id="task-cooldown-container" style="display: none; text-align: center; padding: 40px 20px;">
                        <i class="ph-fill ph-timer" style="font-size: 48px; color: #00bcd4; margin-bottom: 16px;"></i>
                        <h3 style="margin-bottom: 8px;">所有每日挑戰已完成！</h3>
                        <p style="color: #aaa;">距離重置還有...</p>
                        <p id="task-cooldown-timer" style="font-size: 2em; font-weight: bold; color: #fff; margin-top: 4px;"></p>
                    </div>
                </div>
            </div>
        </div>

        <div id="task-drop-info-modal" class="modal-overlay">
            <div class="modal-content">
                <h3><i class="ph-fill ph-chart-bar"></i> 任務獎勵稀有度機率</h3>
                <div id="task-drop-rate-content">
                    </div>
                <div class="modal-buttons">
                    <button id="task-drop-info-close-btn" class="modal-button confirm">了解</button>
                </div>
            </div>
        </div>
    </div>

    <div id="profession-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title">選擇你的職業</h3>
            <div id="profession-modal-grid">
                </div>
            <div class="modal-buttons">
                 <button id="profession-modal-confirm-btn" class="modal-button confirm">確認選擇</button>
            </div>
        </div>
    </div>

    <div id="custom-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title-generic">提示</h3>
            <p id="modal-text-generic" style="white-space: pre-wrap;"></p>
            <div class="modal-buttons">
                <button id="modal-cancel-btn" class="modal-button cancel">取消</button>
                <button id="modal-confirm-btn" class="modal-button confirm">確認</button>
            </div>
        </div>
    </div>
    
    <div id="item-details-modal" class="modal-overlay">
        <div class="modal-content">
            <div id="item-details-header">
                <div id="item-details-icon-wrapper"></div>
                <div id="item-details-info">
                    <h3 id="item-details-name" style="border: none; padding: 0; margin: 0;"></h3>
                    <p id="item-details-rarity-type"></p>
                    <p id="item-details-id"></p>
                </div>
            </div>
            <div id="item-details-desc"></div>
            <div id="item-details-stats"></div>
            <div id="equip-comparison">
                 <h4>裝備比較</h4>
                 <div class="comparison-grid">
                        <div id="current-equip-stats" class="comparison-item"></div>
                        <i class="ph ph-arrow-right"></i>
                        <div id="new-equip-stats" class="comparison-item"></div>
                 </div>
            </div>
            <div id="item-details-buttons" class="modal-buttons">
                </div>
        </div>
    </div>
    
    <!--  開箱獎勵 Modal -->
    <div id="chest-reward-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>恭喜你獲得！</h3>
            <div id="chest-reward-items-container">
                <!-- 獎勵道具會動態生成於此 -->
            </div>
        </div>
    </div>
    
    <div id="quick-salvage-modal" class="modal-overlay" style="z-index: 5000;">
        <div class="modal-content">
            <h3>一鍵回收</h3>
            <p>選擇要批量回收的道具類型與稀有度。此操作將回收所有未標記為最愛的道具。</p>
            <div class="form-group">
                <label for="salvage-type-select">道具類型</label>
                <select id="salvage-type-select" class="select-field"></select>
            </div>
            <div class="form-group">
                <label for="salvage-rarity-select">稀有度</label>
                <select id="salvage-rarity-select" class="select-field"></select>
            </div>
            <div class="modal-buttons">
                <button id="quick-salvage-cancel-btn" class="modal-button cancel">取消</button>
                <button id="quick-salvage-confirm-btn" class="modal-button confirm">執行回收</button>
            </div>
        </div>
    </div>

    <div id="equip-choice-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>選擇裝備欄位</h3>
            <p>要將【<span id="equip-choice-item-name"></span>】裝備到哪個欄位？</p>
            <div id="equip-choice-buttons" class="modal-buttons" style="flex-direction: column;">
                </div>
             <div class="modal-buttons">
                 <button id="equip-choice-cancel-btn" class="modal-button cancel">取消</button>
            </div>
        </div>
    </div>

    <div id="boss-loot-info-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="boss-loot-info-title">戰利品掉落率</h3>
            <div id="boss-loot-info-content"></div>
            <div class="modal-buttons">
                <button id="boss-loot-info-close-btn" class="modal-button confirm">了解</button>
            </div>
        </div>
    </div>
    <div id="museum-placement-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>選擇要展示的蒐藏品</h3>
            <div id="museum-placement-grid">
                </div>
            <div class="modal-buttons">
                <button class="modal-button cancel">取消</button>
            </div>
        </div>
    </div>
    <div id="equipment-placement-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>選擇要裝備的道具</h3>
            <div id="equipment-placement-grid" class="museum-placement-grid">
                </div>
            <div class="modal-buttons">
                <button class="modal-button cancel">取消</button>
            </div>
        </div>
    </div>
    <div id="change-name-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>更改你的帥氣暱稱</h3>
            <div class="form-group">
                <label for="new-player-name">新名稱</label>
                <input type="text" id="new-player-name" class="input-field" placeholder="輸入長度不超過10個字">
            </div>
            <div class="modal-buttons">
                <button class="modal-button cancel">取消</button>
                <button class="modal-button confirm">確認更改</button>
            </div>
        </div>
    </div>
        <div id="damage-data-modal" class="modal-overlay">
        <div class="modal-content">
            <h3><i class="ph-fill ph-fire"></i> 本次對Boss的累積傷害</h3>
            <div id="damage-data-grid" class="health-log-grid" style="margin-top: 15px;">
                </div>
            <div class="modal-buttons">
                <button class="modal-button confirm">了解</button>
            </div>
        </div>
    </div>

    <div id="rename-assistant-modal" class="modal-overlay">
            <div class="modal-content">
                <h3>更改你的 AI 夥伴暱稱</h3>
                <div class="form-group">
                    <label for="new-assistant-name">新名稱</label>
                    <input type="text" id="new-assistant-name" class="input-field" placeholder="輸入長度不超過10個字">
                </div>
                <div class="modal-buttons">
                    <button class="modal-button cancel">取消</button>
                    <button class="modal-button confirm">確認更改</button>
                </div>
            </div>
        </div>
        <div id="avatar-choice-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>更換頭像</h3>
            <p>請選擇你要更換頭像的方式：</p>
            <div class="modal-buttons" style="flex-direction: column;">
                <button id="btn-upload-avatar" class="modal-button confirm">從圖庫選擇</button>
                <button id="btn-select-default-avatar" class="modal-button">使用預設頭像</button>
                <button id="btn-cancel-avatar-choice" class="modal-button cancel" style="margin-top: 10px;">取消</button>
            </div>
        </div>
    </div>

    <div id="default-avatar-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>選擇你喜歡的預設頭像</h3>
            <div id="default-avatar-grid" class="avatar-selection" style="max-height: 50vh; overflow-y: auto; padding: 15px;">
                </div>
            <div class="modal-buttons">
                <button class="modal-button cancel">取消</button>
            </div>
        </div>
    </div>

    <script src="./mockAuthServer.js?v=2"></script>

    <script>

        const MANUAL_INPUT_CAPS = {
                steps: 100000,    // 每日手動步數上限
                calories: 5000,  // 每日手動大卡上限
                sleep: 24,       // 每日手動睡眠上限
                water: 10000      // 每日手動飲水上限
            };

        const DEFAULT_AVATARS = ['🧑‍🦱', '👧', '👶', '👴', '🫨', '🤢', '😡', '🤡', '😼', '🐶', '🐷', '🦁', '🦖', '👽', '👻', '💩'];

        // 程式碼功能說明: Gemini AI 核心初始化   
        // 這裡負責引入 Gemini AI SDK，並使用你的 API 金鑰來建立一個可以重複使用的 AI 模型實體。

        // 程式碼功能說明: Gemini AI 核心初始化
        // 這裡負責引入 Gemini AI SDK，並使用你的 API 金鑰來建立一個可以重複使用的 AI 模型實體。
        
        let tempSelectedProfession = null;
        let dinerData = {};
        let taskCooldownInterval = null;
        let currentUserIdentifier = null;

        let rarityConfig, bossRarityConfig, masterItemList, dropRateTiers, 
            bossStages, bossLootDropRates, jobData, taskData, titleData;
            document.addEventListener('DOMContentLoaded', () => {
        
        const body = document.body;
        const appContainer = document.querySelector('.app-container');
        const navItems = document.querySelectorAll('.nav-item');
        const bottomNav = document.querySelector('.bottom-nav');
        const rarityOrder = ['Ferrum', 'Fulmen', 'Scintilla', 'Luna', 'Sol', 'Stella', 'Caelum', 'Divum'];
        const comprehensiveRarityOrder = [
            '凡器', '英魂', '傳頌', '永恆', '神諭', // Boss 稀有度 (從低到高)
            'Ferrum', 'Fulmen', 'Scintilla', 'Luna', 'Sol', 'Stella', 'Caelum', 'Divum' // 普通稀有度
        ];
        const statTranslations = {
            strength: '力量', stamina: '耐力', agility: '敏捷',
            intelligence: '智力', luck: '運氣', all: '全能力',
            steps: '步數',calories: '大卡',sleep: '睡眠',water: '飲水'
        };
        let player = {};
        let settings = {};
        let jobData = {};
        let tempSelectedProfession = '社畜';
        let currentInventoryTab = 'inventory';
        let currentInventoryFilter = 'all';
        let isChestOnCooldown = false;
        let currentDinerCategory = null;
        let showCompletedAchievements = false;
        let professionModalMode = 'new_char';
        const soundManager = {
            sounds: {},


            // 程式碼功能說明: 載入所有遊戲音效
            loadSounds: function() {
                // ✨ 修正 #1 & #2: 全部改用正斜線 /
                this.sounds = {
                    'click':      new Audio('./sounds/click.mp3'),
                    'switch':     new Audio('./sounds/switch.mp3'),
                    'success':    new Audio('./sounds/level.mp3'),
                    'reel_spin':  new Audio('./sounds/spin.mp3'),
                    'chest_open': new Audio('./sounds/open.mp3'),
                    'break':      new Audio('./sounds/break.mp3'),
                    'back':       new Audio('./sounds/back.mp3'),
                    'hit':        new Audio('./sounds/hit.mp3'),
                    'win':        new Audio('./sounds/win.mp3'),
                    'shine':      new Audio('./sounds/shine.mp3'),
                    'level':      new Audio('./sounds/level.mp3'),
                    'success':    new Audio('./sounds/success.mp3'),
                    'equipment':  new Audio('./sounds/equipment.mp3'),
                    'useitem':    new Audio('./sounds/useitem.mp3'),
                    'wrong':      new Audio('./sounds/wrong.mp3'),
                    'drink':      new Audio('./sounds/drink.mp3'),
                    'down':       new Audio('./sounds/down.mp3')
                };

                // 設定音量，避免太大聲
                Object.values(this.sounds).forEach(sound => {
                    sound.volume = 0.9;
                });
                if (this.sounds['chest_open']) {
                this.sounds['chest_open'].volume = 0.2; 
            }
                
        const statTranslations = {
            strength: '力量', stamina: '耐力', agility: '敏捷',
            intelligence: '智力', luck: '運氣', all: '全能力'
        };
            },
            
            // 播放音效的函式，會先檢查設定是否開啟
            play: function(name) {
                if (settings.soundEnabled && this.sounds[name]) {
                    this.sounds[name].currentTime = 0; // 讓音效可以連續觸發
                    this.sounds[name].play().catch(e => console.error("音效播放錯誤:", e));
                }
            }
        };


        // 程式碼功能說明: 掉落率等級區間設定
        const dropRateTiers = [
            { levelRange: [1, 10],   label: "Lv.1-10",   rates: { Ferrum: 60, Fulmen: 30, Scintilla: 8,  Luna: 2,   Sol: 0,    Stella: 0,    Caelum: 0,   Divum: 0 } },
            { levelRange: [11, 20],  label: "Lv.11-20",  rates: { Ferrum: 50, Fulmen: 35, Scintilla: 10, Luna: 4,   Sol: 1,    Stella: 0,    Caelum: 0,   Divum: 0 } },
            { levelRange: [21, 30],  label: "Lv.21-30",  rates: { Ferrum: 40, Fulmen: 35, Scintilla: 15, Luna: 8,   Sol: 2,    Stella: 0,    Caelum: 0,   Divum: 0 } },
            { levelRange: [31, 40],  label: "Lv.31-40",  rates: { Ferrum: 30, Fulmen: 30, Scintilla: 20, Luna: 15,  Sol: 5,    Stella: 0,    Caelum: 0,   Divum: 0 } },
            { levelRange: [41, 50],  label: "Lv.41-50",  rates: { Ferrum: 25, Fulmen: 25, Scintilla: 20, Luna: 20,  Sol: 10,   Stella: 0,    Caelum: 0,   Divum: 0 } },
            { levelRange: [51, 60],  label: "Lv.51-60",  rates: { Ferrum: 20, Fulmen: 20, Scintilla: 20, Luna: 20,  Sol: 15,   Stella: 5,    Caelum: 0,   Divum: 0 } },
            { levelRange: [61, 70],  label: "Lv.61-70",  rates: { Ferrum: 15, Fulmen: 15, Scintilla: 20, Luna: 20,  Sol: 20,   Stella: 8,    Caelum: 2,   Divum: 0 } },
            { levelRange: [71, 80],  label: "Lv.71-80",  rates: { Ferrum: 10, Fulmen: 10, Scintilla: 15, Luna: 20,  Sol: 25,   Stella: 15,   Caelum: 4,   Divum: 1 } },
            { levelRange: [81, 90],  label: "Lv.81-90",  rates: { Ferrum: 8,  Fulmen: 8,  Scintilla: 10, Luna: 15,  Sol: 25,   Stella: 20,   Caelum: 10,  Divum: 4 } },
            { levelRange: [91, 100], label: "Lv.91-100", rates: { Ferrum: 5,  Fulmen: 5,  Scintilla: 8,  Luna: 10,  Sol: 20,   Stella: 30,   Caelum: 15,  Divum: 7 } }
            
        ];

        // 程式碼功能說明: 應用程式初始化 
        // 這是整個 App 的起點，現在它會先檢查使用者的登入狀態，再決定要顯示哪個畫面。
        async function init() {
            try { // 載入所有遊戲資料模組
                const [ itemsDataModule, rarityModule, gameplayModule, tasksModule, bossModule ] = await Promise.all([
                    import('./items-data.js?v=2'),
                    import('./items-rarity.js?v=2'),
                    import('./gameplay-data.js?v=2'),
                    import('./tasks-data.js?v=2'),
                    import('./boss-data.js?v=2'),
                ]);
                
                // 將模組資料指派到全域變數
                masterItemList = itemsDataModule.masterItemList;
                rarityConfig = rarityModule.rarityConfig;
                bossRarityConfig = rarityModule.bossRarityConfig;
                jobData = gameplayModule.jobData;
                bossStages = bossModule.bossStages;
                bossLootDropRates = bossModule.bossLootDropRates;
                taskData = tasksModule.taskData;
                titleData = tasksModule.titleData;

                console.log("✅ 兵器庫、戰略室、任務大廳 資料全部載入成功！");

            } catch (error) {
                console.error("❌ 載入外部遊戲數據庫失敗！", error);
                document.getElementById('loading-text').textContent = '錯誤：無法載入核心遊戲資料！';
                return;
            }
            
            soundManager.loadSounds();
            loadSettings(); // 載入通用設定
            setupEventListeners(); // 先設定好所有按鈕的監聽事件

            // --- 核心改造：檢查 session ---
            const token = localStorage.getItem('currentUserToken');
            if (token) {
                const session = await mockAuthServer.verifyToken(token);
                if (session && session.email) {
                    // Token有效，直接登入
                    onLoginSuccess(token, session.email);
                } else {
                    // Token無效或過期，顯示歡迎頁
                    localStorage.removeItem('currentUserToken'); // 清除無效token
                    showScreen('welcome-screen');
                }
            } else {
                // 沒有Token，顯示歡迎頁
                showScreen('welcome-screen');
            }
        }

        function handleGuestLogin() {
            // 為訪客建立一個獨一無二的臨時ID
            currentUserIdentifier = `guest_${Date.now()}`;
            player = {}; // 建立一個空的玩家物件
            showScreen('character-creation-screen'); // 直接跳到創建角色畫面
            bottomNav.classList.remove('active');
        }


        function onLoginSuccess(token, userIdentifier) {
            localStorage.setItem('currentUserToken', token);
            currentUserIdentifier = userIdentifier;
            loadPlayerData(userIdentifier);

            if (player && player.loggedIn) {
                // --- 情況一：這是老玩家 ---
                // 玩家資料已存在，直接進入主畫面
                generateTasks();
                updateAllUI();
                showScreen('main-app');
                setActiveNav('main-app');
                bottomNav.classList.add('active');
            } else {
                // --- 情況二：這是新玩家 ---
                // 玩家資料不存在，引導他去創建角色！
                // 注意：這裡我們只切換畫面，不做其他事
                showScreen('character-creation-screen');
                // 導航列此時不應該出現
                bottomNav.classList.remove('active');
            }
        }

        
        // 程式碼功能說明: 玩家資料處理
        // 負責從 localStorage 讀取、儲存玩家資料，並使用向下相容模式為舊存檔補充新結構。
        function loadPlayerData(userIdentifier) {
            const savedPlayer = localStorage.getItem(`playerData_${userIdentifier}`);
            
            if (savedPlayer) {
                // 步驟 1: 先解析存檔
                player = JSON.parse(savedPlayer);

                // 步驟 2: 進行一系列「向下相容」檢查，如果沒有就補上
                // 這種寫法最安全，可以確保不論存檔多舊，都不會出錯
                if (!player.equipment) player.equipment = { slot1: null, slot2: null };
                if (!player.assignedStats) player.assignedStats = { strength: 0, stamina: 0, agility: 0, intelligence: 0, luck: 0 };
                if (!player.nameChangeHistory) player.nameChangeHistory = [];
                if (!player.bossSystem) player.bossSystem = { currentStageIndex: 0, currentBossHp: bossStages[0].hp, lastBossDefeatTime: null };
                if (!player.lootWarehouse) player.lootWarehouse = [];
                if (!player.museumSlots) player.museumSlots = { slot1: null, slot2: null, slot3: null, slot4: null, slot5: null };
                if (!player.activeBuffs) player.activeBuffs = [];
                if (!player.tasks) player.tasks = { daily: [], profession: [], achievements: [], lastGenerated: null };
                if (!player.unlockedTitles) player.unlockedTitles = []; // ✨ 你的 Bug 修復點就在這裡！
                if (!player.equippedTitle) player.equippedTitle = null;
                if (!player.taskHistory) player.taskHistory = {};
                if (!player.stats) player.stats = { chestsOpened: 0 };
                if (!player.bossHistory) player.bossHistory = {};
                if (!player.lastProfessionChangeTime) player.lastProfessionChangeTime = null;
                if (!player.manualInputTracker) player.manualInputTracker = { steps: 0, calories: 0, sleep: 0, water: 0 };
                if (!player.assistant) player.assistant = { name: '鋼鐵貢丸🤖', nameChangeHistory: [], chatHistory: [{ sender: 'ai', text: '你好！我是你的專屬健康夥伴，準備好一起變強了嗎？' }] };


                // 步驟 3: 處理舊資料結構的「遷移」
                // 檢查 todayData 是否為舊結構 (沒有 manual 這個 key)
                if (player.todayData && player.todayData.manual === undefined) {
                    console.log("偵測到舊版 todayData，正在進行遷移...");
                    const oldData = { ...player.todayData };
                    player.todayData = {
                        manual: oldData,
                        device: { steps: 0, calories: 0, sleep: 0, water: 0 },
                        total: oldData
                    };
                }
                // 檢查 bossDamageData 是否為舊結構
                if (player.bossDamageData && player.bossDamageData.manual === undefined) {
                    console.log("偵測到舊版 bossDamageData，正在進行遷移...");
                    const oldBossData = { ...player.bossDamageData };
                    player.bossDamageData = {
                        manual: oldBossData,
                        device: { steps: 0, calories: 0, sleep: 0, water: 0 },
                        total: oldBossData
                    };
                }

            } else {
                // 步驟 4: 如果完全沒有存檔，就設定為空物件，交給後續流程處理
                player = {};
            }

            // 步驟 5: 安全地設定全域變數
            dinerData = player.dinerData || getDefaultDinerData();
        }
                function savePlayerData() {
            if (currentUserIdentifier) {
                localStorage.setItem(`playerData_${currentUserIdentifier}`, JSON.stringify(player));
            }
        }

        // 程式碼功能說明: 設定資料處理
        function loadSettings() {
            const savedSettings = localStorage.getItem('appSettingsV2');
            settings = savedSettings ? JSON.parse(savedSettings) : { theme: 'dark', effectsEnabled: true, soundEnabled: true };
            
            if (settings.effectsEnabled === undefined) {
                settings.effectsEnabled = true; // 為舊存檔的玩家補上特效預設值
            }
            if (settings.soundEnabled === undefined) {
                settings.soundEnabled = true;  // 為舊存檔的玩家補上音效預設值
            }
            
            applySettings(); // 將此函式移到外面，確保每次載入都會應用設定
        }
        function saveSettings() { localStorage.setItem('appSettingsV2', JSON.stringify(settings)); }
        
        function applySettings() {
            body.setAttribute('data-theme', settings.theme || 'dark');
            document.querySelectorAll('.theme-dot').forEach(dot => {
                dot.classList.toggle('active', dot.dataset.themeColor === settings.theme);
            });
            document.body.classList.toggle('effects-disabled', !settings.effectsEnabled);
            // 讓音效開關的打勾狀態符合設定
            const soundToggle = document.getElementById('sound-toggle');
            if(soundToggle) soundToggle.checked = settings.soundEnabled;
        }

        function updateHealthCardHeader() {
            const dateEl = document.getElementById('health-log-date');
            if (dateEl) {
                const today = new Date();
                dateEl.textContent = ` ${today.getMonth() + 1} 月 ${today.getDate()} 日`;
            }
        }

        // 程式碼功能說明: 健康數據同步核心
        // 這個函式是我們留給原生App呼叫的窗口。原生App會把從 HealthKit/Connect 讀到的數據傳給它。
        function syncWithNativeHealthData(nativeData) {
            // 更新玩家資料中的原生數據部分
            player.todayData.device = { ...player.todayData.device, ...nativeData };
            player.bossDamageData.device = { ...player.bossDamageData.device, ...nativeData };
            
            // 重新計算總和
            calculateTotalHealthData();
            
            // 更新UI並保存
            updateAllUI();
            updateTaskProgress(); 
            savePlayerData();
            soundManager.play('success');
            showModal("裝置數據同步成功！\n健康紀錄與任務進度已更新。", null, true);
        }

        // 程式碼功能說明: 計算總健康數據
        // 將手動輸入和裝置數據相加，得到最終顯示的總數據。
        function calculateTotalHealthData() {
            for (const key in player.todayData.total) {
                player.todayData.total[key] = (player.todayData.manual[key] || 0) + (player.todayData.device[key] || 0);
                player.bossDamageData.total[key] = (player.bossDamageData.manual[key] || 0) + (player.bossDamageData.device[key] || 0);
            }
        }
        
        // 程式碼功能說明: 重新生成職業任務
        // 當玩家轉職時，這個函式會被呼叫，來清空舊的職業任務，並換上新職業的任務。
        function regenerateProfessionTasks() {
            player.tasks.profession = []; // 清空現有職業任務
            const newProfessionTasks = taskData.profession[player.professionId] || [];
            if (newProfessionTasks.length > 0) {
                const firstTask = { ...newProfessionTasks[0], progress: 0, claimed: false };
                player.tasks.profession.push(firstTask);
            }
        }

        // 程式碼功能說明: 處理轉職請求的核心函式
        // 包含冷卻時間檢查、打開職業選擇視窗等。
        function handleChangeProfessionRequest() {
            const ONE_WEEK_MS = 7 * 24 * 60 * 60 * 1000;
            const now = Date.now();
            
            if (player.lastProfessionChangeTime && (now - player.lastProfessionChangeTime < ONE_WEEK_MS)) {
                const nextAvailableDate = new Date(player.lastProfessionChangeTime + ONE_WEEK_MS);
                const formattedDate = nextAvailableDate.toLocaleDateString('zh-TW');
                soundManager.play('wrong');
                showModal(`轉職系統冷卻中！\n每週只能轉換一次職業。\n\n下次可轉職時間：\n${formattedDate} 之後`, null, true);
                return;
            }
                professionModalMode = 'change_char';
                openProfessionModal();

            // 打開職業選擇視窗，並傳入一個「確認後要做的事」
            openProfessionModal((selectedProfession) => {
                if (selectedProfession === player.professionId) {
                    soundManager.play('wrong');
                    showModal("你選擇了與目前相同的職業，無需轉換。", null, true);
                    return;
                }
                
                showModal(`確定要從【${player.professionId}】轉換為【${selectedProfession}】嗎？\n\n(等級將會保留)`, () => {
                    player.professionId = selectedProfession;
                    player.lastProfessionChangeTime = now;
                    regenerateProfessionTasks(); // 呼叫函式來更新職業任務
                    savePlayerData();
                    updateAllUI();
                    soundManager.play('success');
                    showModal(`轉職成功！你現在是【${selectedProfession}】了！`, null, true);
                });
            });
        }

        // ✨ 新增的 HealthSync 物件，專門負責與手機健康數據溝通 ✨
            // ✨ 全新、更穩健的 HealthSync 物件 ✨
// ✨ 全新、結構更穩健的 HealthSync 物件 ✨
// ✨ 全新、採用「引導式」策略的 HealthSync 物件 ✨
const HealthSync = {
    isNative: function() {
        return Capacitor.isNativePlatform();
    },

    // 這個函式現在只負責檢查權限，不再主動請求
    checkAuthStatus: async function() {
        if (!this.isNative()) return 'unsupported';
        try {
            const { Health } = Capacitor.Plugins;
            const result = await Health.checkPermissions();
            // 檢查我們需要的核心權限是否都被同意了
            const allGranted = ['steps', 'calories'].every(p => result[p] === 'granted');
            return allGranted ? 'granted' : 'denied';
        } catch (error) {
            console.error('[error] 檢查健康數據權限時失敗', error);
            return 'error';
        }
    },

    // 查詢數據的函式保持不變
    queryTodayData: async function() {
        // ... (這部分的程式碼與上次相同，無需修改) ...
        if (!this.isNative()) return null;
        try {
            const { Health } = Capacitor.Plugins;
            const today = new Date();
            const startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const stepsResult = await Health.query({ startDate: startDate, endDate: today, dataType: 'steps' });
            const caloriesResult = await Health.query({ startDate: startDate, endDate: today, dataType: 'calories' });
            const sleepResult = await Health.query({ startDate: startDate, endDate: today, dataType: 'sleep' });
            const totalSteps = stepsResult.reduce((sum, record) => sum + Number(record.value), 0);
            const totalCalories = caloriesResult.reduce((sum, record) => sum + Number(record.value), 0);
            const totalSleep = sleepResult.reduce((sum, record) => sum + Number(record.value), 0);
            return {
                steps: Math.round(totalSteps),
                calories: Math.round(totalCalories),
                sleep: parseFloat((totalSleep / 3600).toFixed(2))
            };
        } catch (error) {
            console.error('[error] 查詢健康數據時發生錯誤', error);
            return null;
        }
    },

    // ✨ 全新的主函式，包含引導邏輯 ✨
    sync: async function() {
        if (!this.isNative()) {
            showModal('此功能僅限在手機 App 中使用喔！', null, true);
            return;
        }

        const authStatus = await this.checkAuthStatus();

        if (authStatus === 'granted') {
            // --- 權限已開啟，執行正常同步流程 ---
            showModal('正在同步健康數據...', null, false);
            const healthData = await this.queryTodayData();
            hideModal('custom-modal');

            if (healthData) {
                player.todayData.device.steps = healthData.steps;
                player.todayData.device.calories = healthData.calories;
                player.todayData.device.sleep = healthData.sleep;
                
                calculateTotalHealthData();
                updateHealthLogUI();
                updateTaskProgress();
                savePlayerData();

                document.getElementById('steps-input').placeholder = `已同步 ${healthData.steps} 步`;
                document.getElementById('calories-input').placeholder = `已同步 ${healthData.calories} 大卡`;
                document.getElementById('sleep-input').placeholder = `已同步 ${healthData.sleep} 小時`;

                soundManager.play('success');
                showModal('同步成功！你的數據已更新！', null, true);
            } else {
                showModal('同步失敗，未抓取到任何數據。', null, true);
            }
        } else {
            // --- 權限未開啟或被拒絕，彈出引導視窗 ---
            showModal(
                "為了自動更新您的任務進度，我們需要您手動開啟健康數據權限。\n\n" + 
                "**設定路徑：**\n" +
                "iPhone「設定」App > 「隱私權與安全性」 > 「健康」 > 找到「PlayFit」並開啟所有權限。\n\n" +
                "*(開啟後請再試一次)*",
                null,
                true,
                { title: "權限設定引導" }
            );
        }
    }
};

        
        // 程式碼功能說明: UI 更新聚合函式
        // 一個方便的函式，用來一次更新所有畫面上的玩家相關資訊。
        function updateAllUI() {
            if (!player.loggedIn) return;
            calculateTotalStats();
            updateProfessionInfo();
            updateMainProfileUI();
            updateStatsUI();
            updateHealthLogUI();
            updateHealthCardHeader();
            updateEquipmentUI();
            updateSettingsUI(); 
            
            if(document.getElementById('boss-screen').classList.contains('active')) {
                updateBossScreenUI();
            }
            if(document.getElementById('museum-screen').classList.contains('active')) {
                renderMuseum();
                renderTitleSystemUI();
            }
        }

        function updateMainProfileUI() {
            const xpToNextLevel = player.level * 100;
            const progressPercent = Math.min((player.xp / xpToNextLevel) * 100, 100);
            document.getElementById('player-name-main').textContent = player.name;
            
            if(jobData && player.professionId && jobData[player.professionId]) {
                 document.getElementById('player-title-main').textContent = getCurrentTier().title;
            }
            
            const avatarWrapper = document.getElementById('player-avatar-main-wrapper');
            avatarWrapper.innerHTML = ''; 

            avatarWrapper.style.display = 'flex';
            avatarWrapper.style.justifyContent = 'center';
            avatarWrapper.style.alignItems = 'center';

            if (player.avatar.startsWith('data:image/') || player.isCustomAvatar) {
                const img = document.createElement('img');
                img.id = 'player-avatar-main';
                img.src = player.avatar;
                img.style.cssText = "width: 100%; height: 100%; border-radius: 50%; object-fit: cover;";
                avatarWrapper.appendChild(img);
            } else {
                const emojiSpan = document.createElement('span');
                emojiSpan.id = 'player-avatar-main';
                emojiSpan.textContent = player.avatar;
                emojiSpan.style.fontSize = '36px';
                avatarWrapper.appendChild(emojiSpan);
            }

            document.getElementById('player-level-main').textContent = `Lv. ${player.level}`;
            document.getElementById('player-xp-main').textContent = `${player.xp} / ${xpToNextLevel} (${progressPercent.toFixed(2)}%)`;
            document.getElementById('level-progress-bar').style.width = `${progressPercent}%`;
            
            const equippedTitleEl = document.getElementById('player-equipped-title');
            if (player.equippedTitle && titleData[player.equippedTitle]) {
                equippedTitleEl.textContent = `【${titleData[player.equippedTitle].name}】`;
                equippedTitleEl.style.display = 'inline-block';
            } else {
                equippedTitleEl.style.display = 'none';
            }
        }

        function updateStatsUI() {
            document.getElementById('unassigned-points-display').textContent = `剩餘點數：${player.unassignedPoints}`;
            for (const stat in player.totalStats) {
                const totalValue = parseFloat(player.totalStats[stat]);
                const baseStat = player.baseStats[stat] + player.assignedStats[stat];
                let equipmentBonus = 0;
                for (const slot in player.equipment) {
                    const item = player.equipment[slot];
                    if (item && item.stats && item.stats[stat]) {
                        equipmentBonus += item.stats[stat];
                    }
                }
                
                const baseWithEquip = baseStat + equipmentBonus;
                    // 直接計算乘法帶來的總加成，避免除零錯誤
                const totalBonus = totalValue - baseWithEquip;

                // 功能解說: 使用 Math.floor() 將最終顯示的能力值改為整數。
                let displayText = Math.floor(totalValue);
                if (equipmentBonus > 0) {
                    // 將裝備加成也改為整數顯示
                    displayText += ` <span style="color: #8effa9;">(+${Math.floor(equipmentBonus)})</span>`;
                }
                // 將來自Buff、博物館等的百分比總加成改為整數顯示
                if (Math.abs(totalBonus) > 1e-5) { 
                    displayText += ` <span style="color: #f8ffae;">(+${Math.floor(totalBonus)})</span>`;
                }

                const valueEl = document.getElementById(`${stat}-value`);
                if (valueEl) valueEl.innerHTML = displayText;

                const plusBtn = document.querySelector(`.stat-btn[data-stat='${stat}'][data-action='plus']`);
                if(plusBtn) plusBtn.disabled = player.unassignedPoints <= 0;
            }
        }

        function updateHealthLogUI() {
            document.getElementById('log-steps').textContent = player.todayData.total.steps;
            document.getElementById('log-calories').textContent = player.todayData.total.calories;
            document.getElementById('log-sleep').textContent = player.todayData.total.sleep;
            document.getElementById('log-water').textContent = player.todayData.total.water;
        }

        function updateProfessionUI() {
            const professionScreen = document.getElementById('profession-screen');
            if (!professionScreen.classList.contains('active') || !jobData[player.professionId]) return;

            const currentTier = getCurrentTier();
            document.getElementById('profession-name').textContent = `${jobData[player.professionId].icon} ${player.professionId}`;
            document.getElementById('profession-tier-name').textContent = currentTier.title;
            
            // [核心修正] 將技能說明移至成長路徑樹中，讓主畫面更簡潔
            const perksContainer = document.getElementById('profession-perks');
            const baseTier = jobData[player.professionId].tiers[0];
            perksContainer.innerHTML = `<p><strong>被動技能:</strong> ${baseTier.passive || '無'}</p><p><strong>任務加成:</strong> ${baseTier.bonus || '無'}</p>`;

            renderProfessionTree(); // 呼叫獨立的渲染函式
        }

        
        //  成長路徑樹現在只會顯示玩家當前選擇的職業
        function renderProfessionTree() {
            const treeContainer = document.getElementById('growth-path-tree');
            treeContainer.innerHTML = '';

            // [UI優化] 因為只顯示單一職業，移除 grid 佈局
            treeContainer.style.display = 'block';

            const professionId = player.professionId;
            const prof = jobData[professionId];

            // 如果找不到對應的職業資料，就直接返回，避免錯誤
            if (!prof) {
                treeContainer.innerHTML = '<p>找不到職業資料。</p>';
                return;
            }

            //  移除 for 迴圈，直接為當前職業建立分支
            const branch = document.createElement('div');
            // 因為只有一個，所以預設就是當前的，直接加上 current class
            branch.className = 'tree-branch current';

            const pathHTML = prof.tiers.map((tier, index) => {
                const isActive = player.level >= tier.level;
                const isCurrentTier = getCurrentTier().level === tier.level;
                return `
                    <div class="tier-node ${isActive ? 'unlocked' : ''} ${isCurrentTier ? 'current-tier' : ''}">
                        <div class="tier-level">Lv. ${tier.level}</div>
                        <div class="tier-title">${tier.title}</div>
                        <div class="tier-desc">${tier.desc}</div>
                    </div>
                `;
            }).join('');

            branch.innerHTML = `
                <h4 class="branch-title">${prof.icon} ${professionId}</h4> 
                <div class="branch-path-container">${pathHTML}</div>
            `;
                        treeContainer.appendChild(branch);
        }
        
        function setupEventListeners() {
        
            // --- 新增的登入/註冊按鈕事件 ---
            document.getElementById('show-login-btn').addEventListener('click', () => showScreen('login-screen'));
            document.getElementById('show-register-btn').addEventListener('click', () => showScreen('register-screen'));
            document.getElementById('guest-login-btn').addEventListener('click', handleGuestLogin)
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('register-btn').addEventListener('click', handleRegister);
            
            document.querySelectorAll('.social-login-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handleSocialLogin(e.target.dataset.provider));
            });

            document.querySelectorAll('.back-button').forEach(btn => {
                 btn.addEventListener('click', (e) => showScreen(e.currentTarget.dataset.targetScreen));
            });

            // Boss 累積傷害資訊按鈕
            document.getElementById('show-damage-data-btn').addEventListener('click', () => {
                const grid = document.getElementById('damage-data-grid');
                grid.innerHTML = `
                    <div class="health-log-item"><h4>${player.bossDamageData.total.steps}</h4><p>步數</p></div>
                    <div class="health-log-item"><h4>${player.bossDamageData.total.calories}</h4><p>大卡</p></div>
                    <div class="health-log-item"><h4>${player.bossDamageData.total.sleep}</h4><p>小時 (睡眠)</p></div>
                    <div class="health-log-item"><h4>${player.bossDamageData.total.water}</h4><p>ml (飲水)</p></div>
                `;
                const modal = document.getElementById('damage-data-modal');
                modal.querySelector('.confirm').onclick = () => hideModal('damage-data-modal');
                modal.classList.add('active');
            });
            //  為「一鍵回收」的類型選擇器新增 change 事件 
            document.getElementById('salvage-type-select').addEventListener('change', updateSalvageRarityOptions);
            document.getElementById('quick-salvage-cancel-btn').addEventListener('click', () => hideModal('quick-salvage-modal'));

            //  為「更改職業」按鈕加上點擊事件 
            document.getElementById('change-profession-btn').addEventListener('click', handleChangeProfessionRequest);

            document.getElementById('profession-modal-confirm-btn').addEventListener('click', () => {
                if (!tempSelectedProfession) return;

                // 根據狀態來決定要做什麼事
                if (professionModalMode === 'new_char') {
                    // 如果是新創角色，就只更新文字
                    const triggerSpan = document.querySelector('#profession-select-trigger span');
                    if(triggerSpan) triggerSpan.textContent = tempSelectedProfession;
                } else if (professionModalMode === 'change_char') {
                    // 如果是轉職，就執行轉職邏輯
                    if (tempSelectedProfession === player.professionId) {
                        soundManager.play('wrong');
                        showModal("你選擇了與目前相同的職業，無需轉換。", null, true);
                    } else {
                        showModal(`確定要從【${player.professionId}】轉換為【${tempSelectedProfession}】嗎？\n\n(等級將會保留)`, () => {
                            player.professionId = tempSelectedProfession;
                            player.lastProfessionChangeTime = Date.now(); // ✨ 在這裡才更新時間
                            regenerateProfessionTasks();
                            savePlayerData();
                            updateAllUI();
                            soundManager.play('success');
                            showModal(`轉職成功！你現在是【${tempSelectedProfession}】了！`, null, true);
                        });
                    }
                }
                hideModal('profession-modal');
            });


            // 切換顯示已完成成就按鈕
            document.getElementById('toggle-completed-achievements-btn').addEventListener('click', (e) => {
                soundManager.play('click');
                // 切換開關的狀態 (true 變成 false, false 變成 true)
                showCompletedAchievements = !showCompletedAchievements; 
                // 更新按鈕上的文字
                e.target.textContent = showCompletedAchievements ? '隱藏已完成' : '顯示已完成';
                // 重新渲染任務列表，讓變動生效！
                renderTasksUI();
            });

            // 任務掉落資訊按鈕
            document.getElementById('task-drop-info-btn').addEventListener('click', () => {
                soundManager.play('click'); 
                
                const dropRateContainer = document.getElementById('task-drop-rate-content');
                
                const currentLevelTier = getLevelTier(player.level);
                const nextLevelTier = getLevelTier(player.level + 10);
                let contentHTML = `<h4>當前掉落率 (Lv.${player.level})</h4>${generateRatesTable(currentLevelTier.rates)}`;
                if (nextLevelTier.label !== currentLevelTier.label) {
                    contentHTML += `<h4 style="margin-top: 15px;">下一階級 (${nextLevelTier.label})</h4>${generateRatesTable(nextLevelTier.rates)}`;
                }
                dropRateContainer.innerHTML = contentHTML;
                document.getElementById('task-drop-info-modal').classList.add('active');
            });

            //  為「同步按鈕」加上點擊事件！ 
            document.getElementById('sync-health-data-btn').addEventListener('click', () => {
                HealthSync.sync();
                
                // --- ✨ 未來原生 App 數據接入點 ✨ ---                   
               /*為了讓使用者知道按鈕有在運作，我們先顯示一個提示訊息。*/
               soundManager.play('wrong');
               showModal("正在等待與您的手機健康App連線...\n(此功能待原生App開發完成後啟用)", null, true);
            });

            // 裝備欄點擊事件 (空/滿)
            document.querySelector('.equipment-slots-container').addEventListener('click', (event) => {
                const clickedSlot = event.target.closest('.equipment-slot');
                if (!clickedSlot) return;
                const slotId = clickedSlot.id.replace('equipment', '').toLowerCase();
                if (clickedSlot.classList.contains('is-empty')) {
                    openEquipmentPlacementModal(slotId);
                } else if (clickedSlot.classList.contains('is-filled')) {
                    const item = player.equipment[slotId];
                    if (item) showItemDetails(item, false, true, slotId);
                }
            });

            // 底部導航列
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    soundManager.play('switch');
                    const screenId = item.dataset.screen;
                    if (screenId === 'inventory-screen') {
                        currentInventoryTab = 'inventory';
                        currentInventoryFilter = 'all';
                        document.querySelector('#inventory-screen .tab-btn.active')?.classList.remove('active');
                        document.querySelector('#inventory-screen .tab-btn[data-tab="inventory"]')?.classList.add('active');
                        document.querySelector('#inventory-filters .filter-btn.active')?.classList.remove('active');
                        document.querySelector('#inventory-filters .filter-btn[data-filter="all"]')?.classList.add('active');
                    }
                    showScreen(screenId);
                    setActiveNav(screenId);
                    if (screenId === 'diner-gacha-screen') renderDinerUI();
                    if (screenId === 'tasks-screen') { generateTasks(); renderTasksUI(); }
                });
            });

            // --- 其他所有事件監聽器... (以下省略，保持不變) ---
            const soundToggle = document.getElementById('sound-toggle');
            if (soundToggle) {
                soundToggle.addEventListener('change', (e) => {
                    settings.soundEnabled = e.target.checked;
                    saveSettings();
                });
            }
            const effectsToggle = document.getElementById('effects-toggle');
            if (effectsToggle) {
                effectsToggle.checked = settings.effectsEnabled;
                effectsToggle.addEventListener('change', (e) => {
                    settings.effectsEnabled = e.target.checked;
                    document.body.classList.toggle('effects-disabled', !settings.effectsEnabled);
                    saveSettings();
                });
            }
            document.querySelectorAll('.theme-dot').forEach(dot => {
                dot.addEventListener('click', () => {
                    settings.theme = dot.dataset.themeColor;
                    saveSettings();
                    applySettings();
                });
            });
            document.querySelectorAll('.primary-button:not([data-action="add-water"]):not(#diner-spin-btn):not(#open-chest-btn), .quick-add-btn, .stat-btn, .info-btn, .loot-action-btn').forEach(btn => {
                btn.addEventListener('click', () => soundManager.play('click'));
            });
            document.querySelectorAll('.grid-card[data-screen]').forEach(card => {
                card.addEventListener('click', (e) => {
                    const screenId = e.currentTarget.dataset.screen;
                    if (screenId) {
                        showScreen(screenId);
                        setActiveNav(null);
                    }
                });
            });
            document.getElementById('open-chest-btn').addEventListener('click', handleOpenChest);
            document.getElementById('chest-back-btn').addEventListener('click', () => { showScreen('main-app'); setActiveNav('main-app'); });
            document.getElementById('museum-back-btn').addEventListener('click', () => { showScreen('main-app'); setActiveNav('main-app'); });
            document.getElementById('diner-gacha-back-btn').addEventListener('click', () => { showScreen('main-app'); setActiveNav('main-app'); });
            document.getElementById('create-character-btn').addEventListener('click', createCharacter);
            document.getElementById('profession-select-trigger').addEventListener('click', () => {
                professionModalMode = 'new_char';
                openProfessionModal();           
            });
            document.querySelectorAll('.avatar-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    document.querySelector('.avatar-option.selected')?.classList.remove('selected');
                    e.currentTarget.classList.add('selected');
                });
            });
            document.querySelectorAll('.stat-btn').forEach(btn => {
                let pressTimer, intervalId;
                const startAdding = () => {
                    if (player.unassignedPoints > 0) {
                        const stat = btn.dataset.stat;
                        player.assignedStats[stat]++;
                        player.unassignedPoints--;
                        updateAllUI();
                        savePlayerData();
                    } else { stopAdding(); }
                };
                const stopAdding = () => { clearTimeout(pressTimer); clearInterval(intervalId); };
                btn.addEventListener('mousedown', () => { startAdding(); pressTimer = setTimeout(() => { intervalId = setInterval(startAdding, 100); }, 500); });
                btn.addEventListener('mouseup', stopAdding);
                btn.addEventListener('mouseleave', stopAdding);
                btn.addEventListener('touchstart', (e) => { e.preventDefault(); startAdding(); pressTimer = setTimeout(() => { intervalId = setInterval(startAdding, 100); }, 500); });
                btn.addEventListener('touchend', stopAdding);
            });
            document.getElementById('reset-stats-btn').addEventListener('click', () => {
                let pointsToReclaim = 0;
                for (const stat in player.assignedStats) { pointsToReclaim += player.assignedStats[stat]; player.assignedStats[stat] = 0; }
                player.unassignedPoints += pointsToReclaim;
                updateAllUI();
                savePlayerData();
                soundManager.play('back');
                showModal("能力點數已重置！", null, true);
            });
            document.querySelectorAll('.info-btn[data-stat-info]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const stat = btn.dataset.statInfo;
                    const info = { strength: '力量 💪\n\n提升消耗大卡對BOSS造成的傷害...', stamina: '耐力 🛡️\n\n提升走路步數對BOSS造成的傷害...', agility: '敏捷 ⚡\n\n提升睡眠對BOSS造成的傷害...', intelligence: '智力 🧠\n\n提升喝水對BOSS造成的傷害...', luck: '運氣 ✨\n\n提升獲得稀有道具的機率...\n還有增加獲得額外道具的機率...\n但是增加多少呢...嘿嘿' };
                    if(info[stat]) showModal(info[stat], null, true);
                });
            });
            document.querySelector('button[data-action="submit-steps"]').addEventListener('click', () => { const input = document.getElementById('steps-input'); if(input.value > 0) { recordHealthData('steps', parseInt(input.value)); input.value = ''; } });
            document.querySelector('button[data-action="submit-calories"]').addEventListener('click', () => { const input = document.getElementById('calories-input'); if(input.value > 0) { recordHealthData('calories', parseInt(input.value)); input.value = ''; } });
            document.querySelector('button[data-action="submit-sleep"]').addEventListener('click', () => { const input = document.getElementById('sleep-input'); if(input.value > 0) { recordHealthData('sleep', parseFloat(input.value)); input.value = ''; } });
            document.querySelectorAll('.quick-add-btn').forEach(btn => btn.addEventListener('click', () => recordHealthData(btn.dataset.action.split('-')[1], parseFloat(btn.dataset.value))));
            document.querySelector('button[data-action="add-water"]').addEventListener('click', () => {
                        soundManager.play('drink'); // ✨ 播放專屬的喝水音效！
                        recordHealthData('water', 500);
                    });
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('edit-avatar-btn').addEventListener('click', openAvatarChoiceModal);
            document.getElementById('avatar-upload').addEventListener('change', handleAvatarUpload);
            document.getElementById('delete-avatar-btn').addEventListener('click', deleteAvatar);
            document.getElementById('change-name-btn').addEventListener('click', handleChangeNameRequest);
            document.getElementById('send-chat-btn').addEventListener('click', handleSendMessage);
            document.getElementById('chat-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSendMessage(); });
            document.getElementById('change-assistant-name-btn').addEventListener('click', handleRenameAssistantRequest);
            document.querySelectorAll('#inventory-screen .inventory-controls .tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    if(e.currentTarget.id === 'quick-salvage-btn' || e.currentTarget.id === 'sort-inventory-btn') return;
                    document.querySelector('#inventory-screen .inventory-controls .tab-btn.active').classList.remove('active');
                    btn.classList.add('active');
                    currentInventoryTab = btn.dataset.tab;
                    renderInventory();
                });
            });
            document.querySelectorAll('#inventory-filters .filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelector('#inventory-filters .filter-btn.active').classList.remove('active');
                    btn.classList.add('active');
                    currentInventoryFilter = btn.dataset.filter;
                    renderInventory();
                });
            });
            document.getElementById('quick-salvage-btn').addEventListener('click', openQuickSalvageModal);
            document.getElementById('quick-salvage-cancel-btn').addEventListener('click', () => hideModal('quick-salvage-modal'));
            document.getElementById('quick-salvage-confirm-btn').addEventListener('click', executeQuickSalvage);
            document.getElementById('sort-inventory-btn').addEventListener('click', sortInventoryByRarity);
            document.getElementById('task-drop-info-close-btn').addEventListener('click', () => hideModal('task-drop-info-modal'));
            document.getElementById('boss-loot-info-close-btn').addEventListener('click', () => hideModal('boss-loot-info-modal'));
            document.getElementById('diner-spin-btn').addEventListener('click', spinDiner);
            document.getElementById('edit-diner-list-btn').addEventListener('click', openEditDinerModal);
            document.getElementById('add-diner-item-btn').addEventListener('click', addNewDinerItem);
            document.getElementById('edit-diner-close-btn').addEventListener('click', () => {
                hideModal('edit-diner-modal');
                if (currentDinerCategory) populateReel(dinerData[currentDinerCategory]);
            });
            document.getElementById('load-health-data-btn').addEventListener('click', () => {
                HealthSync.sync();
            });
        }
        
        function handleChangeNameRequest() {
            const TWO_WEEKS_MS = 14 * 24 * 60 * 60 * 1000;
            const now = Date.now();
            
            const recentChanges = (player.nameChangeHistory || []).filter(timestamp => (now - timestamp) < TWO_WEEKS_MS);

            if (recentChanges.length >= 2) {
                const oldestRecentChange = Math.min(...recentChanges);
                const nextAvailableDate = new Date(oldestRecentChange + TWO_WEEKS_MS);
                const formattedDate = nextAvailableDate.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });
                soundManager.play('wrong');
                showModal(`你最近改名太頻繁囉！\n兩週內只能改兩次。\n\n下次可修改時間：\n${formattedDate} 之後`, null, true);
                return;
            }
            const modal = document.getElementById('change-name-modal');
            const input = document.getElementById('new-player-name');
            input.value = player.name; // 將目前名稱填入輸入框

            modal.querySelector('.confirm').onclick = () => {
                const newName = input.value.trim();
                if (!newName) { 
                    soundManager.play('wrong');
                    showModal("新名稱不能為空！", null, true, { title: "錯誤" });
                    return
                }
                if (newName.length > 10) {
                    soundManager.play('wrong');
                    showModal("名稱太長了，請勿超過10個字！", null, true, { title: "錯誤" });
                    return 
                }
                if (newName === player.name) {
                    hideModal('change-name-modal');
                    return;
                }
                
                player.name = newName;
                player.nameChangeHistory.push(now);
                while (player.nameChangeHistory.length > 10) {
                    player.nameChangeHistory.shift();
                }

                hideModal('change-name-modal');
                savePlayerData();
                updateAllUI();
                soundManager.play('success');
                setTimeout(() =>showModal(`名稱修改成功！\n你的新名字是：${player.name}`, null, true), 100);
            };

            modal.querySelector('.cancel').onclick = () => hideModal('change-name-modal');

            modal.classList.add('active');
        }
        
            // 程式碼功能說明: 創建新角色 (最終封印版)
function createCharacter() {
    const name = document.getElementById('player-name').value.trim();
    if (!name) { 
        soundManager.play('wrong');
        showModal("年輕人...，報上名來！", null, true);
        return; 
    }
    
    const selectedAvatarElement = document.querySelector('.avatar-option.selected');
    const avatarValue = selectedAvatarElement ? selectedAvatarElement.textContent : '🧑‍🦱';
    
    player = {
        loggedIn: true,
        name: name,
        level: 1,
        xp: 0,
        unassignedPoints: 5,
        baseStats: { strength: 1, stamina: 1, agility: 1, intelligence: 1, luck: 1 },
        assignedStats: { strength: 0, stamina: 0, agility: 0, intelligence: 0, luck: 0 },
        totalStats: { strength: 1, stamina: 1, agility: 1, intelligence: 1, luck: 1 },
        professionId: tempSelectedProfession,
        lastWaterTime: 0,
        avatar: avatarValue,
        isCustomAvatar: false,
        inventory: [],
        stats: { chestsOpened: 0 },
        equipment: { slot1: null, slot2: null },
        codex: [],
        itemCounter: 0,
        nameChangeHistory: [],
        bossSystem: { currentStageIndex: 0, currentBossHp: bossStages[0].hp, lastBossDefeatTime: null },
        bossHistory: {},
        lootWarehouse: [],
        museumSlots: { slot1: null, slot2: null, slot3: null, slot4: null, slot5: null },
        activeBuffs: [],
        dinerData: getDefaultDinerData(),
        tasks: { daily: [], profession: [], achievements: [], lastGenerated: null },
        
        // ❗❗❗ 這就是聖劍的核心！請務必讓它存在於你的程式碼中！ ❗❗❗
        unlockedTitles: [], 
        
        equippedTitle: null,
        taskHistory: {},
        lastProfessionChangeTime: null,
        todayData: {
            manual: { steps: 0, calories: 0, sleep: 0, water: 0 },
            device: { steps: 0, calories: 0, sleep: 0, water: 0 },
            total: { steps: 0, calories: 0, sleep: 0, water: 0 }
        },
        bossDamageData: {
            manual: { steps: 0, calories: 0, sleep: 0, water: 0 },
            device: { steps: 0, calories: 0, sleep: 0, water: 0 },
            total: { steps: 0, calories: 0, sleep: 0, water: 0 }
        },
        assistant: {
            name: '鋼鐵貢丸🤖', nameChangeHistory: [],
            chatHistory: [ { sender: 'ai', text: '你好！我是你的專屬健康夥伴，準備好一起變強了嗎？' } ]
        },
        historicalData: { weekly: [] },
        manualInputTracker: { steps: 0, calories: 0, sleep: 0, water: 0 },
    };
    
    addItemToInventory(generateRandomItem(null, ['裝備', '消耗品']));
    addItemToInventory(generateRandomItem(null, ['裝備', '消耗品']));
    generateTasks();
    savePlayerData();
    showScreen('main-app');
    setActiveNav('main-app');
    bottomNav.classList.add('active');
    updateAllUI();
}


        // 程式碼功能說明: 處理 Email/密碼登入
        async function handleLogin() {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                if (!email || !password) return showModal("請輸入Email和密碼！", null, true);

                try {
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message);
                    // 登入成功後，呼叫我們本來就有的 onLoginSuccess 函式
                    onLoginSuccess(data.token, data.email);
                } catch (error) {
                    showModal(`登入失敗：${error.message}`, null, true);
                }
            }
        
        // 程式碼功能說明: 處理註冊 
        async function handleRegister() {
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                if (!email || !password) return showModal("請輸入Email和密碼！", null, true);
                if (password.length < 6) return showModal("密碼長度至少需要6位！", null, true);

                try {
                    const response = await fetch('/api/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message);
                    showModal(data.message, () => showScreen('login-screen'));
                } catch (error) {
                    soundManager.play('wrong'); 
                    showModal(`註冊失敗：${error.message}`, null, true);
                }
            }
        
        // 程式碼功能說明: 處理社交登入 
        async function handleSocialLogin(provider) {
             try {
                const session = await mockAuthServer.socialLogin(provider);
                onLoginSuccess(session.token, session.email);
            } catch (error) {
                soundManager.play('wrong'); 
                showModal(`登入失敗：${error}`, null, true);
            }
        }

            
        function addXp(amount) {
            player.xp += amount;
            let levelsGained = 0;
            let xpToNextLevel = player.level * 100;
            while(player.xp >= xpToNextLevel) {
                player.level++;
                player.xp -= xpToNextLevel;
                levelsGained++;
                xpToNextLevel = player.level * 100;
            }
            if (levelsGained > 0) {
                soundManager.play('level'); 
                player.unassignedPoints += levelsGained * 5;
                showModal(`🎉 等級提升！你升到了 ${player.level} 級！\n獲得 ${levelsGained * 5} 點能力點數！`, null, true);
            }
            savePlayerData();
            updateAllUI();
            updateTaskProgress();
        }

        // 程式碼功能說明: 健康數據轉換核心邏輯
        // 規則: 健康數據永遠會被記錄。但只有在上限額度內的數據，才會給予遊戲內的獎勵 (經驗、能力、傷害)。
        function recordHealthData(type, value) {
            const cap = MANUAL_INPUT_CAPS[type];
            const currentManualAmount = player.manualInputTracker[type] || 0;
            
            // --- 步驟 1: 無條件更新「健康日誌」的數據 ---
            // 這一部分現在會永遠執行，確保玩家的健康紀錄是完整的。
            player.todayData.manual[type] += value;
            calculateTotalHealthData(); // 重新計算總和 (手動 + 裝置)

            // --- 步驟 2: 計算本次輸入「可獲得獎勵」的額度 ---
            let valueToProcess = 0; // 預設本次可獲得獎勵的額度為 0
            let feedback = ''; // 準備給玩家的回饋訊息

            if (currentManualAmount >= cap) {
                // 情況 A: 在輸入前，就已經達到或超過上限了
                soundManager.play('sucess'); 
                feedback = `記錄成功😁！\n\n但你今天手動輸入的「${statTranslations[type] || type}」已達上限，本次紀錄不會提供額外獎勵喔😂🤣🥺🥹😭！`;
                valueToProcess = 0;
            } else {
                // 情況 B: 本次輸入會超過上限
                if (currentManualAmount + value > cap) {
                    valueToProcess = cap - currentManualAmount; // 計算剩餘的可獎勵額度
                    soundManager.play('wrong'); 
                    feedback = `記錄成功，但已達每日上限！\n本次輸入僅有 ${valueToProcess.toFixed(0)} 的額度被計入獎勵計算。\n\n`;
                } else {
                // 情況 C: 本次輸入還在上限內
                    soundManager.play('level'); 
                    valueToProcess = value; // 全部輸入都計入獎勵
                    feedback = `記錄成功！\n\n`;
                }
            }
            
            // --- 步驟 3: 根據「可獲得獎勵的額度」來計算收益 ---
            if (valueToProcess > 0) {
                // 更新「獎勵追蹤器」和「Boss傷害」
                player.manualInputTracker[type] += valueToProcess;
                player.bossDamageData.manual[type] += valueToProcess;

                let xpGained = 0;
                const statGains = { strength: 0, stamina: 0, agility: 0, intelligence: 0 };

                switch(type) {
                    case 'steps': 
                        xpGained = Math.floor(valueToProcess / 1000) * 75;
                        statGains.stamina += Math.floor(valueToProcess / 1000) * 1;
                        statGains.agility += Math.floor(valueToProcess / 1000) * 1;
                        break;
                    case 'calories':
                        xpGained = Math.floor(valueToProcess / 100) * 90;
                        statGains.strength += Math.floor(valueToProcess / 100) * 1;
                        statGains.stamina += Math.floor(valueToProcess / 100) * 1;
                        break;
                    case 'sleep':
                        xpGained = Math.floor(valueToProcess) * 100;
                        statGains.intelligence += Math.floor(valueToProcess) * 1;
                        statGains.stamina += Math.floor(valueToProcess) * 1;
                        break;
                    case 'water':
                        xpGained = Math.floor(valueToProcess / 500) * 100;
                        statGains.stamina += Math.floor(valueToProcess / 500) * 1;
                        statGains.intelligence += Math.floor(valueToProcess / 500) * 1;
                        break;
                }
                
                // 將計算出的能力值和經驗值加給玩家
                player.baseStats.strength += statGains.strength;
                player.baseStats.stamina += statGains.stamina;
                player.baseStats.agility += statGains.agility;
                player.baseStats.intelligence += statGains.intelligence;
                
                if (xpGained > 0) {
                    addXp(xpGained);
                }

                // 組合回饋訊息
                feedback += `獲得 ${xpGained} 經驗值`;
                if (statGains.strength > 0) feedback += `\n+${statGains.strength} 力量 💪`;
                if (statGains.stamina > 0) feedback += `\n+${statGains.stamina} 耐力 🛡️`;
                if (statGains.agility > 0) feedback += `\n+${statGains.agility} 敏捷 ⚡`;
                if (statGains.intelligence > 0) feedback += `\n+${statGains.intelligence} 智力 🧠`;
            }

            // --- 步驟 4: 保存數據，更新所有UI，並顯示最終的回饋訊息 ---
            savePlayerData();
            updateAllUI();
            
            // 使用 setTimeout 確保 UI 都更新完畢後再跳出視窗，體驗更流暢
            setTimeout(() => showModal(feedback, null, true), 50);
        }

        // 程式碼功能說明: 道具系統核心邏輯
        // 包含產生、新增、渲染、顯示詳情等所有與道具相關的功能。

        function generateRandomItem(forceRarity = null, allowedTypes = ['裝備', '消耗品', '蒐藏品']) {
            const level = player.level;
            const luck = player.totalStats.luck;
            
            const currentTier = [...dropRateTiers].reverse().find(t => level >= t.levelRange[0]) || dropRateTiers[0];

            const baseRates = currentTier.rates;

            // [功能更新] 根據運氣調整掉落率
            const adjustedRates = { ...baseRates };
            let luckBonus = luck * 0.1; // 每點運氣增加0.1%稀有掉落修正
            let commonRateReduction = 0;

            // 將運氣加成按比例分配到稀有物品上
            ['Divum', 'Caelum', 'Stella', 'Sol', 'Luna', 'Scintilla', 'Fulmen'].forEach(rarity => {
                if (adjustedRates[rarity] > 0) {
                    const bonus = luckBonus * (adjustedRates[rarity] / 100);
                    adjustedRates[rarity] += bonus;
                    commonRateReduction += bonus;
                }
            });
            
            // 從最低稀有度扣除加成的機率
            adjustedRates.Ferrum = Math.max(0, adjustedRates.Ferrum - commonRateReduction);
            
            let rarity;
            if (forceRarity) {
                rarity = forceRarity;
            } else {
                const rand = Math.random() * 100;
                let cumulative = 0;
                for (const r in adjustedRates) {
                    cumulative += adjustedRates[r];
                    if (rand < cumulative) {
                        rarity = r;
                        break;
                    }
                }
            }
            
            const possibleItems = masterItemList.filter(item => item.rarity === rarity && allowedTypes.includes(item.type) && !item.bossSource);
            const baseItem = possibleItems.length > 0 ? possibleItems[Math.floor(Math.random() * possibleItems.length)] : masterItemList[0];
            
            // 深拷貝一個新道具
            const newItem = JSON.parse(JSON.stringify(baseItem));
            
            player.itemCounter++;
            newItem.uniqueId = `ITM${player.itemCounter.toString().padStart(6, '0')}`;
            newItem.timestamp = Date.now();
            newItem.isFavorite = false;

            return newItem;
        }

        function addItemToInventory(item) {
            player.inventory.push(item);
            if (!player.codex.includes(item.id)) {
                player.codex.push(item.id);
            }
            savePlayerData();
            updateTaskProgress();
        }

        function renderInventory() {
            const grid = document.getElementById('inventory-grid');
            const filters = document.getElementById('inventory-filters');
            grid.innerHTML = '';
            
            filters.style.display = 'flex'; // 確保篩選器總是顯示

            if (currentInventoryTab === 'inventory') {
                document.getElementById('inventory-capacity').style.display = 'block'; // 顯示容量
                document.getElementById('quick-salvage-btn').style.display = 'block'; // 顯示回收按鈕
                document.getElementById('sort-inventory-btn').style.display = 'block'; // 顯示整理按鈕

                const itemsToShow = player.inventory.filter(item => {
                    if (currentInventoryFilter === 'all') return true;
                    return item.type === currentInventoryFilter;
                });

                if (itemsToShow.length === 0) {
                    grid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center;">你的背包空空如也，快去冒險吧！</p>';
                } else {
                    itemsToShow.forEach(item => {
                        const cardWrapper = createItemCard(item, true); // 使用 createItemCard 創建卡片
                        cardWrapper.addEventListener('click', () => showItemDetails(item, false));
                        grid.appendChild(cardWrapper);
                    });
                }
                document.getElementById('inventory-capacity').textContent = `容量: ${player.inventory.length} / 150`;

            } else if (currentInventoryTab === 'codex') {
                document.getElementById('inventory-capacity').style.display = 'none'; // 圖鑑頁隱藏容量
                document.getElementById('quick-salvage-btn').style.display = 'none'; // 隱藏回收按鈕
                document.getElementById('sort-inventory-btn').style.display = 'none'; // 隱藏整理按鈕

                const allItemsInCodex = masterItemList.filter(item => {
                    if (currentInventoryFilter === 'all') return true;
                    return item.type === currentInventoryFilter;
                });

                if (allItemsInCodex.length === 0) {
                    grid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center;">這個分類下沒有任何道具喔！</p>';
                } else {
                     allItemsInCodex.forEach(masterItem => {
                        const isUnlocked = player.codex.includes(masterItem.id);
                        const card = createItemCard(masterItem, isUnlocked);
                        if (isUnlocked) {
                            card.addEventListener('click', () => showItemDetails(masterItem, true));
                        }
                        grid.appendChild(card);
                    });
                }
            }
        }

        function createItemCard(item, isUnlocked = true) {
            const wrapper = document.createElement('div');
            const card = document.createElement('div');
            
            const rarityData = item?.bossSource ? bossRarityConfig[item.rarity] : rarityConfig[item.rarity];
            const rarityClass = rarityData?.class || 'rarity-ferrum';
            
            let typeClass = '';
            if (item && item.type) {
                if (item.type === '裝備') typeClass = 'item-type-equipment';
                else if (item.type === '消耗品') typeClass = 'item-type-consumable';
                else if (item.type === '蒐藏品') typeClass = 'item-type-collectible';
            }
            wrapper.className = `item-card-wrapper ${rarityClass} ${typeClass}`;

            if (!isUnlocked) {
                card.className = 'item-card is-locked';
                card.innerHTML = `<div class="item-icon"><i class="ph ph-question"></i></div>`;
            } else {
                card.className = `item-card`;
                if (item.isFavorite) card.classList.add('is-favorite');
                card.innerHTML = `
                    <div class="item-icon">${item.icon}</div>
                    <div class="favorite-star"><i class="ph-fill ph-star"></i></div>
                `;
            }
            
            wrapper.appendChild(card);
            return wrapper;
        }

        function showItemDetails(item, isCodexView = false, isEquippedView = false, slotName = null, isMuseumView = false) {
            const modal = document.getElementById('item-details-modal');
            // [核心修正] 增加保護，如果找不到 item 或 rarityConfig 就直接返回
            if (!item) return;
            const rarityData = item.bossSource ? bossRarityConfig[item.rarity] : rarityConfig[item.rarity];
            if (!rarityData) return;

            // Icon
            const iconWrapper = document.getElementById('item-details-icon-wrapper');
            iconWrapper.innerHTML = '';
            const itemCard = createItemCard(item);
            itemCard.classList.add('no-hover-effect');
            iconWrapper.appendChild(itemCard);

            // Info
            document.getElementById('item-details-name').textContent = item.name;
            document.getElementById('item-details-name').style.color = rarityData.color;
            document.getElementById('item-details-rarity-type').textContent = `${rarityData.name} ${item.type}`;
            document.getElementById('item-details-id').textContent = item.uniqueId || item.id;
            document.getElementById('item-details-desc').textContent = item.desc;

            // Stats
            const statsDiv = document.getElementById('item-details-stats');
            statsDiv.innerHTML = '';
            if (item.stats || item.effects) {
                statsDiv.innerHTML += '<h4><i class="ph-fill ph-sparkle"></i> 效果</h4>';
                if(item.stats) {
                    for (const [stat, value] of Object.entries(item.stats)) {
                        // 只有當 value 大於 0 時，才在前面加上 "+" 號
                        const sign = value > 0 ? '+' : '';
                        statsDiv.innerHTML += `<p>${stat}: ${sign}${value}</p>`;
                    }
                }
                if (item.effects) {
                    if (item.effects.type === 'buff') {
                        const statsAffected = Array.isArray(item.effects.stat) ? item.effects.stat.join(', ') : item.effects.stat;
                        statsDiv.innerHTML += `<p>${statsAffected} 提升 ${item.effects.multiplier}倍，持續 ${item.effects.duration / 60} 分鐘</p>`;
                    }
                    if (item.effects.museum_bonus) {
                        let bonusText = Object.entries(item.effects.museum_bonus).map(([stat, value]) => `${stat} +${value * 100}%`).join(' ');
                        statsDiv.innerHTML += `<p>博物館加成: ${bonusText}</p>`;
                    }
                }
            }
            
            // Buttons
            const buttonsDiv = document.getElementById('item-details-buttons');
            buttonsDiv.innerHTML = '';
            
            document.getElementById('equip-comparison').style.display = 'none';

            if (isMuseumView) {
                const retrieveBtn = document.createElement('button');
                retrieveBtn.textContent = '取回倉庫';
                retrieveBtn.className = 'modal-button confirm';
                retrieveBtn.onclick = () => { hideModal('item-details-modal'); setTimeout(() => handleRemoveFromMuseum(slotName), 100); };
                buttonsDiv.appendChild(retrieveBtn);

                const replaceBtn = document.createElement('button');
                replaceBtn.textContent = '替換藏品';
                replaceBtn.className = 'modal-button';
                replaceBtn.onclick = () => { hideModal('item-details-modal'); setTimeout(() => openMuseumPlacementModal(slotName), 100); };
                buttonsDiv.appendChild(replaceBtn);

            } else if (!isCodexView) {
                if (isEquippedView) {
                    const unequipBtn = document.createElement('button');
                    unequipBtn.textContent = '卸下';
                    unequipBtn.className = 'modal-button confirm';
                    unequipBtn.onclick = () => handleUnequip(item, slotName);
                    buttonsDiv.appendChild(unequipBtn);
                } else {
                    if (item.type === '裝備') {
                        const equipBtn = document.createElement('button');
                        equipBtn.textContent = '裝備';
                        equipBtn.className = 'modal-button confirm';
                        equipBtn.onclick = () => openEquipChoiceModal(item);
                        buttonsDiv.appendChild(equipBtn);
                    }
                    if (item.type === '消耗品') {
                        const useBtn = document.createElement('button');
                        useBtn.textContent = '使用';
                        useBtn.className = 'modal-button confirm';
                        useBtn.onclick = () => useItem(item);
                        buttonsDiv.appendChild(useBtn);
                    }
                    if (item.type === '蒐藏品') {
                        const museumBtn = document.createElement('button');
                        museumBtn.textContent = '放入博物館';
                        museumBtn.className = 'modal-button confirm';
                        museumBtn.onclick = () => handlePlaceInMuseumRequest(item);
                        buttonsDiv.appendChild(museumBtn);
                    }

                    const favoriteBtn = document.createElement('button');
                    favoriteBtn.innerHTML = item.isFavorite ? '<i class="ph-fill ph-star"></i> 取消最愛' : '<i class="ph ph-star"></i> 加入最愛';
                    favoriteBtn.className = 'modal-button';
                    favoriteBtn.onclick = () => toggleFavorite(item);
                    buttonsDiv.appendChild(favoriteBtn);
                    
                    const salvageBtn = document.createElement('button');
                    salvageBtn.textContent = '回收';
                    salvageBtn.className = 'modal-button cancel';
                    salvageBtn.style.background = '#c0392b';
                    salvageBtn.onclick = () => salvageItem(item); 
                    buttonsDiv.appendChild(salvageBtn);
                }
            }
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '關閉';
            closeBtn.className = 'modal-button cancel';
            closeBtn.style.gridColumn = '1 / -1'; // 讓關閉按鈕橫跨兩欄
            closeBtn.onclick = () => hideModal('item-details-modal');
            buttonsDiv.appendChild(closeBtn);

            modal.classList.add('active');
        }
        
        // [功能修正] 重新加入裝備選擇與比較邏輯
        function openEquipChoiceModal(itemToEquip) {
            hideModal('item-details-modal');
            const modal = document.getElementById('equip-choice-modal');
            document.getElementById('equip-choice-item-name').textContent = itemToEquip.name;
            const buttonsDiv = document.getElementById('equip-choice-buttons');
            buttonsDiv.innerHTML = '';
            
            ['slot1', 'slot2'].forEach(slot => {
                const currentItem = player.equipment[slot];
                const btn = document.createElement('button');
                btn.className = 'modal-button';
                btn.textContent = `裝備至欄位 ${slot.slice(-1)} (${currentItem ? currentItem.name : '空'})`;
                btn.onclick = () => confirmAndExecuteEquip(itemToEquip, slot);
                buttonsDiv.appendChild(btn);
            });
            
            document.getElementById('equip-choice-cancel-btn').onclick = () => hideModal('equip-choice-modal');
            
            setTimeout(() => modal.classList.add('active'), 100);
        }

        function confirmAndExecuteEquip(itemToEquip, slot) {
            hideModal('equip-choice-modal');
            const currentItem = player.equipment[slot];
            
            let comparisonText = `確定要將【${itemToEquip.name}】裝備到欄位 ${slot.slice(-1)} 嗎？\n\n`;
            
            const allStats = new Set([...Object.keys(itemToEquip.stats || {}), ...Object.keys(currentItem?.stats || {})]);
            
            if (allStats.size > 0) {
                comparisonText += "能力值變化：\n";
                allStats.forEach(stat => {
                    const newVal = itemToEquip.stats?.[stat] || 0;
                    const oldVal = currentItem?.stats?.[stat] || 0;
                    const diff = newVal - oldVal;
                    if (diff !== 0) {
                        comparisonText += `${stat}: ${oldVal} → ${newVal} (${diff > 0 ? '+' : ''}${diff})\n`;
                    }
                });
            }

            if (currentItem) {
                 comparisonText += `\n原本的【${currentItem.name}】將會被放回倉庫。`;
            }

            setTimeout(() => {
                showModal(comparisonText, () => {
                    handleEquip(itemToEquip, slot);
                });
            }, 100);
        }

        function handleEquip(itemToEquip, slot) {
            const currentItem = player.equipment[slot];
            
            // 從倉庫移除新裝備
            player.inventory = player.inventory.filter(i => i.uniqueId !== itemToEquip.uniqueId);
            // 如果舊裝備存在，將其放回倉庫
            if (currentItem) {
                player.inventory.push(currentItem);
            }
            // 裝上新裝備
            player.equipment[slot] = itemToEquip;
            soundManager.play('equipment');
            showModal(`已裝備【${itemToEquip.name}】到欄位 ${slot.slice(-1)}！`, null, true);
            updateAllUI();
            renderInventory();
            savePlayerData();
        }
        
        function handleUnequip(itemToUnequip, slotName) {
            if (!slotName || player.equipment[slotName]?.uniqueId !== itemToUnequip.uniqueId) return;

            // 從裝備欄卸下
            player.equipment[slotName] = null;
            //  卸下前檢查倉庫容量
            if (player.inventory.length >= 150) {
                hideModal('item-details-modal');
                soundManager.play('wrong');
                showModal("道具倉庫已滿，無法卸下裝備！", null, true);
                return;
            }
            // 放回倉庫
            player.inventory.push(itemToUnequip);
            soundManager.play('down');
            hideModal('item-details-modal');
            showModal(`已卸下【${itemToUnequip.name}】。`, null, true);
            updateAllUI();
            savePlayerData();
        }

        function clearExpiredBuffs() {
            const now = Date.now();
            const activeBuffCount = player.activeBuffs.length;
            player.activeBuffs = player.activeBuffs.filter(buff => buff.expiryTime > now);
            // 如果有buff過期，才需要更新UI
            if (player.activeBuffs.length < activeBuffCount) {
                updateAllUI();
            }
        }

        function calculateTotalStats() {
            clearExpiredBuffs();
            let tempStats = {};
            for (const stat in player.baseStats) {
                tempStats[stat] = player.baseStats[stat] + player.assignedStats[stat];
            }

            for (const slot in player.equipment) {
                const item = player.equipment[slot];
                if (item && item.stats) {
                    for (const stat in item.stats) {
                        tempStats[stat] += item.stats[stat];
                    }
                }
            }

            let museumMultipliers = { strength: 1, stamina: 1, agility: 1, intelligence: 1, luck: 1 };
            for (const slot in player.museumSlots) {
                const item = player.museumSlots[slot];
                if (item && item.effects && item.effects.museum_bonus) {
                    for (const stat in item.effects.museum_bonus) {
                        museumMultipliers[stat] += item.effects.museum_bonus[stat];
                    }
                }
            }
            
            let titleMultiplier = { strength: 1, stamina: 1, agility: 1, intelligence: 1, luck: 1 };
            if (player.equippedTitle && titleData && titleData[player.equippedTitle]) {
                const titleBonus = titleData[player.equippedTitle].bonus;
                if (titleBonus) {
                    for (const stat in titleBonus) {
                        const bonusValue = titleBonus[stat];
                        if (stat === 'all') {
                            for (const key in titleMultiplier) {
                                titleMultiplier[key] += bonusValue;
                            }
                        } else if (titleMultiplier.hasOwnProperty(stat)) {
                            titleMultiplier[stat] += bonusValue;
                        }
                    }
                }
            }

            let buffMultipliers = { strength: 1, stamina: 1, agility: 1, intelligence: 1, luck: 1 };
            player.activeBuffs.forEach(buff => {
                if (Array.isArray(buff.stat)) {
                    buff.stat.forEach(s => {
                        buffMultipliers[s] *= buff.multiplier;
                    });
                } else {
                    buffMultipliers[buff.stat] *= buff.multiplier;
                }
            });

            for (const stat in tempStats) {
                player.totalStats[stat] = tempStats[stat] * museumMultipliers[stat] * buffMultipliers[stat] * titleMultiplier[stat];
            }
        }
        
        function updateEquipmentUI() {
            ['slot1', 'slot2'].forEach(slot => {
                const item = player.equipment[slot];
                const slotEl = document.getElementById(`equipment${slot.charAt(0).toUpperCase() + slot.slice(1)}`);

                if (!slotEl) return;
                slotEl.innerHTML = ''; 
                slotEl.classList.remove('is-empty', 'is-filled');

                if (item) {
                    // --- 處理【有裝備】的欄位 ---
                    slotEl.classList.add('is-filled');
                    const itemWrapper = createItemCard(item);
                    itemWrapper.style.width = '100%';
                    itemWrapper.style.height = '100%';

                    const itemCardElement = itemWrapper.querySelector('.item-card');
                    if (itemCardElement) {
                        itemCardElement.style.cursor = 'pointer';
                    }

                    slotEl.appendChild(itemWrapper);
                    slotEl.style.borderStyle = 'solid';

                    const nameEl = document.createElement('div');
                    nameEl.className = 'equipment-slot-name';
                    nameEl.textContent = item.name;
                    const rarityData = item.bossSource ? bossRarityConfig[item.rarity] : rarityConfig[item.rarity];
                    if (rarityData) {
                        nameEl.style.color = rarityData.color;
                    }
                    slotEl.appendChild(nameEl);

                } else {
                    // --- 處理【空的】欄位  ---
                    slotEl.classList.add('is-empty');
                    slotEl.style.borderStyle = 'dashed';

                    let placeholderIcon = 'ph-sword';
                    let placeholderName = '裝備欄 1';
                    if (slot === 'slot2') {
                        placeholderIcon = 'ph-shield';
                        placeholderName = '裝-備欄 2';
                    }
                    slotEl.innerHTML = `
                        <div class="equipment-slot-icon-wrapper" style="pointer-events: none;">
                            <i class="ph ${placeholderIcon}" style="font-size: 36px; color: var(--text-color-light); opacity: 0.5;"></i>
                        </div>
                        <div class="equipment-slot-name" style="pointer-events: none;">${placeholderName}</div>
                    `;
                }
            });
        }
        

        // 確保設定頁面的頭像與玩家目前頭像同步。
        function updateSettingsUI() {
            let settingsAvatarEl = document.getElementById('settings-avatar');
            
            // 如果 avatar 元素不存在，就創建一個
            if (!settingsAvatarEl) {
                settingsAvatarEl = document.createElement('span'); // 預設創建 span
                settingsAvatarEl.id = 'settings-avatar';
                const container = document.getElementById('settings-avatar-container');
                container.prepend(settingsAvatarEl); // 插入到容器的最前面
            }

            if (player && player.avatar) {
                const isImage = player.avatar.startsWith('data:image/') || player.isCustomAvatar;
                
                // 如果當前元素類型不對，就替換它
                if (isImage && settingsAvatarEl.tagName !== 'IMG') {
                    const newImg = document.createElement('img');
                    newImg.id = 'settings-avatar';
                    settingsAvatarEl.replaceWith(newImg);
                    settingsAvatarEl = newImg;
                } else if (!isImage && settingsAvatarEl.tagName !== 'SPAN') {
                    const newSpan = document.createElement('span');
                    newSpan.id = 'settings-avatar';
                    settingsAvatarEl.replaceWith(newSpan);
                    settingsAvatarEl = newSpan;
                }

                // 根據類型設定屬性
                if (isImage) {
                    settingsAvatarEl.src = player.avatar;
                    settingsAvatarEl.alt = "";
                    settingsAvatarEl.style.cssText = "width: 40px; height: 40px; border-radius: 50%; object-fit: cover;";
                } else {
                    settingsAvatarEl.textContent = player.avatar;
                    settingsAvatarEl.style.fontSize = '32px';
                }
            }
        }
        function toggleFavorite(item) {
            const inventoryItem = player.inventory.find(i => i.uniqueId === item.uniqueId) || player.lootWarehouse.find(i => i.uniqueId === item.uniqueId);
            if (inventoryItem) {
                inventoryItem.isFavorite = !inventoryItem.isFavorite;
                savePlayerData();
                renderInventory();
                showItemDetails(inventoryItem); // 重新顯示 modal 以更新按鈕
            }
        }
        
        function salvageItem(item) {
            if (item.isFavorite) {
                soundManager.play('wrong');
                showModal("不能回收最愛的道具！", null, true);
                return;
            }
            hideModal('item-details-modal');
            
            setTimeout(() => { // 加一個小延遲，確保UI更新順暢
                soundManager.play('level');
                 showModal(`確定要回收【${item.name}】嗎？此操作無法復原。`, () => {
                    player.inventory = player.inventory.filter(i => i.uniqueId !== item.uniqueId);
                    player.lootWarehouse = player.lootWarehouse.filter(i => i.uniqueId !== item.uniqueId);
                    soundManager.play('break');
                    showModal(`已回收【${item.name}】。`, null, true);
                    renderInventory();
                    savePlayerData();
                });
            }, 100);
        }
        
        function useItem(item) {
            if (item.type !== '消耗品' || !item.effects || item.effects.type !== 'buff') {
                soundManager.play('wrong');
                showModal("這個道具不能這樣用喔！", null, true);
                return;
            }

            const now = Date.now();
            const newBuff = {
                itemId: item.id,
                stat: item.effects.stat,
                multiplier: item.effects.multiplier,
                expiryTime: now + item.effects.duration * 1000,
            };

            player.activeBuffs.push(newBuff);
            player.inventory = player.inventory.filter(i => i.uniqueId !== item.uniqueId);
            
            hideModal('item-details-modal');
            
            const statsAffected = Array.isArray(item.effects.stat) ? item.effects.stat.join(', ') : item.effects.stat;
            soundManager.play('useitem');
            showModal(`你使用了【${item.name}】！\n在接下來的 ${item.effects.duration / 60} 分鐘內，${statsAffected} 能力值將提升為 ${item.effects.multiplier} 倍！`, null, true);
            
            updateAllUI();
            savePlayerData();
            renderInventory();
        }

        async function handleLogout() {
            showModal("確定要登出嗎？你的冒險將暫時告一段落。", async () => {
                const token = localStorage.getItem('currentUserToken');
                if (token) {
                    await mockAuthServer.logout(token);
                }
                localStorage.removeItem('currentUserToken');
                currentUserIdentifier = null;
                player = {};
                
                bottomNav.classList.remove('active');
                showScreen('welcome-screen');
            });
        }
        
        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    // 創建一個虛擬的 canvas 來縮放圖片
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // 設定我們想要的最終尺寸
                    const MAX_WIDTH = 200;
                    const MAX_HEIGHT = 200;
                    let width = img.width;
                    let height = img.height;

                    // 等比例縮放
                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }
                    canvas.width = width;
                    canvas.height = height;

                    // 將圖片繪製到 canvas 上
                    ctx.drawImage(img, 0, 0, width, height);

                    // 從 canvas 取得壓縮後的 base64 資料
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.9); // 0.9 代表壓縮品質

                    player.avatar = dataUrl;
                    player.isCustomAvatar = true;
                    savePlayerData();
                    updateAllUI();
                    showModal('頭像更換成功！');
                };
                img.src = e.target.result;
            };
    reader.readAsDataURL(file);
}

        function deleteAvatar() {
            if (!player.isCustomAvatar) {
                soundManager.play('wrong');
                showModal("你正在使用預設頭像，無法刪除喔！", null, true);
                return 
            }
            soundManager.play('level');
            showModal("確定要刪除目前的自訂頭像嗎？", () => {   
                player.avatar = '👦';  // 直接將頭像設定回預設的 emoji
                player.isCustomAvatar = false;
                savePlayerData();
                updateAllUI();
                soundManager.play('success');
                 showModal("自訂頭像已刪除，已恢復預設頭像。", null, true);
            });
        }

        function getCurrentTier() {
            const tiers = jobData[player.professionId]?.tiers || [];
            return tiers.slice().reverse().find(tier => player.level >= tier.level) || tiers[0];
        }

        function updateProfessionInfo() {
            const currentTier = getCurrentTier();
            if (currentTier) player.title = currentTier.title;
        }

        function showScreen(screenId) {
            appContainer.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
                targetScreen.scrollTop = 0;

                // 根據畫面ID執行特定的渲染邏輯
                if (screenId === 'profession-screen') updateProfessionUI();
                if (screenId === 'inventory-screen') renderInventory();
                if (screenId === 'chest-screen') updateChestScreenUI();
                if (screenId === 'boss-screen') updateBossScreenUI();renderTitleSystemUI();
                if (screenId === 'museum-screen') renderMuseum();
                if (screenId === 'assistant-screen') renderAssistantUI();
            }
        }
        function setActiveNav(screenId) {
            navItems.forEach(item => item.classList.toggle('active', item.dataset.screen === screenId));
        }
        function getLevelTier(level) {
            return [...dropRateTiers].reverse().find(t => level >= t.levelRange[0]) || dropRateTiers[0];
        }
        function showModal(text, onConfirm = null, isAlert = false, options = {}) {
            const modal = document.getElementById('custom-modal');
            modal.querySelector('#modal-title-generic').innerText = options.title || '提示';
            modal.querySelector('#modal-text-generic').innerHTML = text.replace(/\n/g, '<br>'); // 支援換行符
            
            const confirmBtn = modal.querySelector('#modal-confirm-btn');
            const cancelBtn = modal.querySelector('#modal-cancel-btn');
            
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

            const newCancelBtn = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

            newConfirmBtn.onclick = () => {
                if (onConfirm) onConfirm();
                hideModal('custom-modal');
            };
            newCancelBtn.onclick = () => hideModal('custom-modal');

            if (isAlert) {
                newCancelBtn.style.display = 'none';
                newConfirmBtn.innerText = options.confirmText || '好的';
            } else {
                newCancelBtn.style.display = 'inline-block';
                newConfirmBtn.innerText = options.confirmText || '確認';
                newCancelBtn.innerText = options.cancelText || '取消';
            }
            modal.classList.add('active');
        }
        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function getAvatarDataUrl(element) {
            // 如果是 emoji，直接返回文字內容
            if (element.tagName !== 'svg' && element.tagName !== 'SVG') {
                return element.textContent;
            }
            if (!element) return '';
            const svgString = new XMLSerializer().serializeToString(element);
            return "data:image/svg+xml;base64," + window.btoa(unescape(encodeURIComponent(svgString)));
        }
        
        function openProfessionModal() {
            const modal = document.getElementById('profession-modal');
            const grid = document.getElementById('profession-modal-grid');
            
            grid.innerHTML = Object.keys(jobData).map(jobId => {
                const profession = jobData[jobId];
                const isCurrent = (professionModalMode === 'change_char' && jobId === player.professionId);
                return `
                    <div class="profession-option ${tempSelectedProfession === jobId ? 'selected' : ''} ${isCurrent ? 'is-current' : ''}" data-value="${jobId}">
                        <i>${profession.icon}</i> <span>${jobId}</span>
                    </div>
                `;
            }).join('');

            grid.querySelectorAll('.profession-option').forEach(option => {
                option.addEventListener('click', () => {
                    grid.querySelector('.selected')?.classList.remove('selected');
                    option.classList.add('selected');
                    tempSelectedProfession = option.dataset.value;
                });
            });
            modal.classList.add('active');
        }
        
        // 程式碼功能說明: 開寶箱核心功能
        function handleOpenChest() {
            if (isChestOnCooldown) {
                soundManager.play('wrong');
                showModal("寶箱正在冷卻中...", null, true);
                return;
            }
            isChestOnCooldown = true;
            const openChestBtn = document.getElementById('open-chest-btn');
            openChestBtn.disabled = true;
            
            // 執行開箱動畫
            runChestAnimation().then(items => {
                items.forEach(item => addItemToInventory(item));
                savePlayerData();
                showRewardModal(items);
            });

            // 處理冷卻
            let cooldown = 3;
            openChestBtn.innerHTML = `<i class="ph-fill ph-clock"></i> 冷卻中 (${cooldown}s)`;
            const interval = setInterval(() => {
                cooldown--;
                openChestBtn.innerHTML = `<i class="ph-fill ph-clock"></i> 冷卻中 (${cooldown}s)`;
            }, 1000);
            setTimeout(() => {
                isChestOnCooldown = false;
                openChestBtn.disabled = false;
                openChestBtn.innerHTML = '開啟寶箱';
                clearInterval(interval);
            }, 3000);
            updateTaskProgress();
        }

        function runChestAnimation() {
            return new Promise(resolve => {
                const screen = document.getElementById('chest-opening-screen');
                const chest = document.getElementById('animated-chest');
                const particlesContainer = screen.querySelector('.particles');
                const flash = document.getElementById('flash-overlay');
                
                showScreen('chest-opening-screen');
                chest.className = 'ph-fill ph-treasure-chest'; // Reset classes
                particlesContainer.innerHTML = '';
                soundManager.play('chest_open');
                // 1. 悸動預熱
                setTimeout(() => {
                    chest.classList.add('pulse');
                }, 100);

                // 2. 期待漩渦
                setTimeout(() => {
                    chest.classList.remove('pulse');
                    chest.classList.add('shake');
                    
                    
                    // 白色能量漩渦
                    for (let i = 0; i < 30; i++) {
                        const p = document.createElement('div');
                        p.className = 'particle vortex';
                        const angle = Math.random() * 2 * Math.PI;
                        const radius = 150;
                        p.style.setProperty('--x', `${Math.cos(angle) * radius}px`);
                        p.style.setProperty('--y', `${Math.sin(angle) * radius}px`);
                        p.style.background = 'white';
                        particlesContainer.appendChild(p);
                    }
                    
                    // 彩虹火花噴發
                    const rainbowColors = ['#ff0000', '#ff7f00', '#ffff00', '#00ff00', '#0000ff', '#4b0082', '#9400d3'];
                    for (let i = 0; i < 60; i++) {
                        const spark = document.createElement('div');
                        spark.className = 'particle spark';
                        const angle = Math.random() * 2 * Math.PI;
                        const radius = Math.random() * 120 + 30; // 噴發半徑
                        spark.style.setProperty('--x', `${Math.cos(angle) * radius}px`);
                        spark.style.setProperty('--y', `${Math.sin(angle) * radius}px`);
                        spark.style.background = rainbowColors[i % rainbowColors.length];
                        spark.style.animationDelay = `${Math.random() * 0.5}s`;
                        particlesContainer.appendChild(spark);
                    }

                }, 1100);

                // 3. 榮耀綻放
                setTimeout(() => {
                    chest.classList.remove('shake');
                    chest.classList.add('open');
                    flash.classList.add('active');
                    
                    const items = [generateRandomItem(null, ['裝備', '消耗品'])];
                    // 根據運氣決定是否獲得額外道具
                    const luck = player.totalStats.luck;
                    if (Math.random() * 100 < luck * 0.2) { // 每點運氣增加0.05%機率
                        items.push(generateRandomItem(null, ['裝備', '消耗品']));
                    }
                    
                    setTimeout(() => {
                        flash.classList.remove('active');
                        resolve(items);
                    }, 500);
                }, 2600);
            });
        }

        // [特效更新] 更新開箱獎勵 Modal 顯示邏輯
        function showRewardModal(items) {
            const modal = document.getElementById('chest-reward-modal');
            const rewardContainer = document.getElementById('chest-reward-items-container');
            rewardContainer.innerHTML = ''; // 清空舊的獎勵

            items.forEach(item => {
                const itemWrapper = document.createElement('div');
                itemWrapper.className = 'chest-reward-item-wrapper';

                const itemCard = createItemCard(item);
                
                const rarityData = item.bossSource ? bossRarityConfig[item.rarity] : rarityConfig[item.rarity];
                const formattedTimestamp = new Date(item.timestamp).toLocaleString('zh-TW', {
                    year: 'numeric', month: '2-digit', day: '2-digit', 
                    hour: '2-digit', minute: '2-digit', hour12: false 
                }).replace(/\//g, '-');

                const itemInfo = document.createElement('div');
                itemInfo.className = 'chest-reward-item-info';
                itemInfo.innerHTML = `
                    <p class="reward-name" style="color: ${rarityData.color};">${item.name}</p>
                    <p>稀有度: ${rarityData.name}</p>
                    <p>編號: ${item.uniqueId}</p>
                    <p>時間: ${formattedTimestamp}</p>
                `;
                
                itemWrapper.appendChild(itemCard);
                itemWrapper.appendChild(itemInfo);
                rewardContainer.appendChild(itemWrapper);
            });

            modal.classList.add('active');

            // 獎勵展示幾秒後自動關閉
            setTimeout(() => {
                hideModal('chest-reward-modal');
                showScreen('chest-screen'); // 返回寶箱頁面
            }, 1500); // 延長顯示時間以看清楚資訊
        }
        
        // 程式碼功能說明: 更新寶箱畫面UI
        function updateChestScreenUI() {
            const currentTier = [...dropRateTiers].reverse().find(t => player.level >= t.levelRange[0]) || dropRateTiers[0];
            const currentTierIndex = dropRateTiers.indexOf(currentTier);
            
            const nextTier = (currentTierIndex !== -1 && currentTierIndex < dropRateTiers.length - 1) ? dropRateTiers[currentTierIndex + 1] : null;

            const currentRatesTable = document.getElementById('current-rates-table');
            const nextRatesTable = document.getElementById('next-rates-table');

            currentRatesTable.innerHTML = `<h4>當前階等 (${currentTier.label})</h4>` + generateRatesTable(currentTier.rates);
            
            if (nextTier) {
                nextRatesTable.parentElement.style.display = 'block';
                nextRatesTable.innerHTML = `<h4>下一階等 (${nextTier.label})</h4>` + generateRatesTable(nextTier.rates);
            } else {
                nextRatesTable.parentElement.style.display = 'block';
                nextRatesTable.innerHTML = `<h4>已達最高階等</h4><p>恭喜你，冒險者！</p>`;
            }
        }

        function generateRatesTable(rates) {
            let tableHTML = '<table class="chest-probability-table">';
            for (const rarityKey in rates) {
                const rate = rates[rarityKey];
                if (rate > 0) {
                    const rarityInfo = rarityConfig[rarityKey];
                    tableHTML += `
                        <tr>
                            <td style="color: ${rarityInfo.color};">${rarityInfo.name}</td>
                            <td>${rate.toFixed(1)}%</td>
                        </tr>
                    `;
                }
            }
            tableHTML += '</table>';
            return tableHTML;
        }

        // 程式碼功能說明: 動態更新回收稀有度選項
        // 根據選擇的道具類型，智慧地顯示對應的稀有度。
        function updateSalvageRarityOptions() {
            const type = document.getElementById('salvage-type-select').value;
            const raritySelect = document.getElementById('salvage-rarity-select');
            raritySelect.innerHTML = '<option value="all">所有稀有度</option>'; // 保留「所有」選項

            let relevantRarities = {};
            if (type === '裝備' || type === '消耗品') {
                relevantRarities = rarityConfig;
            } else if (type === '蒐藏品') {
                relevantRarities = bossRarityConfig;
            } else { // type === 'all'
                relevantRarities = { ...rarityConfig, ...bossRarityConfig };
            }

            for (const rarityKey in relevantRarities) {
                raritySelect.innerHTML += `<option value="${rarityKey}">${relevantRarities[rarityKey].name}</option>`;
            }
        }

        // 程式碼功能說明: 打開一鍵回收視窗
        function openQuickSalvageModal() {
            const typeSelect = document.getElementById('salvage-type-select');
            typeSelect.innerHTML = `
                <option value="all">所有類型</option>
                <option value="裝備">裝備</option>
                <option value="消耗品">消耗品</option>
                <option value="蒐藏品">蒐藏品</option>
            `;
            updateSalvageRarityOptions();
            
            document.getElementById('quick-salvage-modal').classList.add('active');
        }

        function executeQuickSalvage() {
            const type = document.getElementById('salvage-type-select').value;
            const rarity = document.getElementById('salvage-rarity-select').value;

            const itemsToSalvage = [...player.inventory, ...player.lootWarehouse].filter(item => {
                const typeMatch = (type === 'all' || item.type === type);
                const rarityMatch = (rarity === 'all' || item.rarity === rarity);
                return !item.isFavorite && typeMatch && rarityMatch;
            });

            if (itemsToSalvage.length === 0) {
                soundManager.play('wrong');
                showModal("沒有找到符合條件的道具可回收。", null, true);
                return;
            }

            hideModal('quick-salvage-modal');

            setTimeout(() => {
                soundManager.play('level');
                showModal(`確定要回收 ${itemsToSalvage.length} 個符合條件的道具嗎？`, () => {
                    const salvageIds = itemsToSalvage.map(i => i.uniqueId);
                    const originalCount = player.inventory.length + player.lootWarehouse.length;

                    player.inventory = player.inventory.filter(item => !salvageIds.includes(item.uniqueId));
                    player.lootWarehouse = player.lootWarehouse.filter(item => !salvageIds.includes(item.uniqueId));

                    const salvagedCount = originalCount - (player.inventory.length + player.lootWarehouse.length);
                    
                    savePlayerData();
                    renderInventory();
                    soundManager.play('break');
                    showModal(`成功回收了 ${salvagedCount} 個道具！`, null, true);
                });
            }, 100);
        }
        
        let bossCooldownInterval = null; // 用於儲存計時器ID

        function handleChallengeBoss() {
            const boss = bossStages[player.bossSystem.currentStageIndex];
            if (!boss || player.bossSystem.currentBossHp <= 0) {
                soundManager.play('wrong');
                showModal("當前沒有可以挑戰的Boss！", null, true);
                return;
            }

            const { strength, stamina, agility, intelligence } = player.totalStats;
            const { steps, calories, sleep, water } = player.bossDamageData.total; // ⭐⭐ BUG修復點 #3：使用 total 數據計算傷害 ⭐⭐

            const strBonus = strength * 0.005;
            const staBonus = stamina * 0.005;
            const agiBonus = agility * 0.005;
            const intBonus = intelligence * 0.005;

            const caloriesDmg = Math.floor(calories * 2 * (1 + strBonus));
            const stepsDmg = Math.floor(steps * 0.1 * (1 + staBonus)); // 調整步數傷害公式
            const sleepDmg = Math.floor(sleep * 1000 * (1 + agiBonus));
            const waterDmg = Math.floor((water / 500) * 2000 * (1 + intBonus));
            
            const totalDamage = caloriesDmg + stepsDmg + sleepDmg + waterDmg;

            if (totalDamage <= 0) {
                soundManager.play('wrong');
                showModal("你還沒有累積任何健康行為，無法對Boss造成傷害！\n快去動一動吧！", null, true);
                return;
            }

            player.bossSystem.currentBossHp = Math.max(0, player.bossSystem.currentBossHp - totalDamage);
            
             // ⭐⭐ BUG修復點 #4：重置所有傷害數據，而不僅僅是 manual ⭐⭐
            player.bossDamageData = { 
                manual: { steps: 0, calories: 0, sleep: 0, water: 0 },
                device: { steps: 0, calories: 0, sleep: 0, water: 0 },
                total: { steps: 0, calories: 0, sleep: 0, water: 0 }
            };
            soundManager.play('hit');
            showModal(`你燃燒了你的健康能量，對Boss造成了 ${totalDamage} 點毀滅性傷害！`, null, true);

            if (player.bossSystem.currentBossHp <= 0) {
                const defeatedBoss = boss;
                const loot = generateBossLoot(defeatedBoss);
                player.lootWarehouse.push(...loot);

                const defeatedBossStage = defeatedBoss.stage;
                if (!player.bossHistory[defeatedBossStage]) {
                    player.bossHistory[defeatedBossStage] = { defeated: 0 };
                }
                player.bossHistory[defeatedBossStage].defeated++;
                soundManager.play('win');
                setTimeout(() => {
                    soundManager.play('win');
                    showModal(`太強了！你擊敗了【${defeatedBoss.name}】！\n\n獲得了 ${loot.length} 件戰利品，已存入討伐倉庫！`, null, true);
                }, 500);
                
                player.bossSystem.currentStageIndex++;
                if (player.bossSystem.currentStageIndex >= bossStages.length) {
                    player.bossSystem.lastBossDefeatTime = Date.now();
                } else {
                    const nextBoss = bossStages[player.bossSystem.currentStageIndex];
                    player.bossSystem.currentBossHp = nextBoss.hp;
                }    
            }
            updateTaskProgress();
            savePlayerData();
            updateAllUI();
        }

        function generateBossLoot(boss) {
            const loot = [];
            const rates = bossLootDropRates[boss.stage];
            const possibleItems = masterItemList.filter(item => item.bossSource === boss.stage);

            for (let i = 0; i < boss.rewardCount; i++) {
                const rand = Math.random() * 100;
                let cumulative = 0;
                let rarity;
                for (const r in rates) {
                    cumulative += rates[r];
                    if (rand < cumulative) {
                        rarity = r;
                        break;
                    }
                }
                
                const itemsOfRarity = possibleItems.filter(item => item.rarity === rarity);
                if (itemsOfRarity.length > 0) {
                    const baseItem = itemsOfRarity[Math.floor(Math.random() * itemsOfRarity.length)];
                    const newItem = JSON.parse(JSON.stringify(baseItem));
                    player.itemCounter++;
                    newItem.uniqueId = `BSL${player.itemCounter.toString().padStart(6, '0')}`;
                    newItem.timestamp = Date.now();
                    newItem.isFavorite = false;
                    loot.push(newItem);
                    // [新增] 將獲得的戰利品加入圖鑑
                    if (!player.codex.includes(newItem.id)) {
                        player.codex.push(newItem.id);
                    }
                }
            }
            return loot;
        }

        function updateBossScreenUI() {
            clearInterval(bossCooldownInterval); // 先清除舊的計時器

            const ONE_DAY_MS = 24 * 60 * 60 * 1000;
            const lastDefeatTime = player.bossSystem.lastBossDefeatTime;
            const timeSinceDefeat = lastDefeatTime ? Date.now() - lastDefeatTime : ONE_DAY_MS + 1;

            const bossInfoCard = document.getElementById('boss-info-card');
            const tacticalAnalyzer = document.getElementById('tactical-analyzer');

            if (lastDefeatTime && timeSinceDefeat < ONE_DAY_MS) {
                // 進入冷卻時間
                bossInfoCard.style.textAlign = 'center';
                tacticalAnalyzer.style.display = 'none';

                const updateCooldown = () => {
                    const remainingTime = ONE_DAY_MS - (Date.now() - lastDefeatTime);
                    if (remainingTime <= 0) {
                        player.bossSystem.currentStageIndex = 0;
                        player.bossSystem.currentBossHp = bossStages[0].hp;
                        player.bossSystem.lastBossDefeatTime = null;
                        savePlayerData();
                        updateBossScreenUI();
                        clearInterval(bossCooldownInterval);
                        return;
                    }
                    const hours = Math.floor(remainingTime / (1000 * 60 * 60));
                    const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);
                    
                    bossInfoCard.innerHTML = `
                        <h3><i class="ph-fill ph-timer"></i> Boss正在休養生息</h3>
                        <div id="boss-icon" style="font-size: 80px;">😴</div>
                        <p>距離下一次入侵還有：</p>
                        <h2 style="margin: 5px 0;">${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}</h2>
                        <p id="boss-quote" ; color: var(--text-color-light); margin-top: 10px;">"我...我還會回來的！...大概吧。"</p>
                    `;
                };

                updateCooldown();
                bossCooldownInterval = setInterval(updateCooldown, 1000);

            } else {
                const boss = bossStages[player.bossSystem.currentStageIndex];
                if (!boss) {
                    bossInfoCard.innerHTML = '<h3><i class="ph-fill ph-crown"></i> 恭喜！</h3><p>所有Boss都已被你擊敗！你是真正的健康勇者！</p>';
                    tacticalAnalyzer.style.display = 'none';
                    return;
                }

                tacticalAnalyzer.style.display = 'block';
                const hpPercent = (player.bossSystem.currentBossHp / boss.hp) * 100;
                

                bossInfoCard.innerHTML = `
                    <p id="boss-stage">階段 ${boss.stage} <button id="boss-info-btn" class="info-btn" style="font-size: 20px;"><i class="ph-fill ph-info"></i></button></p>

                    <div id="boss-icon" class="active">${boss.icon}</div> 

                    <h3 id="boss-name" style="justify-content: center; border: none; margin-bottom: 5px;">${boss.name}</h3>
                    <div id="boss-hp-bar-container"><div id="boss-hp-bar" style="width: ${hpPercent}%;"></div></div>
                    <p id="boss-hp-text">${player.bossSystem.currentBossHp} / ${boss.hp}</p>
                    <p id="boss-quote">"${boss.quote}"</p>
                    <button id="challenge-boss-btn" class="primary-button">挑戰!</button>
                `;
                bossInfoCard.querySelector('#boss-info-btn').addEventListener('click', showBossLootInfo);
                bossInfoCard.querySelector('#challenge-boss-btn').addEventListener('click', handleChallengeBoss);
                bossInfoCard.querySelector('#challenge-boss-btn').disabled = player.bossSystem.currentBossHp <= 0;
                
                updateTacticalAnalyzerUI();
            }
            renderLootWarehouse();
        }

        function showBossLootInfo() {
            const boss = bossStages[player.bossSystem.currentStageIndex];
            if (!boss) return;

            const rates = bossLootDropRates[boss.stage];
            const modalContentEl = document.getElementById('boss-loot-info-content');
            const modalTitleEl = document.getElementById('boss-loot-info-title');

            modalTitleEl.textContent = `【${boss.name}】掉落率`;

            let contentHTML = '<table class="chest-probability-table" style="width: 100%;">';
            for (const rarityKey in rates) {
                const rate = rates[rarityKey];
                const rarityInfo = bossRarityConfig[rarityKey];
                if (rate > 0 && rarityInfo) {
                    contentHTML += `
                        <tr>
                            <td style="color: ${rarityInfo.color}; font-weight: bold;">${rarityInfo.name}</td>
                            <td style="text-align: right;">${rate}%</td>
                        </tr>
                    `;
                }
            }
            contentHTML += '</table>';
            
            modalContentEl.innerHTML = contentHTML;
            document.getElementById('boss-loot-info-modal').classList.add('active');
        }

        function renderLootWarehouse() {
            const grid = document.getElementById('boss-loot-grid');
            grid.innerHTML = '';
            if (player.lootWarehouse.length === 0) {
                grid.innerHTML = '<p>這裡空空如也......\n去擊敗Boss獲得戰利品吧！</p>';
                return;
            }
            player.lootWarehouse.forEach(item => {
                const itemContainer = document.createElement('div');
                itemContainer.className = 'loot-item-container';
                const card = createItemCard(item);
                card.style.width = '80px';
                card.style.height = '80px';
                card.querySelector('.item-icon').style.fontSize = '32px';

                itemContainer.innerHTML = `
                    ${card.outerHTML}
                    <div class="loot-item-actions">
                        <button class="loot-action-btn store" data-id="${item.uniqueId}">放入倉庫</button>
                        <button class="loot-action-btn salvage" data-id="${item.uniqueId}">回收</button>
                    </div>
                `;
                grid.appendChild(itemContainer);
            });

            grid.querySelectorAll('.loot-action-btn.store').forEach(btn => {
                btn.addEventListener('click', (e) => handleMoveToInventory(e.currentTarget.dataset.id));
            });
            grid.querySelectorAll('.loot-action-btn.salvage').forEach(btn => {
                btn.addEventListener('click', (e) => handleSalvageFromLoot(e.currentTarget.dataset.id));
            });
        }
        
        function handleMoveToInventory(uniqueId) {
            const itemIndex = player.lootWarehouse.findIndex(i => i.uniqueId === uniqueId);
            if (itemIndex === -1) return; // 如果找不到道具就直接結束

            //  關鍵修正！第一步：先檢查主倉庫容量 
            if (player.inventory.length >= 150) {
                soundManager.play('wrong');
                showModal("道具倉庫已滿，無法將戰利品移入！", null, true);
                return; // 容量滿了，就直接提示並結束，不做任何事
            }

            // 第二步：容量足夠，才執行道具的移動 
            // 從討伐倉庫取出道具
            const [item] = player.lootWarehouse.splice(itemIndex, 1);
            // 將道具放入主倉庫
            player.inventory.push(item);
            
            // 第三步：儲存進度並更新畫面 
            savePlayerData();
            renderLootWarehouse(); // 重新渲染討伐倉庫
            soundManager.play('success');
            showModal(`已將【${item.name}】移至道具倉庫！`, null, true);
        }

        function handleSalvageFromLoot(uniqueId) {
            const item = player.lootWarehouse.find(i => i.uniqueId === uniqueId);
            if (item) {
                soundManager.play('level');
                showModal(`確定要回收討伐倉庫中的【${item.name}】嗎？此操作無法復原。`, () => {
                    player.lootWarehouse = player.lootWarehouse.filter(i => i.uniqueId !== uniqueId);
                    savePlayerData();
                    renderLootWarehouse();
                    soundManager.play('break');
                    showModal(`已回收【${item.name}】。`, null, true);
                });
            }
        }

        function updateTacticalAnalyzerUI() {
            const analyzerTextEl = document.getElementById('analyzer-text');
            if (!analyzerTextEl) return;

            const { strength, stamina, agility, intelligence } = player.totalStats;
            const { steps, calories, sleep, water } = player.bossDamageData.total;

            const strBonus = strength * 0.005;
            const staBonus = stamina * 0.005;
            const agiBonus = agility * 0.005;
            const intBonus = intelligence * 0.005;

            const caloriesDmg = Math.floor(calories * 2 * (1 + strBonus));
            const stepsDmg = Math.floor(steps * 0.1 * (1 + staBonus)); // 調整步數傷害公式
            const sleepDmg = Math.floor(sleep * 1000 * (1 + agiBonus));
            const waterDmg = Math.floor((water / 500) * 2000 * (1 + intBonus));
            
            const totalDamage = caloriesDmg + stepsDmg + sleepDmg + waterDmg;

            analyzerTextEl.innerHTML = `
                <p>卡路里傷害: (${calories} x 2) * (1 + ${strength.toFixed(0)} * 0.5%) = <span class="formula">${caloriesDmg}</span></p>
                <p>步數傷害: (${steps} x 0.1) * (1 + ${stamina.toFixed(0)} * 0.5%) = <span class="formula">${stepsDmg}</span></p>
                <p>睡眠傷害: (${sleep}h x 1000) * (1 + ${agility.toFixed(0)} * 0.5%) = <span class="formula">${sleepDmg}</span></p>
                <p>飲水傷害: (${water}ml / 500 * 2000) * (1 + ${intelligence.toFixed(0)} * 0.5%) = <span class="formula">${waterDmg}</span></p>
                <div class="total-damage">預計總傷害: ${totalDamage}</div>
            `;
        }

        // 博物館渲染功能
        function renderMuseum() {
            const grid = document.getElementById('museum-display-case-grid');
            grid.innerHTML = '';
            
            for (const slotId in player.museumSlots) {
                const item = player.museumSlots[slotId];
                const displayCase = document.createElement('div');
                displayCase.className = 'display-case';

                if (item) {
                    const itemWrapper = createItemCard(item);
                    const namePlaque = document.createElement('div');
                    namePlaque.className = 'item-name-plaque';
                    namePlaque.innerHTML = `<div class="item-name">${item.name}</div>`;

                    displayCase.appendChild(itemWrapper);
                    displayCase.appendChild(namePlaque); // 將銘牌加到展示櫃中

                    displayCase.addEventListener('click', () => showItemDetails(item, false, false, slotId, true));
                } else {
                    displayCase.classList.add('empty');
                    displayCase.innerHTML = `<i class="ph-fill ph-plus-circle"></i>`;
                    displayCase.addEventListener('click', () => openMuseumPlacementModal(slotId));
                }
                grid.appendChild(displayCase);
            }
            updateMuseumBonusText();
        }

        function updateMuseumBonusText() {
            const container = document.getElementById('museum-bonus-text');
            container.innerHTML = '';
            let contentHTML = '';

            // 計算蒐藏品加成 (這部分不變)
            let museumMultipliers = { strength: 1, stamina: 1, agility: 1, intelligence: 1, luck: 1 };
            let hasMuseumBonus = false;
            for (const slot in player.museumSlots) {
                const item = player.museumSlots[slot];
                if (item && item.effects && item.effects.museum_bonus) {
                    for (const stat in item.effects.museum_bonus) {
                        if (museumMultipliers.hasOwnProperty(stat)){
                            museumMultipliers[stat] += item.effects.museum_bonus[stat];
                            hasMuseumBonus = true;
                        }
                    }
                }
            }
            if(hasMuseumBonus){
                contentHTML += '<div class="bonus-category"><h4><i class="ph-fill ph-bank"></i> 蒐藏品加成</h4><div class="bonus-stats">';
                for (const stat in museumMultipliers) {
                    if (Math.abs(museumMultipliers[stat] - 1) > 1e-5) {
                         const bonusValue = ((museumMultipliers[stat] - 1) * 100).toFixed(1);
                         const translatedStat = statTranslations[stat] || stat;
                         contentHTML += `<div class="bonus-stat-item"><span>${translatedStat}</span><span class="bonus-value">${bonusValue > 0 ? '+' : ''}${parseFloat(bonusValue)}%</span></div>`;
                    }
                }
                contentHTML += '</div></div>';
            }

            // 計算稱號加成
            let titleBonus = null;
            if (player.equippedTitle && titleData && titleData[player.equippedTitle]) {
                titleBonus = titleData[player.equippedTitle].bonus;
            }
            if(titleBonus){
                contentHTML += '<div class="bonus-category"><h4><i class="ph-fill ph-star"></i> 稱號加成</h4><div class="bonus-stats">';
                for (const stat in titleBonus) {
                    if (titleBonus[stat] > 0) {
                         const bonusValue = (titleBonus[stat] * 100).toFixed(1);
                         const translatedStat = statTranslations[stat] || stat;
                         contentHTML += `<div class="bonus-stat-item"><span>${translatedStat}</span><span class="bonus-value">+${parseFloat(bonusValue)}%</span></div>`;
                    }
                }
                contentHTML += '</div></div>';
            }

            if(contentHTML === '') {
                contentHTML = "尚未有加成效果。";
            }
            
            container.innerHTML = contentHTML;
        }

        function openMuseumPlacementModal(slotId) {
            const availableCollectibles = [...player.inventory, ...player.lootWarehouse].filter(i => i.type === '蒐藏品');
            if (availableCollectibles.length === 0) {
                soundManager.play('wrong');
                showModal("你沒有可放置的蒐藏品！", null, true);
                return 
            }

            const modal = document.getElementById('museum-placement-modal');
            const grid = document.getElementById('museum-placement-grid');
            grid.innerHTML = ''; // 清空舊內容

            availableCollectibles.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'museum-selection-item';
                itemEl.innerHTML = `
                    ${createItemCard(item).outerHTML}
                    <p>${item.name}</p>
                `;
                itemEl.onclick = () => {
                    handlePlaceInMuseum(item.uniqueId, slotId);
                    hideModal('museum-placement-modal');
                };
                grid.appendChild(itemEl);
            });
            
            modal.querySelector('.cancel').onclick = () => hideModal('museum-placement-modal');
            modal.classList.add('active');
        }

        // 檢查機制，如果道具已在博物館中，會跳出提示。
        // 程式碼功能說明: 請求將道具放入博物館
        function handlePlaceInMuseumRequest(item) {
            const isAlreadyInMuseum = Object.values(player.museumSlots).some(slotItem => slotItem && slotItem.uniqueId === item.uniqueId);

            if (isAlreadyInMuseum) {
                // 先關閉目前的道具資訊視窗
                hideModal('item-details-modal');
                // 加一個極短的延遲，讓UI過渡更自然
                setTimeout(() => {
                    soundManager.play('wrong');
                    showModal(`【${item.name}】已經在博物館裡展示了！\n你可以在博物館頁面將它取下。`, null, true);
                }, 100);
                return; 
            }

            // ... 後續程式碼保持不變 ...
            const emptySlot = Object.keys(player.museumSlots).find(slot => player.museumSlots[slot] === null);
            if (!emptySlot) {
                soundManager.play('wrong');
                showModal("博物館展示櫃已滿！", null, true);
                return;
            }
            hideModal('item-details-modal');
            setTimeout(() => {
                    soundManager.play('level');
                    showModal(`確定要將【${item.name}】放入博物館嗎？`, () => {
                    handlePlaceInMuseum(item.uniqueId, emptySlot);
                 });
            }, 100);
        }
        // 程式碼功能說明: 將道具放入博物館
        function handlePlaceInMuseum(itemUniqueId, slotId) {
            let itemIndex = player.inventory.findIndex(i => i.uniqueId === itemUniqueId);
            let itemSource = player.inventory;

            if (itemIndex === -1) {
                itemIndex = player.lootWarehouse.findIndex(i => i.uniqueId === itemUniqueId);
                itemSource = player.lootWarehouse;
            }

            if (itemIndex > -1) {
                // 從來源倉庫(道具或討伐)中移除該道具
                const [item] = itemSource.splice(itemIndex, 1);
                
                // 將完整的道具物件存入博物館欄位！
                player.museumSlots[slotId] = item; 
                soundManager.play('shine');
                savePlayerData();
                updateAllUI();
                showModal(`已將【${item.name}】成功放置到展示櫃！`, null, true);
            }
        }
        
        // 程式碼功能說明: 從博物館取下道具
        // 將原來的道具物件完整地移回道具倉庫。
        function handleRemoveFromMuseum(slotId) {
            // [核心修正] 直接從博物館欄位取得完整的道具物件
            const itemToReturn = player.museumSlots[slotId]; 
            if (!itemToReturn) return;
            soundManager.play('level');
            showModal(`確定要從展示櫃取下【${itemToReturn.name}】嗎？能力加成將會失效。`, () => {
                // 步驟 1: 清空博物館的欄位
                player.museumSlots[slotId] = null; 
                
                // 步驟 2: 將原始的、帶有正確 uniqueId 的道具物件加回道具倉庫
                player.inventory.push(itemToReturn); 
                
                // 步驟 3: 儲存進度、更新UI
                soundManager.play('down');
                savePlayerData();
                updateAllUI();
                showModal(`已取下【${itemToReturn.name}】，並將其放回道具倉庫。`, null, true);
            });
        }
        // --- AI 助手系統 核心功能 ---
        function addMessageToChat(sender, text) {
            const chatWindow = document.getElementById('chat-window');
            const messageEl = createChatMessageElement(sender, text);
            chatWindow.appendChild(messageEl);

            // 關鍵指令：在新增訊息後，立刻將捲動條拉到最底部！
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
        // 功能解說: 現在這個函式只在載入頁面時被呼叫一次，用來初始化對話紀錄。
        function renderAssistantUI() {
            if (!player.assistant) return;
            document.getElementById('assistant-name-title').textContent = player.assistant.name;
            const chatWindow = document.getElementById('chat-window');
            chatWindow.innerHTML = ''; // 依然需要清空，以防重複渲染

            player.assistant.chatHistory.forEach(msg => {
                // 注意：這裡我們只建立元素，但不呼叫新的 addMessageToChat，避免重複捲動
                const messageEl = createChatMessageElement(msg.sender, msg.text);
                chatWindow.appendChild(messageEl);
            });

            // 在全部渲染完後，做一次最終的捲動
            setTimeout(() => {
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }, 0);
        }

        function createChatMessageElement(sender, text) {
            const messageEl = document.createElement('div');
            messageEl.className = `chat-message ${sender}`;
            
            const avatarEl = document.createElement('div');
            avatarEl.className = 'chat-avatar';

            if (sender === 'user') {
                 if (player.avatar.startsWith('data:image/')) {
                    avatarEl.innerHTML = `<img src="${player.avatar}" alt="P">`;
                } else {
                    avatarEl.textContent = player.avatar;
                }
            } else {
                avatarEl.textContent = '🤖';
            }
            
            const bubbleEl = document.createElement('div');
            bubbleEl.className = 'chat-bubble';
            bubbleEl.textContent = text;
            
            messageEl.appendChild(avatarEl);
            messageEl.appendChild(bubbleEl);
            return messageEl;
        }

        async function handleSendMessage() {
            const input = document.getElementById('chat-input');
            const userInput = input.value.trim();
            if (!userInput) return;

            player.assistant.chatHistory.push({ sender: 'user', text: userInput });
            addMessageToChat('user', userInput);
            input.value = '';
            savePlayerData();

            // 顯示一個「思考中」的氣泡，提升體驗
            const thinkingBubble = createChatMessageElement('ai', '思考中...');
            thinkingBubble.querySelector('.chat-bubble').style.opacity = '0.7';
            document.getElementById('chat-window').appendChild(thinkingBubble);
            document.getElementById('chat-window').scrollTop = document.getElementById('chat-window').scrollHeight;

            // 等待 Gemini 的回應
            const aiResponse = await generateAiResponse(userInput);
            
            // 移除「思考中」的氣泡
            thinkingBubble.remove();
            
            player.assistant.chatHistory.push({ sender: 'ai', text: aiResponse });
            addMessageToChat('ai', aiResponse);
            savePlayerData();
        }

        async function generateAiResponse(userInput) {
            const playerContext = `
                這是你正在互動的玩家資料：
                - 玩家名稱: ${player.name}
                - 等級: ${player.level}
                - 職業: ${player.professionId}
                - 力量: ${Math.floor(player.totalStats.strength)}, 耐力: ${Math.floor(player.totalStats.stamina)}, 敏捷: ${Math.floor(player.totalStats.agility)}, 智力: ${Math.floor(player.totalStats.intelligence)}, 運氣: ${Math.floor(player.totalStats.luck)}
                - 今日步數: ${player.todayData.total.steps}, 今日消耗大卡: ${player.todayData.total.calories}
            `;

        try {
            // 使用 fetch API 向我們的後端伺服器發送請求
            const response = await fetch('/api/chat', {
                method: 'POST', // 使用 POST 方法
                headers: {
                    'Content-Type': 'application/json', // 告訴伺服器我們發送的是 JSON
                },
                // 將使用者輸入和玩家情境打包成 JSON 字串傳送
                body: JSON.stringify({ 
                    userInput: userInput,
                    playerContext: playerContext 
                }),
            });

            // 如果伺服器回應不成功，就拋出錯誤
            if (!response.ok) {
                throw new Error(`伺服器錯誤: ${response.statusText}`);
            }

            // 解析伺服器回傳的 JSON 資料
            const data = await response.json();
            return data.response; // 回傳 AI 的回覆內容

        } catch (error) {
            console.error("呼叫後端伺服器時出錯:", error);
            return "開發者很窮...  只能蹭免費版Gemini 1.5 flash ,所以我沒壞掉只是流量塞車爆炸了😩不是我笨不會回🥹       （他就算恢復了也一樣笨....by.開發者";
        }
    }

        // 程式碼功能說明: 處理 AI 夥伴改名請求 
        function handleRenameAssistantRequest() {
            const TWO_WEEKS_MS = 14 * 24 * 60 * 60 * 1000;
            const now = Date.now();
            
            const recentChanges = (player.assistant.nameChangeHistory || []).filter(timestamp => (now - timestamp) < TWO_WEEKS_MS);

            if (recentChanges.length >= 2) {
                soundManager.play('wrong');
                showModal(`你最近幫夥伴改名太頻繁囉！\n兩週內只能改兩次。`, null, true);
                return 
            }

            // 1. 取得我們新的各個元件
            const modal = document.getElementById('rename-assistant-modal');
            const input = document.getElementById('new-assistant-name');
            const confirmBtn = modal.querySelector('.confirm');
            const cancelBtn = modal.querySelector('.cancel');

            // 2. 在輸入框中填入夥伴的現有名字
            input.value = player.assistant.name.replace('🤖','');
            
            // 3. 設定「確認」按鈕的功能
            confirmBtn.onclick = () => {
                const newName = input.value.trim();
                if (!newName) {
                    soundManager.play('wrong');
                    showModal("夥伴的新名字不能是空的喔！", null, true);
                    return 
                }
                if (newName.length > 10) {
                    soundManager.play('wrong');
                    showModal("名字太長了啦，請勿超過10個字！", null, true);
                    return 
                }
                
                player.assistant.name = newName + '🤖';
                player.assistant.nameChangeHistory.push(now);
                
                hideModal('rename-assistant-modal');
                savePlayerData();
                updateAllUI();
                renderAssistantUI(); // 更新助手介面的標題
                soundManager.play('success');
                setTimeout(() => showModal('夥伴改名成功！', null, true), 100);
            };

            // 4. 設定「取消」按鈕的功能
            cancelBtn.onclick = () => {
                hideModal('rename-assistant-modal');
            };

            // 5. 展示出來！
            modal.classList.add('active');
        }

        // ✨ 新功能 1：打開「頭像更換選項」的總機函式 ✨
    function openAvatarChoiceModal() {
        const modal = document.getElementById('avatar-choice-modal');

        modal.querySelector('#btn-upload-avatar').onclick = () => {
            hideModal('avatar-choice-modal');
            document.getElementById('avatar-upload').click();
        };

        modal.querySelector('#btn-select-default-avatar').onclick = () => {
            hideModal('avatar-choice-modal');
            setTimeout(openDefaultAvatarModal, 100);
        };

        modal.querySelector('#btn-cancel-avatar-choice').onclick = () => {
            hideModal('avatar-choice-modal');
        };

        modal.classList.add('active');
    }

        // 打開預設頭像選擇視窗 
        function openDefaultAvatarModal() {
            const modal = document.getElementById('default-avatar-modal');
            const grid = document.getElementById('default-avatar-grid');
            grid.innerHTML = '';

            DEFAULT_AVATARS.forEach(emoji => {
                const option = document.createElement('div');
                option.className = 'avatar-option';
                option.textContent = emoji;
                option.addEventListener('click', () => {
                    selectDefaultAvatar(emoji);

                    hideModal('default-avatar-modal');
                });
                grid.appendChild(option);
            });

            modal.querySelector('.cancel').onclick = () => hideModal('default-avatar-modal');
            modal.classList.add('active');
        }

        // 選擇並更新預設頭像 
        function selectDefaultAvatar(selectedEmoji) {
            player.avatar = selectedEmoji;
            player.isCustomAvatar = false;

            savePlayerData();
            updateAllUI();
            soundManager.play('success');
            showModal("頭像更換成功！", null, true);
        }


        //--- 命運拉霸G系統 核心功能 ---

        function getDefaultDinerData() {
            return {
                '早餐': ['蛋餅', '飯糰', '總匯三明治', '卡拉雞腿堡', '吐司厚片', '蘿蔔糕', '鐵板麵', '漢堡', '燒餅油條', '稀飯'],
                '午餐': ['便當', '牛肉麵', '滷肉飯', '咖哩飯', '水餃', '炒飯', '義大利麵', '拉麵', '壽司', '火鍋'],
                '晚餐': ['牛排', '麻辣燙', '熱炒', '披薩', '韓式炸雞', '酸菜魚', '烤肉', '海鮮粥', '雞肉飯', '關東煮'],
                '點心': ['雞排', '珍珠奶茶', '紅豆餅', '章魚燒', '可麗餅', '甜甜圈', '蛋糕', '冰淇淋', '豆花', '地瓜球'],
                '飲料': ['紅茶', '綠茶', '奶茶', '咖啡', '果汁', '烏龍茶', '可樂', '氣泡水', '手搖飲', '豆漿'],
                '宵夜': ['鹽酥雞', '臭豆腐', '滷味', '泡麵', '串燒', '鹹水雞', '涼麵', '蚵仔煎', '肉圓', '刈包'],
            };
        }

        function renderDinerUI() {
            const categoryContainer = document.getElementById('diner-category-selector');

            // ✨ 強化穩定性的檢查！ ✨
            // 如果 dinerData 不存在，或是裡面沒有任何類別
            if (!dinerData || Object.keys(dinerData).length === 0) {
                console.warn("偵測到空的菜單資料，正在從預設值恢復...");
                dinerData = getDefaultDinerData(); // 從預設函式取回資料
                player.dinerData = dinerData; // 同步回玩家物件
                savePlayerData(); // 儲存修正後的資料
            }

            categoryContainer.innerHTML = '';
            for (const category in dinerData) {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.textContent = category;
                btn.dataset.category = category;
                btn.onclick = () => selectDinerCategory(category);
                categoryContainer.appendChild(btn);
            }

            if (currentDinerCategory && dinerData[currentDinerCategory]) {
                selectDinerCategory(currentDinerCategory);
            } else {
                // 如果沒有預選類別，或預選的類別已不存在，則重置按鈕狀態
                document.getElementById('diner-spin-btn').disabled = true;
                document.getElementById('diner-spin-btn').textContent = `先選個類別吧！`;
            }

                }

        function selectDinerCategory(category) {
            currentDinerCategory = category;
            
            document.querySelectorAll('#diner-category-selector .category-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.category === category);
            });
            
            populateReel(dinerData[category]);
            document.getElementById('diner-spin-btn').disabled = false;
            document.getElementById('diner-spin-btn').textContent = `使用拉霸G來決定今的的${category}😋😋!!！`;
        }
        
        function populateReel(items) {
            const reel = document.getElementById('diner-reel');
            reel.style.transition = 'none'; // 先取消動畫
            reel.style.transform = 'translateY(0)'; // 回到原點
            reel.innerHTML = '';

            // 為了讓動畫看起來更真實，我們重複列表多次
            const repeatedItems = [...items, ...items, ...items, ...items, ...items, ...items, ...items, ...items, ...items, ...items, ...items, ...items, ...items, ...items];
            repeatedItems.forEach(item => {
                const reelItem = document.createElement('div');
                reelItem.className = 'reel-item';
                reelItem.textContent = item;
                reel.appendChild(reelItem);
            });
        }

        function spinDiner() {
                if (!currentDinerCategory) return;
                soundManager.play('reel_spin');

                const btn = document.getElementById('diner-spin-btn');
                btn.disabled = true;

                const items = dinerData[currentDinerCategory];
                const reel = document.getElementById('diner-reel');
                const itemHeight = 50;

                // ✨--- 核心修正：動畫重置流程 ---✨
                // 步驟 1: 先瞬間取消動畫效果，並將滾輪拉回頂部
                reel.style.transition = 'none';
                reel.style.transform = 'translateY(0)';

                // 步驟 2: 使用 setTimeout 技巧，強制瀏覽器先完成上面的重置操作
                setTimeout(() => {
                    // 步驟 3: 現在可以安全地開始新的動畫了！
                    const randomIndex = Math.floor(Math.random() * items.length);
                    const targetItem = items[randomIndex];

                    // 轉很多圈的計算公式
                    const targetPosition = (items.length * 5) + randomIndex;
                    const spinDistance = -(targetPosition * itemHeight - (150 - itemHeight) / 2);

                    // 設定本次的轉動動畫
                    reel.style.transition = 'transform 4s cubic-bezier(0.25, 1, 0.5, 1)';
                    reel.style.transform = `translateY(${spinDistance}px)`;

                    // 設定等待結果的時間
                    setTimeout(() => {
                        btn.disabled = false;
                        soundManager.play('success');
                        showModal(`就決定今天${currentDinerCategory}吃【${targetItem}】\n 🤤🤤🤤！！`, null, true);
                    }, 3500); 

                }, 20); // 給予一個極短的延遲即可
            }

        // --- 編輯功能 ---
        function openEditDinerModal() {
            if (!currentDinerCategory) {
                soundManager.play('wrong');
                showModal('請先選擇一個要編輯的餐點類別！', null, true);
                return;
            }
            document.getElementById('edit-diner-category-title').textContent = currentDinerCategory;
            renderEditableDinerList(currentDinerCategory);
            document.getElementById('edit-diner-modal').classList.add('active');
        }

        function renderEditableDinerList(category) {
            const listContainer = document.getElementById('edit-diner-list');
            listContainer.innerHTML = '';
            dinerData[category].forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'edit-list-item';
                div.innerHTML = `
                    <span>${item}</span>
                    <button data-index="${index}"><i class="ph-fill ph-trash"></i></button>
                `;
                listContainer.appendChild(div);
            });

            // 綁定刪除事件
            listContainer.querySelectorAll('button').forEach(btn => {
                btn.onclick = () => {
                    dinerData[category].splice(btn.dataset.index, 1);
                    player.dinerData = dinerData; // 同步回player物件
                    savePlayerData();
                    renderEditableDinerList(category); // 重新渲染
                };
            });
        }
        
        function addNewDinerItem() {
            const input = document.getElementById('add-diner-item-input');
            const newItem = input.value.trim();
            if (newItem && currentDinerCategory) {
                dinerData[currentDinerCategory].push(newItem);
                player.dinerData = dinerData;
                savePlayerData();
                renderEditableDinerList(currentDinerCategory);
                input.value = '';
            }
            else soundManager.play('wrong');
        }

        async function loadGameData() {}
            

        // 程式碼功能說明: 任務生成與每日重置核心
        function generateTasks() {
            const today = new Date().toDateString();

            // ✨ 規則 #2：當偵測到新的一天時，先重置「今日健康數據」
            if (player.tasks.lastGenerated !== today) {
                player.todayData = {
                    manual: { steps: 0, calories: 0, sleep: 0, water: 0 },
                    device: { steps: 0, calories: 0, sleep: 0, water: 0 },
                    total: { steps: 0, calories: 0, sleep: 0, water: 0 }
                };
                player.manualInputTracker = { steps: 0, calories: 0, sleep: 0, water: 0 };
                console.log("新的一天！今日健康數據已重置！");
            }

            // 如果今天已經生成過任務，就直接更新進度後返回
            if (player.tasks.lastGenerated === today) {
                if (document.getElementById('tasks-screen').classList.contains('active')) {
                    updateTaskProgress();
                }
                return;
            }

            // 清空舊的每日任務和職業任務
            player.tasks.daily = [];
            player.tasks.profession = [];
            
            for (const type in taskData.daily) {
                const taskPool = taskData.daily[type];
                if (taskPool && taskPool.length > 0) {
                    // 直接拿第一個任務 (index 0)
                    const task = { ...taskPool[0], type: type }; 
                    task.progress = 0;
                    task.claimed = false;
                    player.tasks.daily.push(task);
                }
            }
            const professionTaskPool = taskData.profession[player.professionId] || [];
            if (professionTaskPool.length > 0) {
                 // 直接拿第一個任務 (index 0)
                 const task = { ...professionTaskPool[0] };
                 task.progress = 0;
                 task.claimed = false;
                 player.tasks.profession.push(task);
            }

            // 初始化成就任務 (如果玩家是第一次)
            if (!player.tasks.achievements || player.tasks.achievements.length === 0) {
                 player.tasks.achievements = (taskData.achievement || []).map(t => ({...t, progress: 0, claimed: false}));
                 const profAchievements = taskData.professionAchievement[player.professionId] || [];
                 player.tasks.achievements.push(...profAchievements.map(t => ({...t, progress: 0, claimed: false})));
            }
            
            player.tasks.lastGenerated = today;
            savePlayerData();
            // 生成完新任務後，立刻更新一次進度！
            updateTaskProgress();
        }

        // 程式碼功能說明: 任務進度更新
        // 這個函式現在能看懂所有類型的任務，包括等級、特殊條件和職業成就！
        function updateTaskProgress() {
            if (!player.loggedIn || !player.tasks) return;
            
            let allTasks = [...(player.tasks.daily || []), ...(player.tasks.profession || []), ...(player.tasks.achievements || [])];
            
            allTasks.forEach(task => {
                if (task.claimed) return; 

                let currentProgress = 0;
                switch(task.type) {
                    case 'steps': 
                        currentProgress = player.todayData.total.steps; 
                        break;
                    case 'calories': 
                        currentProgress = player.todayData.total.calories; 
                        break;
                    case 'water': 
                        currentProgress = player.todayData.total.water; 
                        break;
                    case 'sleep': 
                        currentProgress = player.todayData.total.sleep; 
                        break;
                    case 'level': 
                        currentProgress = player.level; 
                        break;
                    case 'special':
                        if (task.id === 'A_G_07') { // 寶箱獵人
                            currentProgress = player.stats.chestsOpened || 0;
                        } else if (task.id === 'A_G_08') { // 魔王終結者
                            // ⭐⭐ BUG修復點 #6：使用正確的 bossHistory 結構來檢查 ⭐⭐
                            currentProgress = (player.bossHistory['5'] && player.bossHistory['5'].defeated > 0) ? 1 : 0;
                        } else if (task.id === 'A_G_09') { // 收藏家
                             // ⭐⭐ BUG修復點 #7：使用 player.codex 而不是不存在的 unlockedCodex ⭐⭐
                            currentProgress = player.codex.length || 0;
                        } else if (task.id === 'A_G_10') { // 天選之人 (檢查背包和倉庫)
                             // ⭐⭐ BUG修復點 #8：修正道具檢查範圍，包含所有玩家持有的道具 ⭐⭐
                            const allItems = [
                                ...player.inventory, 
                                ...player.lootWarehouse,
                                ...Object.values(player.equipment).filter(Boolean) // 把已裝備的也算進去
                            ];
                            currentProgress = allItems.some(item => item && (item.rarity === 'Divum' || item.rarity === '神諭')) ? 1 : 0;
                        }
                        break;
                }
                task.progress = Math.min(currentProgress, task.target);
            });
            
            // ⭐⭐ BUG修復點 #9：只在任務畫面才需要重新渲染，避免不必要的畫面刷新 ⭐⭐
            if (document.getElementById('tasks-screen').classList.contains('active')) {
                 renderTasksUI();
            }
            savePlayerData();
        }

        // 程式碼功能說明: 領取任務獎勵
        // 這個函式現在會採用「任務推進」機制，而不是「隨機補充」，徹底解決了任務無法結束和職業任務不刷新的問題。
        function claimTaskReward(task) {
            if (!task || task.progress < task.target || task.claimed) return;

            soundManager.play('success');

            // 步驟 1: 發放獎勵
            addXp(50);
            if (task.titleId && titleData[task.titleId]) {
                if (!player.unlockedTitles.includes(task.titleId)) {
                    player.unlockedTitles.push(task.titleId);
                }
                soundManager.play('success');
                showModal(`恭喜！你完成了成就【${task.desc}】，並獲得了稱號「${titleData[task.titleId].name}」！`, null, true);
            } else {
                const rewards = [];
                if (!task.id.startsWith('A_')) {
                    const item = generateRandomItem(null, ['消耗品', '裝備']);
                    addItemToInventory(item);
                    rewards.push(item);
                }
                soundManager.play('success');
                showModal(`任務完成！獲得 50 點經驗值！${rewards.length > 0 ? '\n\n獲得獎勵：\n- ' + rewards.map(r => r.name).join('\n- ') : ''}`, null, true);
            }

            // 步驟 2: 更新任務狀態為「已領取」
            task.claimed = true;

            // 步驟 3: 處理每日/職業任務的「線性推進」
            const isDailyTask = task.id.startsWith('D_');
            const isProfessionTask = task.id.startsWith('P_');

            if (isDailyTask || isProfessionTask) {
                // 決定要從哪個任務池和哪個玩家任務列表進行操作
                const taskPool = isDailyTask ? taskData.daily[task.type] : taskData.profession[player.professionId];
                const playerTaskList = isDailyTask ? player.tasks.daily : player.tasks.profession;

                // 找到剛完成的任務在「原始任務池」中的位置
                const completedTaskIndex = taskPool.findIndex(t => t.id === task.id);
                // 找到剛完成的任務在「玩家任務列表」中的位置
                const playerTaskIndex = playerTaskList.findIndex(t => t.id === task.id);
                
                // 從玩家列表中移除已完成的任務
                if (playerTaskIndex > -1) {
                    playerTaskList.splice(playerTaskIndex, 1);
                }

                // 檢查原始任務池中，是否還有下一個更高階的任務
                if (completedTaskIndex > -1 && completedTaskIndex < taskPool.length - 1) {
                    // 有！太棒了，把下一個任務加到玩家的任務列表中
                    const nextTaskData = taskPool[completedTaskIndex + 1];
                    const newTask = { ...nextTaskData, type: nextTaskData.type || task.type, progress: 0, claimed: false };
                    playerTaskList.push(newTask);
                }
                // 如果 completedTaskIndex 是最後一個了，就不會進入上面的 if，自然也就不會再補充新任務進來了！
            }
            
            // 步驟 4: 記錄完成歷史
            if (isDailyTask) {
                if (!player.taskHistory[task.id]) player.taskHistory[task.id] = { completed: 0, total: 0 };
                player.taskHistory[task.id].completed++;
            }

            // 步驟 5: 保存並刷新UI
            savePlayerData();
            updateAllUI(); // 更新主畫面等其他地方的資訊
            renderTasksUI(); // 重新渲染任務畫面
            if (document.getElementById('museum-screen').classList.contains('active')) {
                renderTitleSystemUI();
            }
            const taskButton = document.querySelector(`button.task-claim-btn[data-task-id="${taskId}"]`);
                if (taskButton) {
                    taskButton.disabled = true;
                    taskButton.textContent = '已領取';
                    taskButton.classList.add('claimed');
                }
        }

        
        // 數計時器更新函式 
        function updateCooldownTimer() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(now.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);

            const diff = tomorrow.getTime() - now.getTime();

            if (diff <= 0) {
                if (taskCooldownInterval) {
                    clearInterval(taskCooldownInterval);
                    taskCooldownInterval = null;
                }
                // 時間到！重置任務！
                generateTasks();
                renderTasksUI();
                return;
            }

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            const timerElement = document.getElementById('task-cooldown-timer');
            if(timerElement) {
                timerElement.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
        }

        // 任務渲染函式
        function renderTasksUI() {
            if (!player || !player.tasks) return;

            // --- 容器定義 ---
            const dailyContainer = document.getElementById('daily-tasks');
            const professionContainer = document.getElementById('profession-tasks');
            const achievementContainer = document.getElementById('achievement-tasks');
            const cooldownContainer = document.getElementById('task-cooldown-container');
            const dailyHeader = document.querySelector('h3[data-task-type="daily"]')?.parentElement.parentElement;
            const professionHeader = document.querySelector('h3[data-task-type="profession"]')?.parentElement;
            
            // --- 判斷每日/職業任務是否全部完成 ---
            const allDailyAndProfessionTasksDone = (!player.tasks.daily || player.tasks.daily.length === 0) && (!player.tasks.profession || player.tasks.profession.length === 0);

            if (allDailyAndProfessionTasksDone) {
                // 狀態：顯示冷卻畫面
                if(dailyHeader) dailyHeader.style.display = 'none';
                if(professionHeader) professionHeader.style.display = 'none';
                if(cooldownContainer) cooldownContainer.style.display = 'block';

                if (!taskCooldownInterval) {
                    updateCooldownTimer();
                    taskCooldownInterval = setInterval(updateCooldownTimer, 1000);
                }
            } else {
                // 狀態：正常顯示任務列表
                if(dailyHeader) dailyHeader.style.display = 'block';
                if(professionHeader) professionHeader.style.display = 'block';
                if(cooldownContainer) cooldownContainer.style.display = 'none';

                if (taskCooldownInterval) {
                    clearInterval(taskCooldownInterval);
                    taskCooldownInterval = null;
                }
                // 分別渲染每日和職業任務
                if(dailyContainer) dailyContainer.innerHTML = (player.tasks.daily || []).map(task => createTaskElement(task)).join('');
                if(professionContainer) professionContainer.innerHTML = (player.tasks.profession || []).map(task => createTaskElement(task)).join('');
            }
            
            // --- 核心修正：成就任務的渲染邏輯永遠獨立執行，不受上面影響！ ---
            if (achievementContainer) {
                let achievementList = player.tasks.achievements || [];
                achievementList = achievementList.filter(task => !task.claimed || showCompletedAchievements);
                achievementContainer.innerHTML = achievementList.map(task => createTaskElement(task)).join('');
            }

            // 為所有領取按鈕綁定事件
            document.querySelectorAll('.claim-btn').forEach(button => {
                const existingListener = button.onclick;
                if (!existingListener) { 
                    button.onclick = (e) => {
                        const taskId = e.currentTarget.dataset.taskId;
                        const allTasks = [...(player.tasks.daily || []), ...(player.tasks.profession || []), ...(player.tasks.achievements || [])];
                        const taskToClaim = allTasks.find(t => t.id === taskId);
                        if (taskToClaim) claimTaskReward(taskToClaim);
                    };
                }
            });
        }
        // 產生任務卡片HTML的函式 
        function createTaskElement(task) {
            const isCompleted = task.progress >= task.target;
            const progressPercent = Math.min((task.progress / task.target) * 100, 100);
            const circumference = 2 * Math.PI * 27; // SVG圓環的周長
            const offset = circumference - (progressPercent / 100) * circumference;

            const rewardIcon = task.titleId ? '🏆' : '🎁';

            return `
                <div class="task-item ${isCompleted ? 'completed' : ''}">
                    <div class="task-progress-ring">
                        <svg width="60" height="60" viewBox="0 0 60 60">
                            <circle cx="30" cy="30" r="27" stroke="var(--border-color)" stroke-width="4" fill="transparent" />
                            <circle class="progress-ring-circle" cx="30" cy="30" r="27" stroke="var(--primary-accent-color)" stroke-width="4" fill="transparent"
                                stroke-dasharray="${circumference}"
                                stroke-dashoffset="${isCompleted ? 0 : offset}"
                            />
                        </svg>
                        <div class="task-icon">${task.icon}</div>
                    </div>
                    <div class="task-info">
                        <div class="task-desc">${task.desc}</div>
                        <div class="task-progress-text">${task.progress} / ${task.target}</div>
                    </div>
                    <div class="task-rewards">
                        <div class="reward-preview">${rewardIcon}</div>
                        <button class="claim-btn" data-task-id="${task.id}" ${(!isCompleted || task.claimed) ? 'disabled' : ''}>
                            ${task.claimed ? '已領取' : '領取'}
                        </button>
                    </div>
                </div>
            `;
        }

        // 倒數計時器更新函式 
        function updateCooldownTimer() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(now.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);

            const diff = tomorrow.getTime() - now.getTime();

            const timerElement = document.getElementById('task-cooldown-timer');
            if (!timerElement) return;

            if (diff <= 0) {
                if (taskCooldownInterval) {
                    clearInterval(taskCooldownInterval);
                    taskCooldownInterval = null;
                }
                timerElement.textContent = "任務已刷新！";
                // 時間到！重置任務！
                generateTasks();
                renderTasksUI();
                return;
            }

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            timerElement.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // 稱號系統
        function renderTitleSystemUI() {

            
            // --- ✨ 究極進化版偵錯魔法 ✨ ---
            console.log('--- 稱號系統偵錯開始 ---');
            console.log('1. player 物件存在嗎？', player ? '✅ 是的' : '❌ 否');
            console.log('2. player.unlockedTitles 屬性是什麼？ ->', player.unlockedTitles);
            console.log('3. titleData 物件存在嗎？', titleData ? '✅ 是的' : '❌ 否');
            console.log('--- 偵錯結束 ---');

            // --- 加上終極保險 ---
            if (!player || !player.unlockedTitles) {
                console.error("💀 致命錯誤：player.unlockedTitles 屬性不存在！流程已中止，請檢查 player 物件的生成與載入過程。");
                const container = document.getElementById('title-list');
                if(container) container.innerHTML = '<p style="color: #F44336;">錯誤：無法載入稱號資料。</p>';
                return; // 直接中止，避免崩潰
            }

            const container = document.getElementById('title-list');
            if (!container) return; 
            container.innerHTML = '';

            // 直接遍歷玩家已解鎖的稱號陣列
            player.unlockedTitles.forEach(titleId => {
                const title = titleData[titleId];
                if (!title) return; 

                const isEquipped = player.equippedTitle === titleId;

                const titleEl = document.createElement('div');
                titleEl.className = `title-item unlocked`;

                let bonusString = Object.entries(title.bonus).map(([stat, val]) => {
                    const translatedStat = statTranslations[stat] || stat;
                    return `${translatedStat} +${(val * 100).toFixed(0)}%`;
                }).join(', ');

                titleEl.innerHTML = `
                    <div class="title-info">
                        <div class="title-name">${title.name}</div>
                        <div class="title-bonus">${bonusString}</div>
                    </div>
                    <button class="title-equip-btn ${isEquipped ? 'equipped' : ''}" data-title-id="${titleId}">
                        ${isEquipped ? '已裝備' : '裝備'}
                    </button>
                `;

                titleEl.querySelector('.title-equip-btn').addEventListener('click', (e) => {
                    const clickedTitleId = e.target.dataset.titleId;
                    if (player.equippedTitle === clickedTitleId) {
                        player.equippedTitle = null; 
                        soundManager.play('down');
                    } else {
                        player.equippedTitle = clickedTitleId;
                        soundManager.play('equipment');
                    }
                    savePlayerData();
                    updateAllUI(); 
                    renderTitleSystemUI();
                });
                container.appendChild(titleEl);
            });

            if (player.unlockedTitles.length === 0) {
                container.innerHTML = '<p class="empty-list-info">尚未獲得任何稱號，快去完成成就吧！</p>';
            }
        }

        
        // 功能解說: 按稀有度和名稱排序倉庫
        function sortInventoryByRarity() {
            player.inventory.sort((a, b) => {
                const rarityAIndex = comprehensiveRarityOrder.indexOf(a.rarity);
                const rarityBIndex = comprehensiveRarityOrder.indexOf(b.rarity);
                
                // 規則1：比較稀有度等級
                if (rarityAIndex !== rarityBIndex) {
                    return rarityBIndex - rarityAIndex; // 稀有度高的排前面
                }
                
                // 規則2：如果稀有度相同，則比較名稱 (使用 localeCompare 進行中文排序)
                return a.name.localeCompare(b.name, 'zh-Hant'); 
            });
            renderInventory(); 
            showModal("倉庫已按稀有度及名稱整理完畢！", null, true);
        }


        // 功能解說: 打開裝備選擇視窗，並列出所有在倉庫中可用的「裝備」。
        // 這個函式會被空的裝備欄點擊時觸發。
        function openEquipmentPlacementModal(slotId) {
            const availableEquipment = player.inventory.filter(i => i.type === '裝備');
            if (availableEquipment.length === 0) {
                soundManager.play('wrong'); 
                showModal("你的倉庫裡沒有任何可用的裝備！", null, true);
                return
            }

            const modal = document.getElementById('equipment-placement-modal');
            // 使用我們剛剛在HTML中新增的專屬ID
            const grid = document.getElementById('equipment-placement-grid'); 
            grid.innerHTML = ''; // 清空舊內容

            availableEquipment.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'museum-selection-item'; // 直接沿用博物館的樣式
                itemEl.innerHTML = `
                    ${createItemCard(item).outerHTML}
                    <p>${item.name}</p>
                `;
                itemEl.onclick = () => {
                    hideModal('equipment-placement-modal');
                    // 點擊後，呼叫遊戲中本來就有的 `confirmAndExecuteEquip` 函式
                    setTimeout(() => confirmAndExecuteEquip(item, slotId), 100);
                };
                grid.appendChild(itemEl);
            });

            modal.querySelector('.cancel').onclick = () => hideModal('equipment-placement-modal');
            modal.classList.add('active');
        }
        init();
    });
    </script>
</body>
</html>
